<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DE Education | Shape Your Future</title>
	<link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- React Router -->
    <script src="https://unpkg.com/history@5/umd/history.development.js"></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    
    <!-- Face API -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Noto+Sinhala:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        sinhala: ['Noto Sinhala', 'sans-serif'],
                    },
                    colors: {
                        emerald: {
                            50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399',
                            500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b', 950: '#022c22',
                        },
                        dark: {
                            bg: '#0B1120',
                            card: 'rgba(21, 31, 50, 0.7)', // Made slightly transparent for glassmorphism
                            border: 'rgba(255, 255, 255, 0.08)'
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'scan': 'scan 1.5s linear infinite',
                        'blob': 'blob 10s infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        scan: {
                            '0%': { top: '0%', opacity: '0' },
                            '50%': { opacity: '1' },
                            '100%': { top: '100%', opacity: '0' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0B1120;
            /* Removed static gradient, handled by BackgroundEffects component now */
        }
        
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(16, 185, 129, 0.5); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        
        /* Utility for animation delay */
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
        
        /* Glassmorphism utility */
        .glass {
            background: rgba(21, 31, 50, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="text-gray-200 antialiased min-h-screen selection:bg-emerald-500/30">
    <div id="root"></div>

    <script type="text/babel">
        // --- IMPORTS & SETUP ---
        const { useState, useEffect, useRef, useMemo } = React;
        const { HashRouter, Routes, Route, Navigate, useLocation } = ReactRouterDOM;
        const { createClient } = supabase;

        // --- CONSTANTS ---
        const SUPABASE_URL = 'https://hppojrbfhzttzvlvovre.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcG9qcmJmaHp0dHp2bHZvdnJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODgxNDYsImV4cCI6MjA3Njc2NDE0Nn0.aL2fegb_eRPY0E7P6Mwufhq3TCAeX8-hDCHBo9VeAsA';
       
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
        // PUT YOUR GEMINI API KEY HERE
        const GEMINI_API_KEY = ''; 

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ICON MAPPINGS ---
        const IconWrapper = ({ icon, size = 18, className = "" }) => {
            const sizeStyle = { fontSize: size + 'px' };
            return <i className={`${icon} ${className}`} style={sizeStyle}></i>;
        };

        const Icons = {
            LayoutDashboard: (p) => <IconWrapper icon="fas fa-th-large" {...p} />,
            FileText: (p) => <IconWrapper icon="fas fa-file-alt" {...p} />,
            Calendar: (p) => <IconWrapper icon="fas fa-calendar" {...p} />,
            Bell: (p) => <IconWrapper icon="fas fa-bell" {...p} />,
            Settings: (p) => <IconWrapper icon="fas fa-cog" {...p} />,
            LogOut: (p) => <IconWrapper icon="fas fa-sign-out-alt" {...p} />,
            Upload: (p) => <IconWrapper icon="fas fa-upload" {...p} />,
            Trash2: (p) => <IconWrapper icon="fas fa-trash" {...p} />,
            Camera: (p) => <IconWrapper icon="fas fa-camera" {...p} />,
            Shield: (p) => <IconWrapper icon="fas fa-shield-alt" {...p} />,
            Users: (p) => <IconWrapper icon="fas fa-users" {...p} />,
            BookOpen: (p) => <IconWrapper icon="fas fa-book-open" {...p} />,
            Award: (p) => <IconWrapper icon="fas fa-award" {...p} />,
            Search: (p) => <IconWrapper icon="fas fa-search" {...p} />,
            ExternalLink: (p) => <IconWrapper icon="fas fa-external-link-alt" {...p} />,
            Download: (p) => <IconWrapper icon="fas fa-download" {...p} />,
            ArrowLeft: (p) => <IconWrapper icon="fas fa-arrow-left" {...p} />,
            Menu: (p) => <IconWrapper icon="fas fa-bars" {...p} />,
            X: (p) => <IconWrapper icon="fas fa-times" {...p} />,
            Grid: (p) => <IconWrapper icon="fas fa-th" {...p} />,
            List: (p) => <IconWrapper icon="fas fa-list" {...p} />,
            Moon: (p) => <IconWrapper icon="fas fa-moon" {...p} />,
            Sun: (p) => <IconWrapper icon="fas fa-sun" {...p} />,
            ChevronLeft: (p) => <IconWrapper icon="fas fa-chevron-left" {...p} />,
            ChevronRight: (p) => <IconWrapper icon="fas fa-chevron-right" {...p} />,
            MapPin: (p) => <IconWrapper icon="fas fa-map-marker-alt" {...p} />,
            Sparkles: (p) => <IconWrapper icon="fas fa-magic" {...p} />,
            Send: (p) => <IconWrapper icon="fas fa-paper-plane" {...p} />,
            Bot: (p) => <IconWrapper icon="fas fa-robot" {...p} />,
            BrainCircuit: (p) => <IconWrapper icon="fas fa-brain" {...p} />,
            Globe: (p) => <IconWrapper icon="fas fa-globe" {...p} />,
        };

        // --- NEW: MODERN BACKGROUND COMPONENT ---
        const BackgroundEffects = () => {
            return (
                <div className="fixed inset-0 -z-10 overflow-hidden pointer-events-none bg-[#0B1120]">
                    {/* Animated Blobs */}
                    <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-purple-900/20 rounded-full blur-[120px] animate-blob mix-blend-screen"></div>
                    <div className="absolute top-[20%] right-[-10%] w-[40%] h-[60%] bg-emerald-900/20 rounded-full blur-[120px] animate-blob animation-delay-2000 mix-blend-screen"></div>
                    <div className="absolute bottom-[-20%] left-[20%] w-[50%] h-[50%] bg-blue-900/20 rounded-full blur-[120px] animate-blob animation-delay-4000 mix-blend-screen"></div>
                    
                    {/* Noise Texture Overlay */}
                    <div className="absolute inset-0 opacity-20 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')]"></div>
                    
                    {/* Grid Overlay (Subtle) */}
                    <div className="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:4rem_4rem] [mask-image:radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_100%)]"></div>
                </div>
            );
        };

        // --- DATA CONSTANTS ---
        const SRI_LANKAN_HOLIDAYS_2025 = {
            '2025-01-13': { name: 'Duruthu Full Moon Poya', type: 'poya' },
            '2025-01-14': { name: 'Tamil Thai Pongal', type: 'public' },
            '2025-02-04': { name: 'Independence Day', type: 'public' },
            '2025-02-12': { name: 'Navam Full Moon Poya', type: 'poya' },
            '2025-02-26': { name: 'Mahasivarathri Day', type: 'public' },
            '2025-03-13': { name: 'Madin Full Moon Poya', type: 'poya' },
            '2025-04-11': { name: 'Sinhala & Tamil New Year Eve', type: 'public' },
            '2025-04-12': { name: 'Sinhala & Tamil New Year', type: 'public' },
            '2025-04-13': { name: 'Bak Full Moon Poya', type: 'poya' },
            '2025-05-01': { name: 'May Day', type: 'public' },
            '2025-05-12': { name: 'Vesak Full Moon Poya', type: 'poya' },
            '2025-05-13': { name: 'Day following Vesak', type: 'public' },
            '2025-06-10': { name: 'Poson Full Moon Poya', type: 'poya' },
            '2025-07-10': { name: 'Esala Full Moon Poya', type: 'poya' },
            '2025-08-08': { name: 'Nikini Full Moon Poya', type: 'poya' },
            '2025-09-07': { name: 'Binara Full Moon Poya', type: 'poya' },
            '2025-10-06': { name: 'Vap Full Moon Poya', type: 'poya' },
            '2025-11-05': { name: 'Il Full Moon Poya', type: 'poya' },
            '2025-12-04': { name: 'Unduvap Full Moon Poya', type: 'poya' },
            '2025-12-25': { name: 'Christmas Day', type: 'public' },
        };

        // --- MAINTENANCE PAGE COMPONENT ---
        const MaintenancePage = () => {
            const [timeLeft, setTimeLeft] = useState({ days: 0, hours: 0, minutes: 0, seconds: 0 });
            const [endTime, setEndTime] = useState(null);

            useEffect(() => {
                const fetchSettings = async () => {
                    const { data } = await supabaseClient.from('system_settings').select('value').eq('key', 'maintenance').single();
                    if (data?.value?.endTime) {
                        setEndTime(new Date(data.value.endTime).getTime());
                    } else {
                        setEndTime(new Date().getTime() + 86400000); // Default 24h
                    }
                };
                fetchSettings();
            }, []);

            useEffect(() => {
                if (!endTime) return;

                const timer = setInterval(() => {
                    const now = new Date().getTime();
                    const distance = endTime - now;

                    if (distance < 0) {
                        clearInterval(timer);
                        window.location.hash = '/'; 
                    } else {
                        setTimeLeft({
                            days: Math.floor(distance / (1000 * 60 * 60 * 24)),
                            hours: Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)),
                            minutes: Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)),
                            seconds: Math.floor((distance % (1000 * 60)) / 1000)
                        });
                    }
                }, 1000);

                return () => clearInterval(timer);
            }, [endTime]);

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">
                    <BackgroundEffects />
                    <div className="relative z-10 glass p-8 md:p-12 rounded-3xl max-w-lg w-full text-center shadow-2xl animate__animated animate__zoomIn">
                        <div className="animate-float mb-8">
                            <div className="inline-flex items-center justify-center w-24 h-24 rounded-full bg-emerald-500/10 ring-1 ring-emerald-500/30 shadow-[0_0_30px_rgba(16,185,129,0.2)]">
                                <i className="fas fa-tools text-5xl text-emerald-500"></i>
                            </div>
                        </div>
                        <h1 className="text-4xl font-bold text-white mb-4 animate__animated animate__fadeInUp animate__delay-0.5s">System Maintenance</h1>
                        <p className="text-gray-400 mb-8 animate__animated animate__fadeInUp animate__delay-0.5s">We're upgrading our servers to serve you better. We'll be back shortly!</p>
                        <div className="flex justify-center gap-4 md:gap-6 mb-8 animate__animated animate__fadeIn animate__delay-1s">
                            {Object.entries(timeLeft).map(([unit, value]) => (
                                <div key={unit} className="flex flex-col items-center p-3 rounded-xl bg-white/5 border border-white/5 min-w-[70px]">
                                    <span className="text-3xl font-bold text-emerald-400 font-mono">{String(value).padStart(2, '0')}</span>
                                    <span className="text-[10px] uppercase tracking-wider text-gray-500 mt-1">{unit}</span>
                                </div>
                            ))}
                        </div>
                        <div className="pt-8 border-t border-white/5 text-sm text-gray-500 animate__animated animate__fadeIn animate__delay-1.5s">
                            <p className="mb-2">Questions? Contact <a href="mailto:isaradilnuka@gmail.com" className="text-emerald-500 hover:underline">Support</a></p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ADMIN COMPONENTS ---

        const DashboardStats = () => {
            const [counts, setCounts] = useState({ papers: 0, notices: 0, pDownloads: 0, mDownloads: 0 });
            const [stats, setStats] = useState([]);

            useEffect(() => {
                const fetchStats = async () => {
                    const { count: pCount } = await supabaseClient.from('past_papers').select('*', { count: 'exact', head: true });
                    const { count: nCount } = await supabaseClient.from('notices').select('*', { count: 'exact', head: true });
                    const { data: dlStats } = await supabaseClient.from('subject_download_stats').select('*');
                    
                    const pDl = dlStats?.reduce((acc, curr) => acc + (curr.paper_downloads || 0), 0) || 0;
                    const mDl = dlStats?.reduce((acc, curr) => acc + (curr.marking_downloads || 0), 0) || 0;

                    setCounts({ papers: pCount || 0, notices: nCount || 0, pDownloads: pDl, mDownloads: mDl });
                    setStats(dlStats || []);
                };
                fetchStats();
                
                const channel = supabaseClient.channel('stats')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'subject_download_stats' }, () => fetchStats())
                    .subscribe();
                    
                return () => { supabaseClient.removeChannel(channel); };
            }, []);

            return (
                <div className="space-y-8 animate__animated animate__fadeIn">
                    <h2 className="text-2xl font-bold text-white">Dashboard Overview</h2>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        {[
                            { label: 'Papers Uploaded', val: counts.papers, color: 'emerald', icon: Icons.FileText },
                            { label: 'Notices Posted', val: counts.notices, color: 'yellow', icon: Icons.Bell },
                            { label: 'Paper Downloads', val: counts.pDownloads, color: 'blue', icon: Icons.Upload },
                            { label: 'Marking Downloads', val: counts.mDownloads, color: 'purple', icon: Icons.Shield }
                        ].map((item, i) => (
                            <div key={i} className={`glass p-6 border-l-4 border-l-${item.color}-500 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 hover:scale-[1.02] hover:bg-white/10`}>
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-gray-400 text-xs font-bold uppercase tracking-wider">{item.label}</span>
                                    <item.icon className={`text-${item.color}-500 opacity-80`} size={20} />
                                </div>
                                <span className="text-4xl font-bold text-white">{item.val.toLocaleString()}</span>
                            </div>
                        ))}
                    </div>

                    <div className="glass rounded-xl p-6 animate__animated animate__fadeInUp">
                        <h3 className="text-lg font-bold text-white mb-4">Subject Popularity</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm text-gray-400">
                                <thead className="bg-white/5 text-gray-200 uppercase text-xs">
                                    <tr>
                                        <th className="p-3">Subject</th>
                                        <th className="p-3 text-right">Paper DLs</th>
                                        <th className="p-3 text-right">Marking DLs</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-white/5">
                                    {stats.sort((a,b) => (b.paper_downloads + b.marking_downloads) - (a.paper_downloads + a.marking_downloads)).map(stat => (
                                        <tr key={stat.id} className="hover:bg-white/5 transition-colors duration-200">
                                            <td className="p-3 font-medium text-white">{stat.subject_name}</td>
                                            <td className="p-3 text-right text-blue-400 font-mono">{stat.paper_downloads}</td>
                                            <td className="p-3 text-right text-emerald-400 font-mono">{stat.marking_downloads}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const PapersManager = () => {
            const [papers, setPapers] = useState([]);
            const [form, setForm] = useState({ year: '', subject_name: '', subject_code: '', paper_link: '', marking_link: '' });
            const [streams, setStreams] = useState([]);
            
            useEffect(() => { loadPapers(); }, []);

            const loadPapers = async () => {
                const { data } = await supabaseClient.from('past_papers').select('*').order('created_at', {ascending: false});
                if(data) setPapers(data);
            };

            const handleDelete = async (id) => {
                if(confirm('Delete paper?')) {
                    await supabaseClient.from('past_papers').delete().eq('id', id);
                    loadPapers();
                }
            };

            const handleStreamChange = (e) => {
                const val = e.target.value;
                setStreams(prev => prev.includes(val) ? prev.filter(s => s !== val) : [...prev, val]);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if(streams.length === 0) return alert("Select at least one stream");
                
                const inserts = streams.map(stream => ({
                    year: parseInt(form.year),
                    subject_name: form.subject_name,
                    subject_code: form.subject_code,
                    stream: stream,
                    paper_link: form.paper_link,
                    marking_scheme_link: form.marking_link
                }));

                const { error } = await supabaseClient.from('past_papers').insert(inserts);
                if(error) alert(error.message);
                else {
                    loadPapers();
                    setForm({ year: '', subject_name: '', subject_code: '', paper_link: '', marking_link: '' });
                    setStreams([]);
                }
            };

            return (
                <div className="space-y-6 animate__animated animate__fadeIn">
                     <div className="glass p-6 rounded-xl animate__animated animate__fadeInDown">
                        <h3 className="text-lg font-bold text-white mb-4">Upload New Paper</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input placeholder="Subject Name" value={form.subject_name} onChange={e => setForm({...form, subject_name: e.target.value})} className="p-3 bg-dark-bg/50 border border-white/10 rounded-lg text-white focus:border-emerald-500 transition-colors outline-none" required />
                                <input placeholder="Subject Code" value={form.subject_code} onChange={e => setForm({...form, subject_code: e.target.value})} className="p-3 bg-dark-bg/50 border border-white/10 rounded-lg text-white focus:border-emerald-500 transition-colors outline-none" />
                                <input type="number" placeholder="Year" value={form.year} onChange={e => setForm({...form, year: e.target.value})} className="p-3 bg-dark-bg/50 border border-white/10 rounded-lg text-white focus:border-emerald-500 transition-colors outline-none" required />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <input placeholder="Paper PDF URL" value={form.paper_link} onChange={e => setForm({...form, paper_link: e.target.value})} className="p-3 bg-dark-bg/50 border border-white/10 rounded-lg text-white focus:border-emerald-500 transition-colors outline-none" />
                                 <input placeholder="Marking Scheme URL" value={form.marking_link} onChange={e => setForm({...form, marking_link: e.target.value})} className="p-3 bg-dark-bg/50 border border-white/10 rounded-lg text-white focus:border-emerald-500 transition-colors outline-none" />
                            </div>
                            <div className="flex gap-4 items-center">
                                <span className="text-sm text-gray-400">Streams:</span>
                                {['science', 'commerce', 'arts', 'technology'].map(s => (
                                    <label key={s} className="flex items-center gap-2 text-sm text-gray-300 capitalize cursor-pointer hover:text-white transition-colors">
                                        <input type="checkbox" value={s} checked={streams.includes(s)} onChange={handleStreamChange} className="accent-emerald-500 w-4 h-4" /> {s}
                                    </label>
                                ))}
                            </div>
                            <button type="submit" className="px-6 py-2 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-500 transition-all hover:scale-105 shadow-lg shadow-emerald-900/20">Upload Resource</button>
                        </form>
                     </div>

                     <div className="grid grid-cols-1 gap-4">
                         {papers.map((p, idx) => (
                             <div key={p.id} style={{ animationDelay: `${idx * 50}ms` }} className="flex justify-between items-center p-4 glass rounded-lg animate__animated animate__fadeInUp">
                                 <div>
                                     <h4 className="text-white font-bold">{p.subject_name} <span className="text-xs text-gray-500">({p.subject_code})</span></h4>
                                     <p className="text-sm text-gray-400">{p.year} â€¢ <span className="uppercase text-emerald-500">{p.stream}</span></p>
                                 </div>
                                 <button onClick={() => handleDelete(p.id)} className="text-red-500 hover:text-red-400 p-2 transition-all hover:scale-110 hover:bg-white/5 rounded-full"><Icons.Trash2 size={18} /></button>
                             </div>
                         ))}
                     </div>
                </div>
            );
        };

        const MaintenanceControl = () => {
            const [status, setStatus] = useState(false);
            useEffect(() => {
                supabaseClient.from('system_settings').select('value').eq('key', 'maintenance').single()
                    .then(({ data }) => setStatus(data?.value?.isActive || false));
            }, []);

            const toggle = async () => {
                const newState = !status;
                await supabaseClient.from('system_settings').upsert({ key: 'maintenance', value: { isActive: newState, endTime: new Date(Date.now() + 86400000).toISOString() } });
                setStatus(newState);
            };

            return (
                <div className={`p-6 rounded-xl border border-l-4 glass flex justify-between items-center animate__animated animate__fadeIn ${status ? 'border-red-500 bg-red-900/10' : 'border-emerald-500 bg-emerald-900/10'}`}>
                    <div>
                        <h3 className="font-bold text-white text-lg">Maintenance Mode</h3>
                        <p className="text-sm text-gray-400">{status ? 'Active: Users redirected to maintenance page' : 'Inactive: Site is live'}</p>
                    </div>
                    <button onClick={toggle} className={`px-6 py-2 rounded-lg font-bold text-white transition-all hover:scale-105 shadow-lg ${status ? 'bg-red-500 hover:bg-red-400' : 'bg-emerald-500 hover:bg-emerald-400'}`}>
                        {status ? 'Turn Off' : 'Turn On'}
                    </button>
                </div>
            );
        };

        const UserApprovals = () => {
            const [users, setUsers] = useState([]);
            useEffect(() => {
                supabaseClient.from('users').select('*').eq('approved', false).then(({ data }) => setUsers(data || []));
            }, []);

            const approve = async (id) => {
                await supabaseClient.from('users').update({ approved: true }).eq('id', id);
                setUsers(prev => prev.filter(u => u.id !== id));
            };

            return (
                <div className="animate__animated animate__fadeIn">
                    <h2 className="text-2xl font-bold text-white mb-6">Pending Approvals</h2>
                    <div className="grid gap-4">
                        {users.map(u => (
                            <div key={u.id} className="flex justify-between items-center p-4 glass rounded-lg animate__animated animate__fadeInUp">
                                <div>
                                    <p className="font-bold text-white">{u.name}</p>
                                    <p className="text-sm text-gray-500">{u.email}</p>
                                </div>
                                <button onClick={() => approve(u.id)} className="px-4 py-2 bg-emerald-600 text-white text-xs font-bold rounded-lg hover:bg-emerald-500 transition-colors">Approve</button>
                            </div>
                        ))}
                        {users.length === 0 && <p className="text-gray-500">No pending requests.</p>}
                    </div>
                </div>
            );
        };

        const AdminPage = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [isLoading, setIsLoading] = useState(true);
            const [email, setEmail] = useState('');
            const [loginStatus, setLoginStatus] = useState('');
            const [showCamera, setShowCamera] = useState(false);
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);

            useEffect(() => {
                Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]).then(() => setIsLoading(false)).catch(e => console.error(e));

                return () => stopCamera();
            }, []);

            const startCamera = async (matcher, userData) => {
                setShowCamera(true);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                    streamRef.current = stream;
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        videoRef.current.onloadedmetadata = () => {
                            const video = videoRef.current;
                            const canvas = canvasRef.current;
                            const displaySize = { width: video.videoWidth, height: video.videoHeight };
                            faceapi.matchDimensions(canvas, displaySize);
                            
                            const interval = setInterval(async () => {
                                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                                if (detection) {
                                    const match = matcher.findBestMatch(detection.descriptor);
                                    if (match.label === userData.email) {
                                        clearInterval(interval);
                                        setUser(userData);
                                        stopCamera();
                                    }
                                }
                            }, 500);
                        };
                    }
                } catch (e) {
                    alert("Camera access denied");
                    setShowCamera(false);
                }
            };

            const stopCamera = () => {
                if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());
                setShowCamera(false);
            };

            const handleLogin = async () => {
                if (!email) return alert("Enter email");
                setLoginStatus("Checking user...");
                
                const { data: userData } = await supabaseClient.from('users').select('*').eq('email', email).single();
                
                if (!userData) {
                    setLoginStatus("User not found.");
                    return;
                }

                if (!userData.approved && userData.email !== SUPER_ADMIN_EMAIL) {
                    setLoginStatus("Account pending approval.");
                    return;
                }

                if (userData.face_descriptors && userData.face_descriptors.length > 0) {
                    const descriptors = userData.face_descriptors.map(d => new Float32Array(d));
                    const matcher = new faceapi.FaceMatcher(new faceapi.LabeledFaceDescriptors(userData.email, descriptors), 0.5);
                    startCamera(matcher, userData);
                } else {
                    if(userData.email === SUPER_ADMIN_EMAIL) {
                        const secret = prompt("Enter Secret:");
                        if(secret === ADMIN_SECRET) setUser(userData);
                    }
                }
            };

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <BackgroundEffects />
                        <div className="glass p-8 rounded-3xl w-full max-w-md text-center shadow-2xl animate__animated animate__fadeIn">
                            <div className="w-20 h-20 bg-emerald-500/10 rounded-2xl mx-auto flex items-center justify-center mb-6 animate-float shadow-lg shadow-emerald-500/10">
                                <Icons.Shield className="text-emerald-500" size={40} />
                            </div>
                            <h1 className="text-3xl font-bold text-white mb-2">Admin Portal</h1>
                            <p className="text-gray-400 mb-8 text-sm">Biometric Security Active</p>
                            
                            <div className="space-y-4">
                                <input 
                                    type="email" 
                                    placeholder="Admin Email" 
                                    value={email}
                                    onChange={e => setEmail(e.target.value)}
                                    className="w-full p-4 bg-dark-bg/50 border border-white/10 rounded-xl text-white outline-none focus:border-emerald-500 transition-all placeholder-gray-500"
                                />
                                <button 
                                    onClick={handleLogin}
                                    disabled={isLoading}
                                    className="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl transition-all flex items-center justify-center gap-2 hover:scale-[1.02] shadow-lg shadow-emerald-900/30"
                                >
                                    <Icons.Camera size={18} /> Authenticate
                                </button>
                                <p className="text-xs text-red-400 font-mono h-4">{loginStatus}</p>
                            </div>

                            {showCamera && (
                                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center flex-col animate__animated animate__fadeIn">
                                    <div className="relative border-2 border-emerald-500 rounded-lg overflow-hidden shadow-[0_0_50px_rgba(16,185,129,0.5)]">
                                        <video ref={videoRef} autoPlay muted width="320" height="240" />
                                        <canvas ref={canvasRef} className="absolute inset-0" />
                                    </div>
                                    <p className="text-white mt-4 animate-pulse font-mono tracking-widest text-emerald-500">SCANNING BIOMETRICS...</p>
                                    <button onClick={stopCamera} className="mt-4 px-6 py-2 bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors border border-white/10">Cancel</button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex min-h-screen">
                    <BackgroundEffects />
                    <aside className="w-64 glass border-r border-white/5 flex flex-col hidden md:flex animate__animated animate__slideInLeft">
                        <div className="p-6 border-b border-white/5 flex items-center gap-3">
                            <div className="w-8 h-8 bg-emerald-500 rounded flex items-center justify-center text-white font-bold animate__animated animate__pulse animate__infinite animate__slower shadow-lg shadow-emerald-500/20">DE</div>
                            <span className="font-bold text-white tracking-wide">Admin Pro</span>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: Icons.LayoutDashboard },
                                { id: 'papers', label: 'Past Papers', icon: Icons.FileText },
                                { id: 'settings', label: 'Settings', icon: Icons.Settings },
                            ].map(item => (
                                <button 
                                    key={item.id}
                                    onClick={() => setView(item.id)}
                                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300 ${view === item.id ? 'bg-emerald-500/10 text-emerald-400 shadow-inner' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}
                                >
                                    <item.icon size={18} /> {item.label}
                                </button>
                            ))}
                            {user.email === SUPER_ADMIN_EMAIL && (
                                <button onClick={() => setView('users')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300 ${view === 'users' ? 'bg-emerald-500/10 text-emerald-400 shadow-inner' : 'text-gray-400 hover:bg-white/5'}`}>
                                    <Icons.Users size={18} /> Users
                                </button>
                            )}
                        </nav>
                        <div className="p-4 border-t border-white/5 bg-black/10">
                            <div className="flex items-center gap-3 mb-3">
                                <img src={`https://ui-avatars.com/api/?name=${user.name}&background=10b981&color=fff`} className="w-8 h-8 rounded-full ring-2 ring-emerald-500/30" alt="" />
                                <div className="flex-1 overflow-hidden">
                                    <p className="text-sm font-bold text-white truncate">{user.name}</p>
                                    <p className="text-xs text-gray-500 truncate">{user.email}</p>
                                </div>
                            </div>
                            <button onClick={() => window.location.reload()} className="w-full py-2 bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2">
                                <Icons.LogOut size={14} /> Sign Out
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 p-8 overflow-y-auto">
                        {view === 'dashboard' && <DashboardStats />}
                        {view === 'papers' && <PapersManager />}
                        {view === 'settings' && (
                            <div className="space-y-6 animate__animated animate__fadeIn">
                                <h2 className="text-2xl font-bold text-white">System Settings</h2>
                                <MaintenanceControl />
                            </div>
                        )}
                         {view === 'users' && <UserApprovals />}
                    </main>
                </div>
            );
        };

        // --- MAIN PAGE COMPONENTS ---
        const CalendarWidget = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);

            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);
            const monthName = currentDate.toLocaleString('default', { month: 'long' });

            const changeMonth = (offset) => {
                setCurrentDate(new Date(year, month + offset, 1));
                setSelectedDate(null);
            };

            const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const blanks = Array.from({ length: firstDay }, (_, i) => i);

            return (
                <div className="glass rounded-3xl p-6 shadow-2xl max-w-md mx-auto mt-8 animate__animated animate__fadeInUp">
                    <div className="flex justify-between items-center mb-6">
                        <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition-colors"><Icons.ChevronLeft size={20} /></button>
                        <h3 className="text-xl font-bold text-white flex items-center gap-2">
                            <Icons.Calendar size={20} className="text-emerald-500" />
                            {monthName} {year}
                        </h3>
                        <button onClick={() => changeMonth(1)} className="p-2 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition-colors"><Icons.ChevronRight size={20} /></button>
                    </div>

                    <div className="grid grid-cols-7 gap-2 mb-2 text-center">
                        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                            <span key={d} className="text-xs font-bold text-gray-500 uppercase tracking-wider">{d}</span>
                        ))}
                    </div>

                    <div className="grid grid-cols-7 gap-2">
                        {blanks.map((_, i) => <div key={`blank-${i}`} className="aspect-square" />)}
                        {days.map(day => {
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const holiday = SRI_LANKAN_HOLIDAYS_2025[dateStr];
                            const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();

                            return (
                                <div 
                                    key={day} 
                                    onClick={() => setSelectedDate(holiday ? dateStr : null)}
                                    className={`
                                        aspect-square rounded-xl flex flex-col items-center justify-center relative cursor-pointer transition-all duration-300 hover:scale-110
                                        ${isToday ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/30' : 'bg-white/5 hover:bg-white/10 text-gray-300'}
                                        ${holiday?.type === 'poya' ? 'border border-yellow-500/50' : ''}
                                        ${holiday?.type === 'public' ? 'border border-red-500/50' : ''}
                                    `}
                                >
                                    <span className="text-sm font-bold">{day}</span>
                                    {holiday && (
                                        <div className="absolute bottom-1">
                                            {holiday.type === 'poya' ? (
                                                <Icons.Moon size={8} className="text-yellow-400 fill-yellow-400" />
                                            ) : (
                                                <div className={`w-1.5 h-1.5 rounded-full ${holiday.type === 'public' ? 'bg-red-500' : 'bg-blue-400'}`} />
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    <div className="mt-6 pt-4 border-t border-white/5 min-h-[3rem] text-center">
                        {selectedDate && SRI_LANKAN_HOLIDAYS_2025[selectedDate] ? (
                            <div className="animate__animated animate__fadeIn">
                                <p className={`text-sm font-bold ${
                                    SRI_LANKAN_HOLIDAYS_2025[selectedDate].type === 'poya' ? 'text-yellow-400' : 'text-red-400'
                                }`}>
                                    {SRI_LANKAN_HOLIDAYS_2025[selectedDate].name}
                                </p>
                                <p className="text-xs text-gray-500 capitalize">{SRI_LANKAN_HOLIDAYS_2025[selectedDate].type} Holiday</p>
                            </div>
                        ) : (
                            <div className="flex justify-center gap-4 text-xs text-gray-500">
                                <span className="flex items-center gap-1"><Icons.Moon size={10} className="text-yellow-500" /> Poya</span>
                                <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-red-500" /> Public</span>
                                <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-blue-400" /> Mercantile</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const MainPage = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            
            const [notices, setNotices] = useState([]);
            const [examDates, setExamDates] = useState([]);
            const [subjects, setSubjects] = useState([]);
            const [papers, setPapers] = useState([]);
            const [loading, setLoading] = useState(false);
            
            const [selectedStream, setSelectedStream] = useState(null);
            const [selectedSubject, setSelectedSubject] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [yearFilter, setYearFilter] = useState('all');
            const [viewMode, setViewMode] = useState('grid');
            const [isScrolled, setIsScrolled] = useState(false);
            
            const [sysUpdateMsg, setSysUpdateMsg] = useState(null);
            const [timetablePdf, setTimetablePdf] = useState(null);
            const [activeModal, setActiveModal] = useState(null);

            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [isChatLoading, setIsChatLoading] = useState(false);
            const [isThinking, setIsThinking] = useState(false);
            const [aiContext, setAiContext] = useState('');
            const chatEndRef = useRef(null);

            useEffect(() => {
                loadInitialData();
                loadAIContext();
                const handleScroll = () => setIsScrolled(window.scrollY > 50);
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [chatMessages, isChatLoading, isThinking]);

            const loadInitialData = async () => {
                const { data: updateData } = await supabaseClient.from('system_settings').select('value').eq('key', 'system_update').single();
                if(updateData?.value?.active) setSysUpdateMsg(updateData.value);

                const { data: ttData } = await supabaseClient.from('system_settings').select('value').eq('key', 'timetable_pdf').single();
                if(ttData?.value?.link) setTimetablePdf(ttData.value);

                const { data: noticeData } = await supabaseClient.from('notices').select('*').order('created_at', {ascending: false});
                if(noticeData) setNotices(noticeData);

                const { data: dateData } = await supabaseClient.from('exam_dates').select('*').order('date', {ascending: true});
                if(dateData) setExamDates(dateData);
            };

            const loadAIContext = async () => {
                const { data: papers } = await supabaseClient.from('past_papers').select('year, subject_name, stream, type, subject_code');
                const paperText = papers && papers.length > 0 ? papers.map(p => `- ${p.year} ${p.stream} ${p.subject_name} (${p.type || 'Paper'})`).join('\n') : 'No papers listed currently.';

                const { data: notices } = await supabaseClient.from('notices').select('title, body, type, created_at').order('created_at', {ascending: false}).limit(5);
                const noticeText = notices && notices.length > 0 ? notices.map(n => `- [${new Date(n.created_at).toLocaleDateString()}] ${n.title}: ${n.body}`).join('\n') : 'No recent notices.';

                const { data: dates } = await supabaseClient.from('exam_dates').select('date, details, type').order('date', {ascending: true});
                const dateText = dates && dates.length > 0 ? dates.map(d => `- ${d.date}: ${d.details} (${d.type})`).join('\n') : 'No upcoming official events logged.';

                const fullContext = `
                === AVAILABLE RESOURCES DATABASE ===
                [PAST PAPERS LIBRARY]
                ${paperText}
                [RECENT ANNOUNCEMENTS]
                ${noticeText}
                [ACADEMIC CALENDAR]
                ${dateText}
                ====================================
                `;
                setAiContext(fullContext);
            };

            const loadSubjects = async (stream) => {
                setLoading(true);
                setSelectedStream(stream);
                const { data } = await supabaseClient.from('subjects').select('*').eq('stream', stream);
                if(data) setSubjects(data);
                setLoading(false);
            };

            const loadPapers = async (subject) => {
                setLoading(true);
                setSelectedSubject(subject);
                const { data } = await supabaseClient.from('past_papers').select('*')
                    .eq('stream', subject.stream)
                    .eq('subject_code', subject.code)
                    .order('year', {ascending: false});
                if(data) setPapers(data);
                setLoading(false);
            };

            const handleDownload = async (paperId, type, subjectName) => {
                const countColumn = type === 'paper' ? 'paper_downloads' : 'marking_downloads';
                const { data: existing } = await supabaseClient.from('subject_download_stats').select('*').eq('subject_name', subjectName).maybeSingle();
                    
                if (existing) {
                     await supabaseClient.from('subject_download_stats').update({ [countColumn]: (existing[countColumn] || 0) + 1 }).eq('subject_name', subjectName);
                } else {
                     await supabaseClient.from('subject_download_stats').insert({ subject_name: subjectName, [countColumn]: 1, [type === 'paper' ? 'marking_downloads' : 'paper_downloads']: 0 });
                }
            };

            const resetSelection = () => {
                setSelectedSubject(null);
                setPapers([]);
                setSearchQuery('');
            };

            const resetStream = () => {
                setSelectedStream(null);
                setSubjects([]);
                resetSelection();
            };

            const handleChatSubmit = async (e) => {
                e?.preventDefault();
                if (!chatInput.trim() || isChatLoading) return;
                if (!GEMINI_API_KEY) {
                    alert("Please add a valid GEMINI_API_KEY in the code to use the AI Tutor.");
                    return;
                }

                const userMsg = chatInput;
                setChatInput('');
                setChatMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setIsChatLoading(true);
                setIsThinking(true);

                try {
                    const systemInstruction = `You are a helpful, intelligent, and motivating educational AI tutor for Sri Lankan A/L students.
                    Your capabilities:
                    1. **Deep Reasoning:** Solve complex problems in Physics, Chemistry, Math, and Logic.
                    2. **Resource Finder:** Find past papers, notices, and exam dates from our database.
                    3. **Study Coach:** Provide study tips.
                    
                    Here is the real-time database of DE Education resources you have access to:
                    ${aiContext}
                    
                    Rules:
                    - Check the database before answering about availability.
                    - Be concise but helpful.
                    `;

                    // Direct API Call instead of SDK for pure HTML compatibility
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [
                                ...chatMessages.map(m => ({ role: m.role, parts: [{ text: m.text }] })),
                                { role: 'user', parts: [{ text: userMsg }] }
                            ],
                            systemInstruction: { parts: [{ text: systemInstruction }] },
                            tools: [{ google_search: {} }] 
                        })
                    });

                    const result = await response.json();
                    setIsThinking(false);

                    if (result.candidates && result.candidates[0].content) {
                        const aiText = result.candidates[0].content.parts[0].text;
                        const groundingChunks = result.candidates[0].groundingMetadata?.groundingChunks || [];
                        const urls = groundingChunks.map(c => c.web?.uri).filter(Boolean);

                        setChatMessages(prev => [...prev, { 
                            role: 'model', 
                            text: aiText,
                            groundingUrls: [...new Set(urls)]
                        }]);
                    } else {
                        throw new Error("No response content");
                    }

                } catch (error) {
                    console.error(error);
                    setChatMessages(prev => [...prev, { role: 'model', text: "I'm having trouble connecting right now. Please try again later." }]);
                } finally {
                    setIsChatLoading(false);
                    setIsThinking(false);
                }
            };

            const filteredPapers = papers.filter(p => {
                const matchesSearch = p.year.toString().includes(searchQuery) || (p.type && p.type.toLowerCase().includes(searchQuery.toLowerCase()));
                const matchesYear = yearFilter === 'all' || p.year.toString() === yearFilter;
                return matchesSearch && matchesYear;
            });

            const years = [...new Set(papers.map(p => p.year))].sort((a, b) => b - a);

            return (
                <div className="flex flex-col min-h-screen font-sans text-gray-200">
                    <BackgroundEffects />
                    
                    {/* NAVIGATION */}
                    <header className={`fixed w-full top-0 z-50 transition-all duration-500 ${isScrolled ? 'bg-[#0B1120]/80 backdrop-blur-xl border-b border-white/5 py-2 shadow-lg' : 'bg-transparent py-4'}`}>
                        <div className="container mx-auto px-4">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-3 group cursor-pointer" onClick={() => setActiveTab('home')}>
                                    <div className="w-10 h-10 bg-gradient-to-br from-emerald-500 to-cyan-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-emerald-500/30 transition-transform duration-300 group-hover:rotate-6 group-hover:scale-105">DE</div>
                                    <div>
                                        <h1 className="text-lg font-bold text-white leading-none tracking-tight">DE Education</h1>
                                        <p className="text-[10px] font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400 uppercase tracking-widest">Platform</p>
                                    </div>
                                </div>

                                <nav className="hidden md:flex items-center p-1.5 rounded-full bg-white/5 border border-white/5 backdrop-blur-md shadow-2xl">
                                    {['home', 'papers', 'results', 'timetables', 'ai-tutor', 'notices'].map((tab) => (
                                        <button
                                            key={tab}
                                            onClick={() => { setActiveTab(tab); window.scrollTo(0,0); }}
                                            className={`px-6 py-2 rounded-full text-sm font-bold transition-all duration-300 relative overflow-hidden ${activeTab === tab ? 'text-emerald-950 bg-emerald-400 shadow-[0_0_20px_rgba(52,211,153,0.4)]' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}
                                        >
                                            {tab === 'ai-tutor' ? <span className="flex items-center gap-2"><Icons.Sparkles size={14} /> AI Tutor</span> : tab.charAt(0).toUpperCase() + tab.slice(1)}
                                        </button>
                                    ))}
                                </nav>

                                <div className="flex items-center gap-3">
                                    <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="md:hidden p-2.5 bg-white/5 border border-white/10 rounded-xl text-gray-300 hover:bg-white/10 transition-colors">
                                        {isMobileMenuOpen ? <Icons.X size={20} /> : <Icons.Menu size={20} />}
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        {isMobileMenuOpen && (
                            <div className="md:hidden bg-[#0B1120]/95 backdrop-blur-xl border-b border-white/5 absolute w-full animate__animated animate__fadeInDown z-50">
                                {['home', 'papers', 'results', 'timetables', 'ai-tutor', 'notices'].map((tab) => (
                                    <button
                                        key={tab}
                                        onClick={() => { setActiveTab(tab); setIsMobileMenuOpen(false); }}
                                        className={`block w-full text-left px-8 py-5 text-sm font-bold border-l-4 transition-all ${activeTab === tab ? 'border-emerald-500 bg-emerald-500/10 text-white' : 'border-transparent text-gray-400 hover:bg-white/5'}`}
                                    >
                                        {tab.toUpperCase().replace('-', ' ')}
                                    </button>
                                ))}
                            </div>
                        )}
                    </header>

                    <main className="flex-grow pt-32 pb-20 container mx-auto px-4 z-10 relative">
                        {/* HOME TAB */}
                        {activeTab === 'home' && (
                            <div className="py-6 animate__animated animate__fadeIn">
                                <div className="w-full bg-gradient-to-r from-emerald-900/80 to-slate-900/80 backdrop-blur-xl border border-white/10 rounded-3xl p-8 md:p-12 mb-10 text-left relative overflow-hidden shadow-2xl animate__animated animate__fadeInDown">
                                    <div className="relative z-10">
                                        <h2 className="text-4xl md:text-5xl font-bold text-white mb-4">Welcome Back!</h2>
                                        <p className="text-gray-200 text-base md:text-lg max-w-2xl mb-8 leading-relaxed opacity-90">
                                            Access past papers, view your results, and manage your education journey efficiently with our next-gen platform.
                                        </p>
                                        <button onClick={() => setActiveTab('papers')} className="bg-white text-emerald-900 font-bold py-3.5 px-8 rounded-xl hover:bg-emerald-50 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1 hover:scale-105 active:scale-95">Start Studying</button>
                                    </div>
                                    <div className="absolute top-0 right-0 w-96 h-96 bg-emerald-500/20 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none animate-pulse-slow"></div>
                                    <div className="absolute bottom-0 left-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -ml-20 -mb-20 pointer-events-none"></div>
                                </div>

                                
                                <div className="text-center mb-8">
                                     <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white/5 border border-white/10 text-emerald-400 text-xs font-bold uppercase tracking-widest mb-2 backdrop-blur-md">
                                        <span className="relative flex h-2 w-2">
                                          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                          <span className="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                        </span>
                                        Shape Your Future Today
                                    </div>
                                </div>
                                
                                {sysUpdateMsg && (
                                    <div className="max-w-2xl mx-auto mb-10 bg-gradient-to-r from-yellow-500/10 to-orange-500/10 border border-yellow-500/20 rounded-2xl p-1 flex items-center gap-4 animate__animated animate__fadeInUp backdrop-blur-md">
                                        <div className="w-full h-full rounded-xl p-4 flex items-center gap-4">
                                            <div className="bg-yellow-500/20 p-2 rounded-lg text-yellow-500 animate-bounce"><Icons.Bell size={18}/></div>
                                            <div className="text-left">
                                                <h4 className="font-bold text-yellow-500 text-xs uppercase tracking-wider">System Update</h4>
                                                <p className="text-sm text-gray-300">{sysUpdateMsg.message}</p>
                                            </div>
                                        </div>
                                    </div>
                                )}


                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 animate__animated animate__fadeInUp animate__delay-1s">
                                    {[
                                        { id: 'papers', icon: Icons.BookOpen, color: 'blue', label: 'Past Papers', desc: 'Smart Library' },
                                        { id: 'results', icon: Icons.Award, color: 'emerald', label: 'Exam Results', desc: 'Instant Check' },
                                        { id: 'timetables', icon: Icons.Calendar, color: 'purple', label: 'Schedules', desc: 'Exam Calendar' },
                                        { id: 'ai-tutor', icon: Icons.Sparkles, color: 'pink', label: 'AI Tutor', desc: 'Study Assistant' }
                                    ].map((item, index) => (
                                        <div 
                                            key={item.id}
                                            onClick={() => setActiveTab(item.id)}
                                            style={{ animationDelay: `${index * 100}ms` }}
                                            className={`glass p-8 rounded-3xl cursor-pointer hover:-translate-y-2 hover:border-${item.color}-500/50 hover:bg-white/10 transition-all duration-300 group relative overflow-hidden`}
                                        >
                                            <div className={`absolute top-0 right-0 p-4 opacity-0 group-hover:opacity-10 transition-all duration-500 transform translate-x-4 group-hover:translate-x-0`}>
                                                 <item.icon size={64} />
                                            </div>
                                            <div className={`w-14 h-14 rounded-2xl bg-${item.color}-500/20 flex items-center justify-center text-${item.color}-400 mb-6 group-hover:scale-110 group-hover:bg-${item.color}-500 group-hover:text-white transition-all duration-300 shadow-lg shadow-${item.color}-500/10`}>
                                                <item.icon size={28} />
                                            </div>
                                            <h3 className="text-xl font-bold text-white mb-2">{item.label}</h3>
                                            <p className="text-sm text-gray-500 group-hover:text-gray-300 transition-colors">{item.desc}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* PAPERS TAB */}
                        {activeTab === 'papers' && (
                            <div className="animate__animated animate__fadeIn">
                                {!selectedStream ? (
                                    <div className="max-w-6xl mx-auto">
                                        <div className="text-center mb-16 animate__animated animate__fadeInDown">
                                            <h2 className="text-4xl font-bold text-white mb-4">Select Your Stream</h2>
                                            <p className="text-gray-400">Access our comprehensive library of past papers and marking schemes.</p>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                            {[
                                                { id: 'science', color: 'blue', icon: 'microscope', label: 'Science', sub: 'Bio, Maths, Physics' },
                                                { id: 'commerce', color: 'emerald', icon: 'chart-pie', label: 'Commerce', sub: 'Acc, Bus, Econ' },
                                                { id: 'arts', color: 'amber', icon: 'palette', label: 'Arts', sub: 'Sinhala, History' },
                                                { id: 'technology', color: 'violet', icon: 'microchip', label: 'Technology', sub: 'SFT, ET, ICT' }
                                            ].map((stream, index) => (
                                                <div 
                                                    key={stream.id} 
                                                    onClick={() => loadSubjects(stream.id)}
                                                    style={{ animationDelay: `${index * 100}ms` }}
                                                    className={`glass p-8 rounded-3xl cursor-pointer hover:border-${stream.color}-500/50 hover:bg-[#151F32]/80 group relative overflow-hidden transition-all duration-300 hover:scale-[1.02] animate__animated animate__fadeInUp`}
                                                >
                                                    <div className={`absolute -right-4 -bottom-4 opacity-10 group-hover:opacity-20 transition-all duration-500 transform group-hover:rotate-12`}>
                                                         <i className={`fas fa-${stream.icon} text-9xl`}></i>
                                                    </div>
                                                    <div className={`w-16 h-16 bg-${stream.color}-500/10 rounded-2xl flex items-center justify-center mb-8 text-${stream.color}-400 group-hover:bg-${stream.color}-500 group-hover:text-white transition-all duration-300 shadow-lg shadow-${stream.color}-500/10`}>
                                                        <i className={`fas fa-${stream.icon} text-2xl`}></i>
                                                    </div>
                                                    <h4 className="text-2xl font-bold text-white mb-2">{stream.label}</h4>
                                                    <p className="text-sm text-gray-400">{stream.sub}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : !selectedSubject ? (
                                    <div className="max-w-4xl mx-auto animate__animated animate__fadeIn">
                                        <button onClick={resetStream} className="flex items-center gap-2 text-gray-400 hover:text-white mb-8 transition-colors group">
                                            <div className="p-2 rounded-full bg-white/5 group-hover:bg-white/10"><Icons.ArrowLeft size={16} /></div>
                                            <span className="text-sm font-bold uppercase tracking-wide">Back to Streams</span>
                                        </button>
                                        
                                        <h2 className="text-3xl font-bold text-white mb-8 flex items-center gap-3">
                                            <span className="text-emerald-400 capitalize">{selectedStream}</span>
                                            <span className="text-gray-600">/</span>
                                            <span>Subjects</span>
                                        </h2>

                                        {loading ? (
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                {[1,2,3].map(i => <div key={i} className="h-24 bg-white/5 rounded-xl animate-pulse"></div>)}
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                {subjects.map((sub, idx) => (
                                                    <button 
                                                        key={sub.id} 
                                                        onClick={() => loadPapers(sub)}
                                                        style={{ animationDelay: `${idx * 50}ms` }}
                                                        className="glass p-6 rounded-2xl text-left hover:border-emerald-500/50 hover:shadow-lg hover:shadow-emerald-500/10 transition-all flex justify-between items-center group animate__animated animate__fadeInUp"
                                                    >
                                                        <div>
                                                            <span className="block font-bold text-white text-lg group-hover:text-emerald-400 transition-colors">{sub.name}</span>
                                                            <span className="text-xs text-gray-500 font-mono">{sub.code}</span>
                                                        </div>
                                                        <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-500 group-hover:bg-emerald-500 group-hover:text-white transition-all">
                                                            <Icons.ChevronRight size={16} />
                                                        </div>
                                                    </button>
                                                ))}
                                                {subjects.length === 0 && <p className="text-gray-500 col-span-full text-center">No subjects found.</p>}
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="max-w-6xl mx-auto animate__animated animate__fadeIn pb-20">
                                        <div className="bg-[#0B1120]/80 backdrop-blur-md border-b border-white/5 sticky top-20 z-30 py-4 mb-8 -mx-4 px-4 md:mx-0 md:px-0 md:rounded-2xl md:border md:p-4 md:top-24 shadow-xl">
                                            <div className="flex flex-col lg:flex-row gap-4 justify-between lg:items-center">
                                                <div className="flex items-center gap-4">
                                                    <button onClick={resetSelection} className="p-2 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition-colors"><Icons.ArrowLeft size={20}/></button>
                                                    <div>
                                                        <h3 className="text-xl font-bold text-white">{selectedSubject.name}</h3>
                                                        <p className="text-xs text-gray-500 font-mono uppercase tracking-wide">{selectedSubject.code}</p>
                                                    </div>
                                                </div>
                                                
                                                <div className="flex items-center gap-3">
                                                    <div className="flex bg-white/5 p-1 rounded-lg border border-white/5">
                                                        <button onClick={() => setViewMode('grid')} className={`p-2 rounded-md transition-all ${viewMode === 'grid' ? 'bg-emerald-500 text-white shadow-md' : 'text-gray-400 hover:text-white'}`}><Icons.Grid size={18}/></button>
                                                        <button onClick={() => setViewMode('list')} className={`p-2 rounded-md transition-all ${viewMode === 'list' ? 'bg-emerald-500 text-white shadow-md' : 'text-gray-400 hover:text-white'}`}><Icons.List size={18}/></button>
                                                    </div>

                                                    <select 
                                                        value={yearFilter}
                                                        onChange={(e) => setYearFilter(e.target.value)}
                                                        className="px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-sm text-white focus:border-emerald-500 outline-none cursor-pointer transition-colors"
                                                    >
                                                        <option value="all">All Years</option>
                                                        {years.map(y => <option key={y} value={y}>{y}</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        {loading ? (
                                             <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                 {[1,2,3,4,5,6].map(i => <div key={i} className="h-40 bg-white/5 rounded-2xl animate-pulse"></div>)}
                                             </div>
                                        ) : (
                                            <div className={viewMode === 'grid' ? "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" : "flex flex-col gap-3"}>
                                                {filteredPapers.map((p, idx) => (
                                                    <div 
                                                        key={p.id} 
                                                        style={{ animationDelay: `${idx * 50}ms` }} 
                                                        className={`
                                                            glass border border-white/5 rounded-2xl hover:border-emerald-500/30 transition-all group animate__animated animate__fadeInUp
                                                            ${viewMode === 'grid' ? 'p-6 hover:-translate-y-1 hover:shadow-2xl hover:shadow-emerald-500/10' : 'p-4 flex items-center justify-between hover:bg-white/5'}
                                                        `}
                                                    >
                                                        <div className={viewMode === 'grid' ? 'mb-6' : 'flex items-center gap-4'}>
                                                            <span className={`inline-block px-2.5 py-1 rounded-lg bg-emerald-500/10 text-emerald-400 text-xs font-bold border border-emerald-500/20 ${viewMode === 'grid' ? 'mb-3' : ''}`}>
                                                                {p.year} A/L
                                                            </span>
                                                            <div>
                                                                <h4 className="font-bold text-white text-lg">Paper & Marking</h4>
                                                                {viewMode === 'grid' && <p className="text-xs text-gray-500 mt-1">Advanced Level Examination</p>}
                                                            </div>
                                                        </div>
                                                        
                                                        <div className={`flex gap-3 ${viewMode === 'grid' ? 'mt-auto' : ''}`}>
                                                            {p.paper_link && (
                                                                <a 
                                                                    href={p.paper_link} 
                                                                    target="_blank" 
                                                                    rel="noreferrer"
                                                                    onClick={() => handleDownload(p.id, 'paper', p.subject_name)}
                                                                    className={`
                                                                        flex items-center justify-center gap-2 rounded-xl font-bold transition-all border
                                                                        ${viewMode === 'grid' ? 'flex-1 py-3 text-sm bg-blue-600/10 text-blue-400 border-blue-500/20 hover:bg-blue-600 hover:text-white hover:scale-105 shadow-lg shadow-blue-900/20' : 'px-4 py-2 text-xs bg-white/5 text-gray-300 border-white/10 hover:border-blue-500 hover:text-blue-400'}
                                                                    `}
                                                                >
                                                                    <Icons.FileText size={16} /> {viewMode === 'grid' && "Question Paper"}
                                                                </a>
                                                            )}
                                                            {p.marking_scheme_link && (
                                                                <a 
                                                                    href={p.marking_scheme_link} 
                                                                    target="_blank" 
                                                                    rel="noreferrer"
                                                                    onClick={() => handleDownload(p.id, 'marking', p.subject_name)}
                                                                    className={`
                                                                        flex items-center justify-center gap-2 rounded-xl font-bold transition-all border
                                                                        ${viewMode === 'grid' ? 'flex-1 py-3 text-sm bg-emerald-600/10 text-emerald-400 border-emerald-500/20 hover:bg-emerald-600 hover:text-white hover:scale-105 shadow-lg shadow-emerald-900/20' : 'px-4 py-2 text-xs bg-white/5 text-gray-300 border-white/10 hover:border-emerald-500 hover:text-emerald-400'}
                                                                    `}
                                                                >
                                                                    <Icons.Shield size={16} /> {viewMode === 'grid' && "Marking Scheme"}
                                                                </a>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                                {filteredPapers.length === 0 && <div className="col-span-full text-center py-20 text-gray-500 animate__animated animate__fadeIn">No papers found matching criteria.</div>}
                                            </div>
                                        )}

                                        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-md px-4 z-40 animate__animated animate__fadeInUp">
                                            <div className="bg-[#0B1120]/80 backdrop-blur-xl border border-emerald-500/30 rounded-full shadow-2xl shadow-emerald-900/50 p-1.5 flex items-center ring-1 ring-white/10">
                                                <div className="pl-4 text-emerald-500"><Icons.Search size={18} /></div>
                                                <input 
                                                    type="text" 
                                                    placeholder="Quick Search Papers..." 
                                                    value={searchQuery}
                                                    onChange={(e) => setSearchQuery(e.target.value)}
                                                    className="bg-transparent border-none text-white text-sm w-full px-3 py-2 focus:outline-none placeholder-gray-500"
                                                />
                                                {searchQuery && (
                                                    <button onClick={() => setSearchQuery('')} className="p-2 rounded-full bg-white/10 text-gray-400 hover:text-white mr-1"><Icons.X size={14}/></button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* RESULTS TAB */}
                        {activeTab === 'results' && (
                            <div className="max-w-3xl mx-auto text-center py-12 animate__animated animate__fadeIn">
                                <div className="w-24 h-24 bg-gradient-to-br from-emerald-500 to-cyan-500 rounded-3xl flex items-center justify-center mx-auto mb-8 text-white shadow-[0_0_40px_rgba(16,185,129,0.4)] animate-float">
                                    <Icons.Award size={48} />
                                </div>
                                <h2 className="text-4xl font-bold text-white mb-4">Examination Results</h2>
                                <p className="text-gray-400 mb-12">Verify your academic performance directly via the official portal.</p>
                                
                                <a href="https://www.doenets.lk/examresults" target="_blank" rel="noreferrer" className="block glass p-8 rounded-3xl hover:border-emerald-500/50 transition-all group hover:scale-[1.02] hover:shadow-2xl hover:shadow-emerald-500/10 relative overflow-hidden">
                                    <div className="absolute inset-0 bg-gradient-to-r from-emerald-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                    <div className="flex items-center justify-between relative z-10">
                                        <div className="text-left flex items-center gap-4">
                                            <div className="w-12 h-12 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-400">
                                                <Icons.Shield size={24} />
                                            </div>
                                            <div>
                                                <h4 className="text-xl font-bold text-white group-hover:text-emerald-400 transition-colors">G.C.E. A/L Results</h4>
                                                <p className="text-sm text-gray-500">Official Department of Examinations</p>
                                            </div>
                                        </div>
                                        <div className="p-3 rounded-full bg-white/5 group-hover:bg-emerald-500 group-hover:text-white transition-all">
                                            <Icons.ExternalLink size={20} />
                                        </div>
                                    </div>
                                </a>
                            </div>
                        )}

                        {/* TIMETABLES TAB */}
                        {activeTab === 'timetables' && (
                            <div className="max-w-5xl mx-auto animate__animated animate__fadeIn">
                                <div className="text-center mb-12">
                                    <h2 className="text-3xl font-bold text-white mb-4">Exam Schedules & Calendar</h2>
                                    <p className="text-gray-400 mb-8">Stay organized with official dates and holidays.</p>
                                    
                                    {timetablePdf && (
                                        <a href={timetablePdf.link} target="_blank" rel="noreferrer" className="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white rounded-2xl font-bold transition-all shadow-xl shadow-emerald-900/50 hover:-translate-y-1 hover:scale-105">
                                            <Icons.Download size={20} /> <span>Download Official PDF ({timetablePdf.year})</span>
                                        </a>
                                    )}
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div className="glass rounded-3xl p-8">
                                        <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                                            <Icons.Calendar className="text-purple-400" /> Upcoming Events
                                        </h3>
                                        <div className="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                                            {examDates.length > 0 ? examDates.map((date, idx) => (
                                                <div key={date.id} style={{ animationDelay: `${idx * 100}ms` }} className="flex items-center gap-5 p-4 bg-white/5 rounded-2xl border border-white/5 hover:border-white/10 transition-all animate__animated animate__fadeInUp hover:bg-white/10">
                                                    <div className={`flex flex-col items-center justify-center w-14 h-14 rounded-xl text-white shadow-inner ${date.type === 'Exam' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>
                                                        <span className="text-[10px] font-bold uppercase tracking-wide">{new Date(date.date).toLocaleString('default', {month: 'short'})}</span>
                                                        <span className="text-xl font-bold leading-none">{new Date(date.date).getDate()}</span>
                                                    </div>
                                                    <div>
                                                        <h4 className="font-bold text-gray-100">{date.details}</h4>
                                                        <div className="flex items-center gap-2 mt-1">
                                                             <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold uppercase ${date.type === 'Exam' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-red-500/10 text-red-400'}`}>{date.type}</span>
                                                             <span className="text-xs text-gray-500">{new Date(date.date).getFullYear()}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )) : <div className="text-center text-gray-500 py-10">No scheduled events found.</div>}
                                        </div>
                                    </div>
                                    <div><CalendarWidget /></div>
                                </div>
                            </div>
                        )}

                        {/* AI TUTOR TAB */}
                        {activeTab === 'ai-tutor' && (
                            <div className="max-w-4xl mx-auto h-[calc(100vh-200px)] flex flex-col animate__animated animate__fadeIn">
                                <div className="text-center mb-6">
                                     <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-pink-500/10 border border-pink-500/20 text-pink-400 text-xs font-bold uppercase tracking-widest mb-2 backdrop-blur-md">
                                        <Icons.Sparkles size={12} /> Gemini 3.0 Powered
                                    </div>
                                    <h2 className="text-3xl font-bold text-white">AI Study Assistant</h2>
                                    <p className="text-gray-500 text-sm">I can search the web, reason through math/science problems, and find papers.</p>
                                </div>

                                <div className="flex-1 glass rounded-3xl p-6 mb-4 overflow-y-auto custom-scrollbar flex flex-col gap-4 relative">
                                    {chatMessages.length === 0 && (
                                        <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-500 p-8 text-center opacity-70">
                                            <Icons.Bot size={48} className="mb-4 text-emerald-500/50" />
                                            <p>Hello! I'm your intelligent AI Tutor. Ask me anything about your A/L studies.</p>
                                        </div>
                                    )}
                                    
                                    {chatMessages.map((msg, i) => (
                                        <div key={i} className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'} gap-1 animate__animated animate__fadeInUp`}>
                                            <div className={`max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed shadow-lg ${
                                                msg.role === 'user' 
                                                ? 'bg-emerald-600 text-white rounded-tr-none' 
                                                : 'bg-white/10 border border-white/5 text-gray-200 rounded-tl-none backdrop-blur-md'
                                            }`}>
                                                {msg.role === 'model' && (
                                                    <div className="text-[10px] text-gray-400 font-bold uppercase mb-2 flex items-center gap-2 border-b border-white/10 pb-1">
                                                        <Icons.Sparkles size={10}/> AI Tutor
                                                    </div>
                                                )}
                                                <div className="whitespace-pre-wrap">{msg.text}</div>
                                            </div>
                                            
                                            {msg.groundingUrls && msg.groundingUrls.length > 0 && (
                                                <div className="flex flex-wrap gap-2 max-w-[85%] mt-1">
                                                    {msg.groundingUrls.map((url, uIdx) => (
                                                        <a key={uIdx} href={url} target="_blank" rel="noreferrer" className="flex items-center gap-1 px-2 py-1 rounded-md bg-blue-500/10 text-blue-400 text-[10px] hover:bg-blue-500/20 border border-blue-500/20 truncate max-w-[200px] transition-colors">
                                                            <Icons.Globe size={10} /> {new URL(url).hostname}
                                                        </a>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    
                                    {isThinking && (
                                        <div className="flex justify-start animate__animated animate__fadeIn">
                                            <div className="bg-white/5 border border-white/5 p-3 rounded-2xl rounded-tl-none flex items-center gap-3 text-xs text-pink-400 backdrop-blur-md">
                                                <Icons.BrainCircuit size={14} className="animate-pulse" />
                                                <span>Thinking...</span>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div ref={chatEndRef} />
                                </div>

                                <form onSubmit={handleChatSubmit} className="relative">
                                    <input 
                                        type="text" 
                                        value={chatInput}
                                        onChange={(e) => setChatInput(e.target.value)}
                                        placeholder="Ask a question (e.g. 'Solve this', 'Find papers')..." 
                                        className="w-full bg-[#151F32]/80 backdrop-blur-md border border-white/10 rounded-2xl py-4 pl-6 pr-14 text-white focus:border-emerald-500 focus:outline-none transition-all placeholder-gray-600 shadow-xl"
                                        disabled={isChatLoading || isThinking}
                                    />
                                    <button 
                                        type="submit" 
                                        disabled={!chatInput.trim() || isChatLoading || isThinking}
                                        className="absolute right-2 top-2 p-2.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 active:scale-95"
                                    >
                                        <Icons.Send size={18} />
                                    </button>
                                </form>
                            </div>
                        )}

                        {/* NOTICES TAB */}
                        {activeTab === 'notices' && (
                            <div className="max-w-4xl mx-auto animate__animated animate__fadeIn">
                                 <h2 className="text-3xl font-bold text-white mb-10 text-center">Announcements Board</h2>
                                 <div className="grid gap-6">
                                    {notices.length > 0 ? notices.map((n, idx) => (
                                        <div key={n.id} style={{ animationDelay: `${idx * 100}ms` }} className={`glass p-8 rounded-3xl border border-white/5 relative overflow-hidden group hover:-translate-y-1 transition-all duration-300 animate__animated animate__fadeInUp hover:bg-white/10`}>
                                            <div className={`absolute left-0 top-0 bottom-0 w-2 ${n.type === 'important' ? 'bg-red-500' : n.type === 'opportunity' ? 'bg-emerald-500' : 'bg-blue-500'}`}></div>
                                            <div className="flex justify-between items-start mb-4 pl-4">
                                                <h3 className="font-bold text-white text-xl">{n.title}</h3>
                                                <span className="text-xs text-gray-500 font-mono bg-white/5 px-3 py-1 rounded-full">{new Date(n.created_at).toLocaleDateString()}</span>
                                            </div>
                                            <p className="text-gray-400 text-sm leading-relaxed pl-4 whitespace-pre-wrap">{n.body}</p>
                                        </div>
                                    )) : <div className="text-center text-gray-500 py-20">No notices posted.</div>}
                                 </div>
                            </div>
                        )}
                    </main>

                    {/* FOOTER */}
                    <footer className="border-t border-white/5 bg-[#0B1120]/80 backdrop-blur-lg py-10 mt-auto relative z-10">
                        <div className="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-6 text-sm text-gray-500">
                            <div className="flex flex-col items-center md:items-start gap-1">
                                <div className="flex items-center gap-2 text-white font-bold">
                                    <div className="w-6 h-6 bg-emerald-500 rounded flex items-center justify-center text-xs">DE</div>
                                    DE Education.lk
                                </div>
                                <span>Â© 2025 DE Education.lk</span>
                            </div>
                            
                            <div className="flex flex-col items-center gap-1">
                                <span>Designed & Developed by</span>
                                <a href="https://dilnuka13.github.io/my/about.html" target="_blank" rel="noreferrer" className="text-emerald-500 hover:text-emerald-300 font-bold text-base transition-colors hover:underline flex items-center gap-1">
                                    Isara Dilnuka <Icons.ExternalLink size={12} />
                                </a>
                            </div>

                            <div className="flex gap-6">
                                <button onClick={() => setActiveModal('terms')} className="hover:text-white transition-colors">Terms</button>
                                <button onClick={() => setActiveModal('privacy')} className="hover:text-white transition-colors">Privacy</button>
                            </div>
                        </div>
                    </footer>

                    {/* Terms/Privacy Modal */}
                    {activeModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate__animated animate__fadeIn">
                            <div className="glass border border-white/10 rounded-3xl max-w-2xl w-full max-h-[80vh] overflow-y-auto p-8 relative shadow-2xl animate__animated animate__zoomIn">
                                <button 
                                    onClick={() => setActiveModal(null)}
                                    className="absolute top-6 right-6 p-2 bg-white/5 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition-colors"
                                >
                                    <Icons.X size={20} />
                                </button>
                                
                                <div className="flex items-center gap-4 mb-8 pb-6 border-b border-white/5">
                                    <div className="w-12 h-12 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-500">
                                        {activeModal === 'terms' ? <Icons.FileText size={24} /> : <Icons.Shield size={24} />}
                                    </div>
                                    <h2 className="text-3xl font-bold text-white">
                                        {activeModal === 'terms' ? 'Terms of Service' : 'Privacy Policy'}
                                    </h2>
                                </div>

                                <div className="prose prose-invert text-gray-400 text-sm leading-relaxed space-y-6">
                                    {activeModal === 'terms' ? (
                                        <>
                                            <div>
                                                <h4 className="text-white font-bold text-lg mb-2">1. Educational Use Only</h4>
                                                <p>Materials provided on this platform, including past papers and marking schemes, are for educational and reference purposes only.</p>
                                            </div>
                                            <div>
                                                <h4 className="text-white font-bold text-lg mb-2">2. User Conduct</h4>
                                                <p>You agree not to misuse the platform, attempt to breach security measures, or use the service for any illegal activities.</p>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div>
                                                <h4 className="text-white font-bold text-lg mb-2">1. Data Collection</h4>
                                                <p>We do not collect personal data from general student users. You can access papers and results without creating an account.</p>
                                            </div>
                                            <div>
                                                <h4 className="text-white font-bold text-lg mb-2">2. Admin Security</h4>
                                                <p>Administrative access is protected by biometric facial recognition technology.</p>
                                            </div>
                                        </>
                                    )}
                                </div>
                                
                                <div className="mt-10 pt-6 border-t border-white/5 flex justify-end">
                                    <button onClick={() => setActiveModal(null)} className="px-8 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold transition-colors shadow-lg shadow-emerald-900/20 hover:scale-105">Close</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- APP & ROUTER CONFIG ---
        const MaintenanceGuard = ({ children }) => {
            const [isMaintenance, setIsMaintenance] = useState(false);
            const [loading, setLoading] = useState(true);
            const location = useLocation();

            useEffect(() => {
                const checkStatus = async () => {
                    try {
                        const { data } = await supabaseClient.from('system_settings').select('value').eq('key', 'maintenance').single();
                        if (data && data.value && data.value.isActive) {
                            setIsMaintenance(true);
                        } else {
                            setIsMaintenance(false);
                        }
                    } catch (e) {
                        console.error("Maintenance check failed", e);
                    } finally {
                        setLoading(false);
                    }
                };
                checkStatus();
            }, [location.pathname]);

            if (loading) return <div className="min-h-screen flex items-center justify-center text-emerald-500 font-bold animate-pulse">Checking System...</div>;
            if (isMaintenance && !location.pathname.startsWith('/admin')) {
                return <Navigate to="/maintenance" replace />;
            }
            return <>{children}</>;
        };

        const App = () => {
            return (
                <HashRouter>
                    <Routes>
                        <Route path="/maintenance" element={<MaintenancePage />} />
                        <Route path="/admin" element={<AdminPage />} />
                        <Route 
                            path="/" 
                            element={
                                <MaintenanceGuard>
                                    <MainPage />
                                </MaintenanceGuard>
                            } 
                        />
                        <Route path="*" element={<Navigate to="/" />} />
                    </Routes>
                </HashRouter>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>