<!DOCTYPE html>
<html lang="si" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    
    <!-- PRIMARY META TAGS -->
    <title> DE Education </title>
    <meta name="title" content="DE Education.lk | Sri Lanka's Best A/L Education Platform" />
    <meta name="description" content="ශ්‍රී ලංකාවේ උසස් පෙළ සිසුන් සඳහාම වෙන්වූ අංක 1 අධ්‍යාපනික වේදිකාව. Past Papers, Marking Schemes, Exam Results සහ AI Tutor පහසුකම එකම තැනකින්." />
    <meta name="keywords" content="DE Education, Sri Lanka Education, GCE A/L, Advanced Level, Past Papers, Marking Schemes, Exam Results, AI Tutor, Sinhala Education, Science, Commerce, Arts, Technology, Isara Dilnuka, Exam Timetable, Online Learning" />
    <meta name="author" content="Isara Dilnuka (DE Education)" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="Sinhala, English" />
    <meta name="revisit-after" content="1 days" />
    <meta name="theme-color" content="#000000" />

    <!-- OPEN GRAPH / FACEBOOK -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://de-education.lk/" />
    <meta property="og:title" content="DE Education.lk | Shape Your Future" />
    <meta property="og:description" content="Access A/L Past Papers, Results, and chat with our AI Tutor. The smartest way to prepare for your exams in Sri Lanka." />
    <meta property="og:image" content="https://images.unsplash.com/photo-1546410531-bb4caa6b424d?q=80&w=1471&auto=format&fit=crop" />
    <meta property="og:locale" content="en_LK" />
    <meta property="og:site_name" content="DE Education" />

    <!-- TWITTER -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://de-education.lk/" />
    <meta property="twitter:title" content="DE Education.lk | Smart Learning Platform" />
    <meta property="twitter:description" content="Get instant access to A/L resources and AI assistance. Your personal study companion." />
    <meta property="twitter:image" content="https://images.unsplash.com/photo-1546410531-bb4caa6b424d?q=80&w=1471&auto=format&fit=crop" />
    <meta property="twitter:creator" content="@IsaraDilnuka" />

    <!-- MOBILE APP TAGS -->
    <meta name="application-name" content="DE Education" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="DE Education" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="mobile-web-app-capable" content="yes" />

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- React Router -->
    <script src="https://unpkg.com/history@5/umd/history.development.js"></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    
    <!-- Face API -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Noto+Sinhala:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        sinhala: ['Noto Sinhala', 'sans-serif'],
                    },
                    colors: {
                        emerald: {
                            50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399',
                            500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b', 950: '#022c22',
                        },
                        dark: {
                            bg: '#000000', // Pure Black
                            card: 'rgba(20, 20, 20, 0.6)',
                        }
                    },
                    animation: {
                        'float': 'float 8s ease-in-out infinite',
                        'float-delayed': 'float 8s ease-in-out 4s infinite',
                        'pulse-slow': 'pulse 5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'blob': 'blob 10s infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #000000;
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 50%, #111 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #000000; }
        ::-webkit-scrollbar-thumb { 
            background: rgba(255, 255, 255, 0.2); 
            border-radius: 10px; 
        }
        ::-webkit-scrollbar-thumb:hover { background: #10b981; }
        
        /* Improved Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .glass-hover:hover {
            background: rgba(255, 255, 255, 0.07);
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.15);
            transform: translateY(-4px);
        }

        /* Neon Text Utilities */
        .text-glow {
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }
    </style>
</head>
<body class="text-gray-200 antialiased min-h-screen selection:bg-emerald-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        // --- IMPORTS & SETUP ---
        const { useState, useEffect, useRef, useMemo } = React;
        const { HashRouter, Routes, Route, Navigate, useLocation } = ReactRouterDOM;
        const { createClient } = supabase;

        // --- CONSTANTS ---
        const SUPABASE_URL = 'https://hppojrbfhzttzvlvovre.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcG9qcmJmaHp0dHp2bHZvdnJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODgxNDYsImV4cCI6MjA3Njc2NDE0Nn0.aL2fegb_eRPY0E7P6Mwufhq3TCAeX8-hDCHBo9VeAsA';
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
        const GEMINI_API_KEY = 'AIzaSyD-Fw9jJVgzy0RN4rHbqIUrptwJNgF4gVA'; 

        const SUPER_ADMIN_EMAIL = 'isaradilnuka@gmail.com'; 
        const ADMIN_SECRET = 'admin123'; 

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ICON WRAPPER ---
        const IconWrapper = ({ icon, size = 18, className = "" }) => {
            const sizeStyle = { fontSize: size + 'px' };
            return <i className={`${icon} ${className}`} style={sizeStyle}></i>;
        };

        const Icons = {
            LayoutDashboard: (p) => <IconWrapper icon="fas fa-th-large" {...p} />,
            FileText: (p) => <IconWrapper icon="fas fa-file-alt" {...p} />,
            Calendar: (p) => <IconWrapper icon="fas fa-calendar-alt" {...p} />,
            Bell: (p) => <IconWrapper icon="fas fa-bell" {...p} />,
            Settings: (p) => <IconWrapper icon="fas fa-cog" {...p} />,
            LogOut: (p) => <IconWrapper icon="fas fa-sign-out-alt" {...p} />,
            Upload: (p) => <IconWrapper icon="fas fa-cloud-upload-alt" {...p} />,
            Trash2: (p) => <IconWrapper icon="fas fa-trash-alt" {...p} />,
            Camera: (p) => <IconWrapper icon="fas fa-camera" {...p} />,
            Shield: (p) => <IconWrapper icon="fas fa-shield-alt" {...p} />,
            Users: (p) => <IconWrapper icon="fas fa-users" {...p} />,
            BookOpen: (p) => <IconWrapper icon="fas fa-book-open" {...p} />,
            Award: (p) => <IconWrapper icon="fas fa-medal" {...p} />,
            Search: (p) => <IconWrapper icon="fas fa-search" {...p} />,
            ExternalLink: (p) => <IconWrapper icon="fas fa-external-link-alt" {...p} />,
            Download: (p) => <IconWrapper icon="fas fa-download" {...p} />,
            ArrowLeft: (p) => <IconWrapper icon="fas fa-arrow-left" {...p} />,
            Menu: (p) => <IconWrapper icon="fas fa-bars" {...p} />,
            X: (p) => <IconWrapper icon="fas fa-times" {...p} />,
            Grid: (p) => <IconWrapper icon="fas fa-th" {...p} />,
            List: (p) => <IconWrapper icon="fas fa-list" {...p} />,
            Moon: (p) => <IconWrapper icon="fas fa-moon" {...p} />,
            Sun: (p) => <IconWrapper icon="fas fa-sun" {...p} />,
            ChevronLeft: (p) => <IconWrapper icon="fas fa-chevron-left" {...p} />,
            ChevronRight: (p) => <IconWrapper icon="fas fa-chevron-right" {...p} />,
            MapPin: (p) => <IconWrapper icon="fas fa-map-marker-alt" {...p} />,
            Sparkles: (p) => <IconWrapper icon="fas fa-magic" {...p} />,
            Send: (p) => <IconWrapper icon="fas fa-paper-plane" {...p} />,
            Bot: (p) => <IconWrapper icon="fas fa-robot" {...p} />,
            BrainCircuit: (p) => <IconWrapper icon="fas fa-brain" {...p} />,
            Globe: (p) => <IconWrapper icon="fas fa-globe-asia" {...p} />,
            Home: (p) => <IconWrapper icon="fas fa-home" {...p} />,
            Folder: (p) => <IconWrapper icon="fas fa-folder" {...p} />,
            FolderOpen: (p) => <IconWrapper icon="fas fa-folder-open" {...p} />,
            ArrowRight: (p) => <IconWrapper icon="fas fa-arrow-right" {...p} />,
            Apps: (p) => <IconWrapper icon="fas fa-mobile-alt" {...p} />,
        };

        // --- BACKGROUND COMPONENT (ENHANCED BLACK THEME) ---
        const BackgroundEffects = () => {
            return (
                <div className="fixed inset-0 -z-10 overflow-hidden pointer-events-none bg-black">
                     {/* Gradient Blobs */}
                    <div className="absolute top-[-10%] left-[-10%] w-[60%] h-[60%] bg-emerald-900/10 rounded-full blur-[150px] animate-blob mix-blend-screen"></div>
                    <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] bg-blue-900/10 rounded-full blur-[150px] animate-blob animation-delay-2000 mix-blend-screen"></div>
                    <div className="absolute top-[30%] left-[40%] w-[30%] h-[30%] bg-purple-900/10 rounded-full blur-[120px] animate-pulse-slow mix-blend-screen"></div>
                    
                    {/* Grid Overlay */}
                    <div className="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:50px_50px] [mask-image:radial-gradient(ellipse_80%_80%_at_50%_50%,#000_20%,transparent_100%)]"></div>
                </div>
            );
        };

        // --- DATA CONSTANTS ---
        const SRI_LANKAN_HOLIDAYS_2025 = {
            '2025-01-13': { name: 'Duruthu Full Moon Poya', type: 'poya' },
            '2025-01-14': { name: 'Tamil Thai Pongal', type: 'public' },
            '2025-02-04': { name: 'Independence Day', type: 'public' },
            '2025-02-12': { name: 'Navam Full Moon Poya', type: 'poya' },
            '2025-02-26': { name: 'Mahasivarathri Day', type: 'public' },
            '2025-03-13': { name: 'Madin Full Moon Poya', type: 'poya' },
            '2025-04-11': { name: 'Sinhala & Tamil New Year Eve', type: 'public' },
            '2025-04-12': { name: 'Sinhala & Tamil New Year', type: 'public' },
            '2025-04-13': { name: 'Bak Full Moon Poya', type: 'poya' },
            '2025-05-01': { name: 'May Day', type: 'public' },
            '2025-05-12': { name: 'Vesak Full Moon Poya', type: 'poya' },
            '2025-05-13': { name: 'Day following Vesak', type: 'public' },
            '2025-06-10': { name: 'Poson Full Moon Poya', type: 'poya' },
            '2025-07-10': { name: 'Esala Full Moon Poya', type: 'poya' },
            '2025-08-08': { name: 'Nikini Full Moon Poya', type: 'poya' },
            '2025-09-07': { name: 'Binara Full Moon Poya', type: 'poya' },
            '2025-10-06': { name: 'Vap Full Moon Poya', type: 'poya' },
            '2025-11-05': { name: 'Il Full Moon Poya', type: 'poya' },
            '2025-12-04': { name: 'Unduvap Full Moon Poya', type: 'poya' },
            '2025-12-25': { name: 'Christmas Day', type: 'public' },
        };

        // --- MAINTENANCE PAGE ---
        const MaintenancePage = () => {
            const [timeLeft, setTimeLeft] = useState({ days: 0, hours: 0, minutes: 0, seconds: 0 });
            const [endTime, setEndTime] = useState(null);

            useEffect(() => {
                const fetchSettings = async () => {
                    const { data } = await supabaseClient.from('system_settings').select('value').eq('key', 'maintenance').single();
                    if (data?.value?.endTime) {
                        setEndTime(new Date(data.value.endTime).getTime());
                    } else {
                        setEndTime(new Date().getTime() + 86400000); 
                    }
                };
                fetchSettings();
            }, []);

            useEffect(() => {
                if (!endTime) return;
                const timer = setInterval(() => {
                    const now = new Date().getTime();
                    const distance = endTime - now;
                    if (distance < 0) {
                        clearInterval(timer);
                        window.location.hash = '/'; 
                    } else {
                        setTimeLeft({
                            days: Math.floor(distance / (1000 * 60 * 60 * 24)),
                            hours: Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)),
                            minutes: Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)),
                            seconds: Math.floor((distance % (1000 * 60)) / 1000)
                        });
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, [endTime]);

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden bg-black">
                    <BackgroundEffects />
                    <div className="relative z-10 glass p-10 md:p-14 rounded-[2rem] max-w-xl w-full text-center shadow-2xl animate__animated animate__zoomIn border border-white/5">
                        <div className="animate-float mb-8">
                            <div className="inline-flex items-center justify-center w-32 h-32 rounded-full bg-emerald-500/5 ring-1 ring-emerald-500/30 shadow-[0_0_80px_rgba(16,185,129,0.2)]">
                                <i className="fas fa-tools text-6xl text-emerald-500"></i>
                            </div>
                        </div>
                        <h1 className="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-emerald-300 to-white mb-4 animate__animated animate__fadeInUp">Upgrade in Progress</h1>
                        <p className="text-gray-400 mb-10 animate__animated animate__fadeInUp font-light text-lg">We are enhancing DE Education to serve you better. We'll be back online shortly.</p>
                        <div className="flex justify-center gap-4 mb-8 animate__animated animate__fadeIn">
                            {Object.entries(timeLeft).map(([unit, value]) => (
                                <div key={unit} className="flex flex-col items-center p-4 rounded-2xl bg-white/5 border border-white/5 min-w-[80px] backdrop-blur-md shadow-lg">
                                    <span className="text-3xl font-bold text-emerald-400 font-mono">{String(value).padStart(2, '0')}</span>
                                    <span className="text-[10px] uppercase tracking-wider text-gray-500 mt-2">{unit}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ADMIN COMPONENTS ---
        const DashboardStats = () => {
            const [counts, setCounts] = useState({ papers: 0, notices: 0, pDownloads: 0, mDownloads: 0 });
            
            useEffect(() => {
                const fetchStats = async () => {
                    const { count: pCount } = await supabaseClient.from('past_papers').select('*', { count: 'exact', head: true });
                    const { count: nCount } = await supabaseClient.from('notices').select('*', { count: 'exact', head: true });
                    const { data: dlStats } = await supabaseClient.from('subject_download_stats').select('*');
                    
                    const pDl = dlStats?.reduce((acc, curr) => acc + (curr.paper_downloads || 0), 0) || 0;
                    const mDl = dlStats?.reduce((acc, curr) => acc + (curr.marking_downloads || 0), 0) || 0;

                    setCounts({ papers: pCount || 0, notices: nCount || 0, pDownloads: pDl, mDownloads: mDl });
                };
                fetchStats();
            }, []);

            return (
                <div className="space-y-8 animate__animated animate__fadeIn">
                    <h2 className="text-3xl font-bold text-white flex items-center gap-3"><Icons.LayoutDashboard /> Dashboard Overview</h2>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        {[
                            { label: 'Total Papers', val: counts.papers, color: 'emerald', icon: Icons.FileText },
                            { label: 'Active Notices', val: counts.notices, color: 'yellow', icon: Icons.Bell },
                            { label: 'Paper Downloads', val: counts.pDownloads, color: 'blue', icon: Icons.Upload },
                            { label: 'Marking Downloads', val: counts.mDownloads, color: 'purple', icon: Icons.Shield }
                        ].map((item, i) => (
                            <div key={i} className={`glass p-6 border-b-2 border-${item.color}-500/50 rounded-2xl shadow-lg hover:shadow-[0_0_30px_rgba(0,0,0,0.3)] transition-all duration-300 transform hover:-translate-y-2 group bg-opacity-40`}>
                                <div className="flex justify-between items-start mb-4">
                                    <div className={`p-3 rounded-xl bg-${item.color}-500/10 text-${item.color}-400 group-hover:bg-${item.color}-500 group-hover:text-white transition-colors`}>
                                        <item.icon size={24} />
                                    </div>
                                    <span className="text-gray-400 text-xs font-bold uppercase tracking-wider bg-white/5 px-2 py-1 rounded border border-white/5">{item.label}</span>
                                </div>
                                <span className="text-4xl font-extrabold text-white">{item.val.toLocaleString()}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const PapersManager = () => {
            const [papers, setPapers] = useState([]);
            const [form, setForm] = useState({ year: '', subject_name: '', subject_code: '', paper_link: '', marking_link: '' });
            const [streams, setStreams] = useState([]);
            
            useEffect(() => { loadPapers(); }, []);

            const loadPapers = async () => {
                const { data } = await supabaseClient.from('past_papers').select('*').order('created_at', {ascending: false});
                if(data) setPapers(data);
            };

            const handleDelete = async (id) => {
                if(confirm('Are you sure you want to delete this paper permanently?')) {
                    await supabaseClient.from('past_papers').delete().eq('id', id);
                    loadPapers();
                }
            };

            const handleStreamChange = (e) => {
                const val = e.target.value;
                setStreams(prev => prev.includes(val) ? prev.filter(s => s !== val) : [...prev, val]);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if(streams.length === 0) return alert("Please select at least one stream");
                
                const inserts = streams.map(stream => ({
                    year: parseInt(form.year),
                    subject_name: form.subject_name,
                    subject_code: form.subject_code,
                    stream: stream,
                    paper_link: form.paper_link,
                    marking_scheme_link: form.marking_link
                }));

                const { error } = await supabaseClient.from('past_papers').insert(inserts);
                if(error) alert(error.message);
                else {
                    loadPapers();
                    setForm({ year: '', subject_name: '', subject_code: '', paper_link: '', marking_link: '' });
                    setStreams([]);
                    alert("Resources uploaded successfully!");
                }
            };

            return (
                <div className="space-y-6 animate__animated animate__fadeIn">
                     <div className="glass p-8 rounded-3xl animate__animated animate__fadeInDown border border-white/10 relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-40 h-40 bg-emerald-500/5 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <h3 className="text-xl font-bold text-white mb-8 flex items-center gap-3"><Icons.Upload className="text-emerald-500"/> Upload New Resource</h3>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <input placeholder="Subject Name (e.g. Physics)" value={form.subject_name} onChange={e => setForm({...form, subject_name: e.target.value})} className="p-4 bg-black/40 border border-white/10 rounded-xl text-white focus:border-emerald-500 focus:outline-none transition-colors" required />
                                <input placeholder="Subject Code (e.g. 71)" value={form.subject_code} onChange={e => setForm({...form, subject_code: e.target.value})} className="p-4 bg-black/40 border border-white/10 rounded-xl text-white focus:border-emerald-500 focus:outline-none transition-colors" />
                                <input type="number" placeholder="Year (e.g. 2024)" value={form.year} onChange={e => setForm({...form, year: e.target.value})} className="p-4 bg-black/40 border border-white/10 rounded-xl text-white focus:border-emerald-500 focus:outline-none transition-colors" required />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                 <input placeholder="Paper PDF Direct Link" value={form.paper_link} onChange={e => setForm({...form, paper_link: e.target.value})} className="p-4 bg-black/40 border border-white/10 rounded-xl text-white focus:border-emerald-500 focus:outline-none transition-colors" />
                                 <input placeholder="Marking Scheme Direct Link" value={form.marking_link} onChange={e => setForm({...form, marking_link: e.target.value})} className="p-4 bg-black/40 border border-white/10 rounded-xl text-white focus:border-emerald-500 focus:outline-none transition-colors" />
                            </div>
                            <div className="flex gap-4 items-center flex-wrap p-5 bg-white/5 rounded-xl border border-white/5">
                                <span className="text-sm font-bold text-gray-400 uppercase tracking-wide mr-2">Target Streams:</span>
                                {['science', 'commerce', 'arts', 'technology'].map(s => (
                                    <label key={s} className="flex items-center gap-2 text-sm text-gray-300 capitalize cursor-pointer hover:text-white transition-colors bg-black/30 px-4 py-2 rounded-lg border border-transparent hover:border-emerald-500/50">
                                        <input type="checkbox" value={s} checked={streams.includes(s)} onChange={handleStreamChange} className="accent-emerald-500 w-4 h-4 rounded" /> {s}
                                    </label>
                                ))}
                            </div>
                            <button type="submit" className="w-full md:w-auto px-10 py-4 bg-gradient-to-r from-emerald-600 to-emerald-500 text-white rounded-xl font-bold hover:shadow-[0_0_25px_rgba(16,185,129,0.3)] transition-all transform hover:scale-[1.02] border border-emerald-500/20">
                                <i className="fas fa-plus mr-2"></i> Add to Database
                            </button>
                        </form>
                     </div>

                     <div className="grid grid-cols-1 gap-4">
                         {papers.map((p, idx) => (
                             <div key={p.id} style={{ animationDelay: `${idx * 50}ms` }} className="flex justify-between items-center p-6 glass rounded-2xl animate__animated animate__fadeInUp hover:bg-white/5 transition-colors border-l-4 border-emerald-500/50">
                                 <div>
                                     <h4 className="text-white font-bold text-lg">{p.subject_name} <span className="text-sm text-gray-500 font-mono ml-2">{p.subject_code}</span></h4>
                                     <div className="flex items-center gap-3 mt-2">
                                         <span className="text-xs font-bold px-2 py-0.5 rounded bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">{p.year}</span>
                                         <span className="text-xs font-bold px-2 py-0.5 rounded bg-blue-500/10 text-blue-400 border border-blue-500/20 uppercase">{p.stream}</span>
                                     </div>
                                 </div>
                                 <button onClick={() => handleDelete(p.id)} className="text-red-400 hover:text-red-300 p-3 rounded-full hover:bg-red-500/10 transition-all"><Icons.Trash2 size={20} /></button>
                             </div>
                         ))}
                     </div>
                </div>
            );
        };

        const MaintenanceControl = () => {
            const [status, setStatus] = useState(false);
            useEffect(() => {
                supabaseClient.from('system_settings').select('value').eq('key', 'maintenance').single()
                    .then(({ data }) => setStatus(data?.value?.isActive || false));
            }, []);

            const toggle = async () => {
                const newState = !status;
                await supabaseClient.from('system_settings').upsert({ key: 'maintenance', value: { isActive: newState, endTime: new Date(Date.now() + 86400000).toISOString() } });
                setStatus(newState);
            };

            return (
                <div className={`p-8 rounded-3xl border glass flex flex-col md:flex-row justify-between items-center gap-4 animate__animated animate__fadeIn ${status ? 'border-red-500/30 bg-red-900/5' : 'border-emerald-500/30 bg-emerald-900/5'}`}>
                    <div>
                        <h3 className="font-bold text-white text-xl flex items-center gap-3">
                            {status ? <i className="fas fa-exclamation-triangle text-red-500"></i> : <i className="fas fa-check-circle text-emerald-500"></i>}
                            Maintenance Mode
                        </h3>
                        <p className="text-sm text-gray-400 mt-2 max-w-md">{status ? 'System is currently locked. Users are redirected to the maintenance page.' : 'System is live and accessible to all students.'}</p>
                    </div>
                    <button onClick={toggle} className={`px-8 py-3 rounded-xl font-bold text-white transition-all transform hover:scale-105 shadow-lg border border-white/10 ${status ? 'bg-red-600 hover:bg-red-500 shadow-red-900/30' : 'bg-emerald-600 hover:bg-emerald-500 shadow-emerald-900/30'}`}>
                        {status ? 'Deactivate Maintenance' : 'Activate Maintenance'}
                    </button>
                </div>
            );
        };

        const UserApprovals = () => {
            const [users, setUsers] = useState([]);
            useEffect(() => {
                supabaseClient.from('users').select('*').eq('approved', false).then(({ data }) => setUsers(data || []));
            }, []);

            const approve = async (id) => {
                await supabaseClient.from('users').update({ approved: true }).eq('id', id);
                setUsers(prev => prev.filter(u => u.id !== id));
            };

            return (
                <div className="animate__animated animate__fadeIn">
                    <h2 className="text-2xl font-bold text-white mb-6">Pending Admin Requests</h2>
                    <div className="grid gap-4">
                        {users.map(u => (
                            <div key={u.id} className="flex justify-between items-center p-6 glass rounded-2xl animate__animated animate__fadeInUp border border-white/5">
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 rounded-full bg-gray-800 flex items-center justify-center text-white font-bold text-xl border border-white/5">
                                        {u.name.charAt(0)}
                                    </div>
                                    <div>
                                        <p className="font-bold text-white text-lg">{u.name}</p>
                                        <p className="text-sm text-gray-500 font-mono">{u.email}</p>
                                    </div>
                                </div>
                                <button onClick={() => approve(u.id)} className="px-6 py-2 bg-emerald-600 text-white text-sm font-bold rounded-lg hover:bg-emerald-500 transition-colors shadow-lg shadow-emerald-900/20">Grant Access</button>
                            </div>
                        ))}
                        {users.length === 0 && (
                            <div className="p-10 text-center glass rounded-3xl text-gray-500 border-dashed border border-white/10">
                                <Icons.Users size={40} className="mb-3 opacity-30 mx-auto"/>
                                <p>No pending approvals found.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const AdminPage = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [email, setEmail] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [loginStatus, setLoginStatus] = useState('');
            const [showCamera, setShowCamera] = useState(false);
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);

            useEffect(() => {
                Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]).then(() => setIsLoading(false)).catch(e => console.error(e));
                
                return () => stopCamera();
            }, []);

             const startCamera = async (matcher, userData) => {
                setShowCamera(true);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                    streamRef.current = stream;
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        videoRef.current.onloadedmetadata = () => {
                            const video = videoRef.current;
                            const canvas = canvasRef.current;
                            const displaySize = { width: video.videoWidth, height: video.videoHeight };
                            faceapi.matchDimensions(canvas, displaySize);
                            
                            const interval = setInterval(async () => {
                                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                                if (detection) {
                                    const match = matcher.findBestMatch(detection.descriptor);
                                    if (match.label === userData.email) {
                                        clearInterval(interval);
                                        setUser(userData);
                                        stopCamera();
                                    }
                                }
                            }, 500);
                        };
                    }
                } catch (e) {
                    alert("Camera access denied");
                    setShowCamera(false);
                }
            };

            const stopCamera = () => {
                if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());
                setShowCamera(false);
            };

            const handleLogin = async () => {
                if (!email) return alert("Enter email");
                setLoginStatus("Verifying identity...");
                
                const { data: userData } = await supabaseClient.from('users').select('*').eq('email', email).single();
                
                if (!userData) {
                    if(email === SUPER_ADMIN_EMAIL) {
                        const secret = prompt("Enter Master Key:");
                        if(secret === ADMIN_SECRET) setUser({ name: 'Isara Dilnuka', email: SUPER_ADMIN_EMAIL });
                        return;
                    }
                    setLoginStatus("Access Denied: User not found.");
                    return;
                }

                if (!userData.approved && userData.email !== SUPER_ADMIN_EMAIL) {
                    setLoginStatus("Access Pending: Admin approval required.");
                    return;
                }

                if (userData.face_descriptors && userData.face_descriptors.length > 0) {
                    const descriptors = userData.face_descriptors.map(d => new Float32Array(d));
                    const matcher = new faceapi.FaceMatcher(new faceapi.LabeledFaceDescriptors(userData.email, descriptors), 0.5);
                    startCamera(matcher, userData);
                } else {
                     const secret = prompt("Enter Access Code:");
                     if(secret === ADMIN_SECRET) setUser(userData);
                }
            };

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <BackgroundEffects />
                        <div className="glass p-10 rounded-[2.5rem] w-full max-w-md text-center shadow-[0_30px_60px_rgba(0,0,0,0.8)] animate__animated animate__fadeIn border border-white/5 relative overflow-hidden bg-black/40">
                             <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 via-blue-500 to-emerald-500 animate-gradient-x"></div>
                             <div className="w-24 h-24 bg-gradient-to-br from-emerald-500/10 to-cyan-600/10 rounded-3xl mx-auto flex items-center justify-center mb-8 animate-float shadow-inner border border-emerald-500/30">
                                <Icons.Shield className="text-emerald-400" size={40} />
                            </div>
                            <h1 className="text-3xl font-bold text-white mb-2">Admin Portal</h1>
                            <p className="text-gray-400 mb-8 text-sm">Secure Biometric Login</p>
                            
                            <div className="space-y-4">
                                <div className="relative group">
                                    <div className="absolute inset-0 bg-gradient-to-r from-emerald-500 to-blue-500 rounded-xl blur opacity-25 group-hover:opacity-40 transition-opacity"></div>
                                    <input type="email" placeholder="Enter Admin Email" value={email} onChange={e => setEmail(e.target.value)} className="relative w-full p-4 bg-black/50 border border-white/10 rounded-xl text-white outline-none focus:border-emerald-500 transition-all placeholder-gray-600" />
                                </div>
                                <button onClick={handleLogin} disabled={isLoading} className="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl transition-all flex items-center justify-center gap-2 hover:scale-[1.02] shadow-[0_0_30px_rgba(16,185,129,0.3)] relative overflow-hidden group border border-emerald-400/20">
                                     <span className="relative z-10 flex items-center gap-2"><Icons.Camera size={18} /> Authenticate</span>
                                </button>
                                <p className="text-xs text-red-400 font-mono h-4 tracking-wide">{loginStatus}</p>
                            </div>
                             {showCamera && (
                                <div className="fixed inset-0 bg-black/95 z-50 flex items-center justify-center flex-col animate__animated animate__fadeIn backdrop-blur-md">
                                    <div className="relative border-2 border-emerald-500 rounded-3xl overflow-hidden shadow-[0_0_100px_rgba(16,185,129,0.3)]">
                                        <video ref={videoRef} autoPlay muted width="320" height="240" />
                                        <canvas ref={canvasRef} className="absolute inset-0" />
                                        <div className="absolute top-0 left-0 w-full h-1 bg-emerald-500 animate-scan"></div>
                                    </div>
                                    <p className="text-white mt-6 animate-pulse font-mono tracking-[0.2em] text-emerald-500 text-sm">SCANNING BIOMETRICS...</p>
                                    <button onClick={stopCamera} className="mt-8 px-8 py-2 bg-gray-800 text-white rounded-full hover:bg-gray-700 transition-colors border border-white/10 text-xs uppercase tracking-wider">Cancel Scan</button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex min-h-screen font-sans">
                    <BackgroundEffects />
                    <aside className="w-72 glass border-r border-white/5 flex flex-col hidden md:flex animate__animated animate__slideInLeft backdrop-blur-xl bg-black/20">
                        <div className="p-8 border-b border-white/5 flex items-center gap-4">
                            <div className="w-10 h-10 bg-gradient-to-br from-emerald-400 to-blue-500 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-emerald-500/20">DE</div>
                            <div>
                                <span className="font-bold text-white tracking-wide block">Admin Pro</span>
                                <span className="text-[10px] text-emerald-400 font-bold uppercase tracking-widest">Panel v2.0</span>
                            </div>
                        </div>
                        <nav className="flex-1 p-6 space-y-3">
                             {[
                                { id: 'dashboard', label: 'Dashboard', icon: Icons.LayoutDashboard },
                                { id: 'papers', label: 'Resource Manager', icon: Icons.FileText },
                                { id: 'settings', label: 'System Settings', icon: Icons.Settings },
                            ].map(item => (
                                <button key={item.id} onClick={() => setView(item.id)} className={`w-full flex items-center gap-4 px-5 py-4 rounded-xl text-sm font-medium transition-all duration-300 ${view === item.id ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 shadow-[0_0_20px_rgba(16,185,129,0.1)]' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}>
                                    <item.icon size={18} /> {item.label}
                                </button>
                            ))}
                             {user.email === SUPER_ADMIN_EMAIL && (
                                <button onClick={() => setView('users')} className={`w-full flex items-center gap-4 px-5 py-4 rounded-xl text-sm font-medium transition-all duration-300 ${view === 'users' ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'text-gray-400 hover:bg-white/5'}`}>
                                    <Icons.Users size={18} /> User Access
                                </button>
                            )}
                        </nav>
                        <div className="p-6 border-t border-white/5 bg-black/20">
                            <div className="flex items-center gap-3 mb-4">
                                <div className="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center text-white font-bold text-xs">{user.name.charAt(0)}</div>
                                <div className="overflow-hidden">
                                    <p className="text-white text-sm font-bold truncate">{user.name}</p>
                                    <p className="text-xs text-gray-500 truncate">{user.email}</p>
                                </div>
                            </div>
                            <button onClick={() => window.location.reload()} className="w-full py-2.5 bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2 border border-red-500/20 hover:border-red-500">
                                <Icons.LogOut size={14} /> SIGN OUT
                            </button>
                        </div>
                    </aside>
                    <main className="flex-1 p-8 overflow-y-auto custom-scrollbar">
                        {view === 'dashboard' && <DashboardStats />}
                        {view === 'papers' && <PapersManager />}
                        {view === 'settings' && (
                            <div className="space-y-8 animate__animated animate__fadeIn">
                                <h2 className="text-3xl font-bold text-white text-glow">System Settings</h2>
                                <MaintenanceControl />
                            </div>
                        )}
                        {view === 'users' && <UserApprovals />}
                    </main>
                </div>
            );
        };
        
        // --- CALENDAR WIDGET ---
        const CalendarWidget = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);

            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);
            const monthName = currentDate.toLocaleString('default', { month: 'long' });

            const changeMonth = (offset) => {
                setCurrentDate(new Date(year, month + offset, 1));
                setSelectedDate(null);
            };

            const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const blanks = Array.from({ length: firstDay }, (_, i) => i);

            return (
                <div className="glass rounded-[2.5rem] p-8 shadow-2xl max-w-md mx-auto mt-8 animate__animated animate__fadeInUp border border-white/10 bg-black/40">
                    <div className="flex justify-between items-center mb-8">
                        <button onClick={() => changeMonth(-1)} className="p-3 hover:bg-white/10 rounded-xl text-gray-400 hover:text-white transition-colors"><Icons.ChevronLeft size={20} /></button>
                        <h3 className="text-2xl font-bold text-white flex items-center gap-2">
                            <span className="text-emerald-400 text-glow">{monthName}</span> {year}
                        </h3>
                        <button onClick={() => changeMonth(1)} className="p-3 hover:bg-white/10 rounded-xl text-gray-400 hover:text-white transition-colors"><Icons.ChevronRight size={20} /></button>
                    </div>

                    <div className="grid grid-cols-7 gap-3 mb-4 text-center">
                        {['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].map(d => (
                            <span key={d} className="text-xs font-bold text-gray-500 uppercase tracking-wider">{d}</span>
                        ))}
                    </div>

                    <div className="grid grid-cols-7 gap-3">
                        {blanks.map((_, i) => <div key={`blank-${i}`} className="aspect-square" />)}
                        {days.map(day => {
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const holiday = SRI_LANKAN_HOLIDAYS_2025[dateStr];
                            const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();

                            return (
                                <div 
                                    key={day} 
                                    onClick={() => setSelectedDate(holiday ? dateStr : null)}
                                    className={`
                                        aspect-square rounded-2xl flex flex-col items-center justify-center relative cursor-pointer transition-all duration-300 hover:scale-110 border
                                        ${isToday ? 'bg-gradient-to-br from-emerald-500 to-teal-600 text-white shadow-lg shadow-emerald-500/30 border-transparent' : 'bg-white/5 hover:bg-white/10 text-gray-300 border-white/5'}
                                        ${holiday?.type === 'poya' ? 'border-yellow-500/50 bg-yellow-900/10' : ''}
                                        ${holiday?.type === 'public' ? 'border-red-500/50 bg-red-900/10' : ''}
                                    `}
                                >
                                    <span className="text-sm font-bold">{day}</span>
                                    {holiday && (
                                        <div className="absolute bottom-1.5 flex gap-0.5">
                                            {holiday.type === 'poya' ? (
                                                <div className="w-1.5 h-1.5 rounded-full bg-yellow-400 shadow-[0_0_5px_yellow]"></div>
                                            ) : (
                                                <div className={`w-1.5 h-1.5 rounded-full ${holiday.type === 'public' ? 'bg-red-500 shadow-[0_0_5px_red]' : 'bg-blue-400'}`} />
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    <div className="mt-8 pt-6 border-t border-white/5 min-h-[4rem] text-center bg-black/20 rounded-xl p-2">
                        {selectedDate && SRI_LANKAN_HOLIDAYS_2025[selectedDate] ? (
                            <div className="animate__animated animate__fadeIn">
                                <p className={`text-base font-bold mb-1 ${
                                    SRI_LANKAN_HOLIDAYS_2025[selectedDate].type === 'poya' ? 'text-yellow-400' : 'text-red-400'
                                }`}>
                                    {SRI_LANKAN_HOLIDAYS_2025[selectedDate].name}
                                </p>
                                <p className="text-xs text-gray-500 capitalize font-mono tracking-wide">{SRI_LANKAN_HOLIDAYS_2025[selectedDate].type} Holiday</p>
                            </div>
                        ) : (
                            <div className="flex justify-center gap-6 text-xs text-gray-500 h-full items-center">
                                <span className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-yellow-500 shadow-[0_0_5px_yellow]" /> Poya Day</span>
                                <span className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_5px_red]" /> Public Holiday</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- MAIN USER PAGE ---
        const MainPage = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            
            const [subjects, setSubjects] = useState([]);
            const [papers, setPapers] = useState([]);
            const [loading, setLoading] = useState(false);
            
            // Papers Tab State
            const [selectedStream, setSelectedStream] = useState(null);
            const [selectedSubject, setSelectedSubject] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [yearFilter, setYearFilter] = useState('all');
            const [viewMode, setViewMode] = useState('grid');
            
            // Other Data State
            const [notices, setNotices] = useState([]);
            const [examDates, setExamDates] = useState([]);
            const [sysUpdateMsg, setSysUpdateMsg] = useState(null);
            const [timetablePdf, setTimetablePdf] = useState(null);
            const [activeModal, setActiveModal] = useState(null);
            const [appLinks, setAppLinks] = useState([]);
            
            // AI Chat State
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [isChatLoading, setIsChatLoading] = useState(false);
            const [isThinking, setIsThinking] = useState(false);
            const [aiContext, setAiContext] = useState('');
            const chatEndRef = useRef(null);
            
            const [isScrolled, setIsScrolled] = useState(false);

            useEffect(() => {
                const handleScroll = () => setIsScrolled(window.scrollY > 20);
                window.addEventListener('scroll', handleScroll);
                loadInitialData();
                loadAIContext();
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [chatMessages, isChatLoading, isThinking]);
            
            const loadInitialData = async () => {
                const { data: updateData } = await supabaseClient.from('system_settings').select('value').eq('key', 'system_update').single();
                if(updateData?.value?.active) setSysUpdateMsg(updateData.value);

                const { data: ttData } = await supabaseClient.from('system_settings').select('value').eq('key', 'timetable_pdf').single();
                if(ttData?.value?.link) setTimetablePdf(ttData.value);

                const { data: noticeData } = await supabaseClient.from('notices').select('*').order('created_at', {ascending: false});
                if(noticeData) setNotices(noticeData);

                const { data: dateData } = await supabaseClient.from('exam_dates').select('*').order('date', {ascending: true});
                if(dateData) setExamDates(dateData);
                // Fetch Apps Data
                const { data: appsData } = await supabaseClient.from('app_downloads').select('*').order('created_at', {ascending: false});
                if(appsData) setAppLinks(appsData);
            };

             const loadAIContext = async () => {
                const { data: papers } = await supabaseClient.from('past_papers').select('year, subject_name, stream, type, subject_code');
                const paperText = papers && papers.length > 0 ? papers.map(p => `- ${p.year} ${p.stream} ${p.subject_name} (${p.type || 'Paper'})`).join('\n') : 'No papers listed currently.';

                const { data: notices } = await supabaseClient.from('notices').select('title, body, type, created_at').order('created_at', {ascending: false}).limit(5);
                const noticeText = notices && notices.length > 0 ? notices.map(n => `- [${new Date(n.created_at).toLocaleDateString()}] ${n.title}: ${n.body}`).join('\n') : 'No recent notices.';

                const { data: dates } = await supabaseClient.from('exam_dates').select('date, details, type').order('date', {ascending: true});
                const dateText = dates && dates.length > 0 ? dates.map(d => `- ${d.date}: ${d.details} (${d.type})`).join('\n') : 'No upcoming official events logged.';

                const fullContext = `
                === DATABASE SNAPSHOT ===
                [PAPERS]: ${paperText}
                [NOTICES]: ${noticeText}
                [DATES]: ${dateText}
                `;
                setAiContext(fullContext);
            };

            const loadSubjects = async (stream) => {
                setLoading(true);
                setSelectedStream(stream);
                const { data } = await supabaseClient.from('past_papers').select('subject_name, subject_code').eq('stream', stream);
                
                if (data) {
                     const uniqueMap = new Map();
                     data.forEach(item => {
                         if(!uniqueMap.has(item.subject_name)){
                             uniqueMap.set(item.subject_name, { name: item.subject_name, code: item.subject_code, stream: stream });
                         }
                     });
                     setSubjects(Array.from(uniqueMap.values()));
                }
                setLoading(false);
            };

            const loadPapers = async (subject) => {
                setLoading(true);
                setSelectedSubject(subject);
                const { data } = await supabaseClient.from('past_papers').select('*')
                    .eq('stream', subject.stream)
                    .eq('subject_name', subject.name)
                    .order('year', {ascending: false});
                if(data) setPapers(data);
                setLoading(false);
            };

            const handleDownload = async (paperId, type, subjectName) => {
                const countColumn = type === 'paper' ? 'paper_downloads' : 'marking_downloads';
                const { data: existing } = await supabaseClient.from('subject_download_stats').select('*').eq('subject_name', subjectName).maybeSingle();
                if (existing) {
                     await supabaseClient.from('subject_download_stats').update({ [countColumn]: (existing[countColumn] || 0) + 1 }).eq('subject_name', subjectName);
                } else {
                     await supabaseClient.from('subject_download_stats').insert({ subject_name: subjectName, [countColumn]: 1, [type === 'paper' ? 'marking_downloads' : 'paper_downloads']: 0 });
                }
            };
            
            // --- UPDATED AI CHAT HANDLER ---
            const handleChatSubmit = async (e) => {
                if (e && e.preventDefault) e.preventDefault();
                
                if (!chatInput.trim() || isChatLoading) return;

                // --- KEY VALIDATION ---
                if (!GEMINI_API_KEY) {
                    alert("System Error: API Key is missing.");
                    return;
                }

                const userMsg = chatInput;
                setChatInput('');
                setChatMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setIsChatLoading(true);
                setIsThinking(true);

                try {
                    // --- REVISED SYSTEM INSTRUCTION ---
                    const systemInstruction = `
                    You are 'DE education.lk', the official, intelligent, and motivating AI assistant of the DE Education platform in Sri Lanka.
                    Your primary mission is to help Sri Lankan A/L students with their studies, find past papers, and understand concepts.
                    
                    Available Real-time Resources:
                    ${aiContext}
                    
                    Directives:
                    1. ALWAYS identify yourself as "DE education.lk".
                    2. Be polite, encouraging, and use a professional yet friendly tone suitable for students.
                    3. If asked about papers/notices, strictly refer to the provided database. If not found, say so.
                    4. Keep answers concise but informative.
                    `;

                    // --- UPDATED API ENDPOINT (Using standard gemini-1.5-flash for stability with your key) ---
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [
                                ...chatMessages.map(m => ({ role: m.role, parts: [{ text: m.text }] })),
                                { role: 'user', parts: [{ text: userMsg }] }
                            ],
                            systemInstruction: { parts: [{ text: systemInstruction }] }
                        })
                    });

                    const result = await response.json();
                    setIsThinking(false);

                    if (result.candidates && result.candidates[0].content) {
                        const aiText = result.candidates[0].content.parts[0].text;
                        setChatMessages(prev => [...prev, { 
                            role: 'model', 
                            text: aiText
                        }]);
                    } else {
                        throw new Error("No response content");
                    }

                } catch (error) {
                    console.error(error);
                    setChatMessages(prev => [...prev, { role: 'model', text: "I apologize, but I'm having trouble connecting to the DE servers right now. Please try again in a moment." }]);
                } finally {
                    setIsChatLoading(false);
                    setIsThinking(false);
                }
            };

            const resetSelection = () => {
                setSelectedSubject(null);
                setPapers([]);
                setSearchQuery('');
            };

            const resetStream = () => {
                setSelectedStream(null);
                setSubjects([]);
                resetSelection();
            };

            const filteredPapers = papers.filter(p => {
                const matchesSearch = p.year.toString().includes(searchQuery) || (p.type && p.type.toLowerCase().includes(searchQuery.toLowerCase()));
                const matchesYear = yearFilter === 'all' || p.year.toString() === yearFilter;
                return matchesSearch && matchesYear;
            });
            
            const years = [...new Set(papers.map(p => p.year))].sort((a,b) => b-a);

            return (
                <div className="flex flex-col min-h-screen font-sans text-gray-200">
                    <BackgroundEffects />
                    
                    {/* NAVIGATION */}
                    <header className={`fixed w-full top-0 z-50 transition-all duration-500 ${isScrolled ? 'bg-black/80 backdrop-blur-xl border-b border-white/5 py-3 shadow-[0_10px_30px_rgba(0,0,0,0.8)]' : 'bg-transparent py-6'}`}>
                        <div className="container mx-auto px-6">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-4 group cursor-pointer" onClick={() => { setActiveTab('home'); resetStream(); }}>
                                    <div className="relative">
                                        <div className="absolute inset-0 bg-emerald-500 rounded-xl blur opacity-50 group-hover:opacity-100 transition-opacity animate-pulse-slow"></div>
                                        <div className="w-12 h-12 relative bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg border border-white/20 transition-transform duration-300 group-hover:rotate-12 group-hover:scale-105">DE</div>
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold text-white leading-none tracking-tight">DE Education<span className="text-emerald-500">.lk</span></h1>
                                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em] group-hover:text-emerald-400 transition-colors text-glow">Future Learning</p>
                                    </div>
                                </div>
                                <nav className="hidden md:flex items-center p-1.5 rounded-full bg-white/5 border border-white/5 backdrop-blur-md shadow-2xl glass">
                                    {['home', 'papers', 'results', 'timetables', 'ai-tutor', 'notices', 'apps'].map((tab) => (
                                        <button
                                            key={tab}
                                            onClick={() => { setActiveTab(tab); window.scrollTo(0,0); }}
                                            className={`px-6 py-2.5 rounded-full text-sm font-bold transition-all duration-300 relative overflow-hidden ${activeTab === tab ? 'text-white bg-white/10 border border-white/10 shadow-[0_0_20px_rgba(255,255,255,0.1)]' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}
                                        >
                                            {tab === 'ai-tutor' ? <span className="flex items-center gap-2 text-emerald-300"><Icons.Sparkles size={14} className="animate-pulse" /> AI Tutor</span> : tab.charAt(0).toUpperCase() + tab.slice(1)}
                                        </button>
                                    ))}
                                </nav>
                                <div className="flex items-center gap-3">
                                     <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="md:hidden p-3 bg-white/5 border border-white/10 rounded-xl text-gray-300 hover:bg-white/10 transition-colors active:scale-95 glass">
                                        {isMobileMenuOpen ? <Icons.X size={20} /> : <Icons.Menu size={20} />}
                                    </button>
                                </div>
                            </div>
                        </div>
                         {isMobileMenuOpen && (
                            <div className="md:hidden bg-black/95 backdrop-blur-xl border-b border-white/5 absolute w-full animate__animated animate__fadeInDown z-50">
                                {['home', 'papers', 'results', 'timetables', 'ai-tutor', 'notices', 'apps'].map((tab) => (
                                    <button
                                        key={tab}
                                        onClick={() => { setActiveTab(tab); setIsMobileMenuOpen(false); }}
                                        className={`block w-full text-left px-8 py-5 text-sm font-bold border-l-4 transition-all ${activeTab === tab ? 'border-emerald-500 bg-emerald-500/10 text-white' : 'border-transparent text-gray-400 hover:bg-white/5'}`}
                                    >
                                        {tab.toUpperCase().replace('-', ' ')}
                                    </button>
                                ))}
                            </div>
                        )}
                    </header>

                    <main className="flex-grow pt-28 md:pt-36 pb-20 container mx-auto px-4 z-10 relative">
                        {/* HOME TAB */}
                        {activeTab === 'home' && (
                            <div className="py-6 animate__animated animate__fadeIn">
                                <div className="w-full bg-[#0a0a0a] border border-white/10 rounded-3xl md:rounded-[3rem] p-8 md:p-16 mb-12 text-left relative overflow-hidden shadow-[0_0_50px_rgba(0,0,0,0.8)] animate__animated animate__zoomIn group glass">
                                    <div className="absolute top-0 right-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5"></div>
                                    <div className="absolute -top-32 -right-32 w-[500px] h-[500px] bg-emerald-600/10 rounded-full blur-[150px] group-hover:bg-emerald-500/20 transition-all duration-1000"></div>
                                    <div className="absolute -bottom-32 -left-32 w-[400px] h-[400px] bg-blue-600/10 rounded-full blur-[150px] group-hover:bg-blue-600/20 transition-all duration-1000"></div>
                                    
                                    <div className="relative z-10 max-w-3xl">
                                        <div className="inline-block px-5 py-2.5 rounded-full bg-emerald-500/5 border border-emerald-500/20 text-emerald-400 font-bold text-xs uppercase tracking-widest mb-8 backdrop-blur-md animate__animated animate__fadeInDown">
                                            🚀 The Future of Education is Here
                                        </div>
                                        <h2 className="text-4xl md:text-7xl font-extrabold text-white mb-8 leading-tight tracking-tight">
                                            Shape Your <br/>
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-emerald-300 via-teal-200 to-cyan-300 text-glow">Future Today</span>
                                        </h2>
                                        <p className="text-gray-400 text-base md:text-xl max-w-xl mb-12 leading-relaxed font-light">
                                            Access Sri Lanka's largest free database of A/L Past Papers, Marking Schemes, and let our <span className="text-emerald-400 font-bold border-b border-emerald-500/30 pb-0.5">AI Tutor</span> guide you to success.
                                        </p>
                                        <div className="flex flex-wrap gap-5">
                                            <button onClick={() => setActiveTab('papers')} className="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 px-10 rounded-2xl transition-all shadow-[0_0_30px_rgba(16,185,129,0.3)] transform hover:-translate-y-1 hover:scale-105 active:scale-95 flex items-center gap-3 border-t border-white/20 w-full md:w-auto justify-center">
                                                <span>Start Learning</span> <Icons.ArrowLeft size={16} className="rotate-180" />
                                            </button>
                                            <button onClick={() => setActiveTab('ai-tutor')} className="bg-white/5 hover:bg-white/10 text-white font-bold py-4 px-10 rounded-2xl transition-all border border-white/10 backdrop-blur-md flex items-center gap-3 group-btn glass-hover w-full md:w-auto justify-center">
                                                <Icons.Sparkles size={16} className="text-yellow-300 group-btn-hover:animate-spin" /> <span>Ask AI Tutor</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {sysUpdateMsg && (
                                    <div className="max-w-3xl mx-auto mb-16 bg-gradient-to-r from-amber-500/10 to-transparent border border-amber-500/20 rounded-2xl p-1 animate__animated animate__fadeInUp backdrop-blur-md">
                                        <div className="w-full h-full rounded-xl p-5 flex items-start md:items-center gap-5">
                                            <div className="bg-amber-500/10 p-3 rounded-xl text-amber-500 animate-pulse border border-amber-500/20"><Icons.Bell size={24}/></div>
                                            <div>
                                                <h4 className="font-bold text-amber-500 text-xs uppercase tracking-wider mb-1">System Announcement</h4>
                                                <p className="text-sm text-gray-300 font-medium">{sysUpdateMsg.message}</p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 animate__animated animate__fadeInUp animate__delay-1s">
                                    {[
                                        { id: 'papers', icon: Icons.BookOpen, color: 'blue', label: 'Past Papers', desc: 'Complete Archive 2010-2024' },
                                        { id: 'results', icon: Icons.Award, color: 'emerald', label: 'Exam Results', desc: 'Instant Verification' },
                                        { id: 'timetables', icon: Icons.Calendar, color: 'purple', label: 'Schedules', desc: '2025 Exam Calendar' },
                                        { id: 'ai-tutor', icon: Icons.Bot, color: 'pink', label: 'AI Assistant', desc: '24/7 Study Support' }
                                    ].map((item, index) => (
                                        <div 
                                            key={item.id}
                                            onClick={() => setActiveTab(item.id)}
                                            style={{ animationDelay: `${index * 100}ms` }}
                                            className={`glass p-8 rounded-3xl md:rounded-[2.5rem] cursor-pointer group relative overflow-hidden transition-all duration-300 hover:bg-white/5 hover:border-${item.color}-500/30 hover:shadow-[0_20px_60px_rgba(0,0,0,0.5)]`}
                                        >
                                            <div className={`absolute -right-12 -top-12 w-40 h-40 bg-${item.color}-500/10 rounded-full blur-[60px] group-hover:bg-${item.color}-500/20 transition-all duration-500`}></div>
                                            
                                            <div className={`w-16 h-16 rounded-2xl bg-${item.color}-500/10 border border-${item.color}-500/20 flex items-center justify-center text-${item.color}-400 mb-8 group-hover:scale-110 group-hover:bg-${item.color}-500 group-hover:text-white transition-all duration-300 shadow-lg`}>
                                                <item.icon size={28} />
                                            </div>
                                            <h3 className="text-2xl font-bold text-white mb-2 group-hover:translate-x-1 transition-transform">{item.label}</h3>
                                            <p className="text-sm text-gray-500 group-hover:text-gray-300 transition-colors font-medium">{item.desc}</p>
                                            
                                            <div className={`absolute bottom-8 right-8 opacity-0 group-hover:opacity-100 transition-all transform translate-x-4 group-hover:translate-x-0 text-${item.color}-500`}>
                                                <Icons.ArrowLeft size={20} className="rotate-180" />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* PAPERS TAB */}
                        {activeTab === 'papers' && (
                            <div className="animate__animated animate__fadeIn">
                                {!selectedStream ? (
                                    <div className="max-w-7xl mx-auto">
                                        <div className="text-center mb-16 animate__animated animate__fadeInDown">
                                            <h2 className="text-4xl md:text-5xl font-bold text-white mb-6">Select Your Stream</h2>
                                            <p className="text-gray-400 text-lg">Browse our extensive library of past papers by subject stream.</p>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                                            {[
                                                { id: 'science', color: 'blue', icon: 'microscope', label: 'Physical Science' },
                                                { id: 'commerce', color: 'emerald', icon: 'chart-line', label: 'Commerce' },
                                                { id: 'arts', color: 'amber', icon: 'palette', label: 'Arts' },
                                                { id: 'technology', color: 'violet', icon: 'microchip', label: 'Technology' }
                                            ].map((stream, index) => (
                                                <div 
                                                    key={stream.id} 
                                                    onClick={() => loadSubjects(stream.id)}
                                                    style={{ animationDelay: `${index * 100}ms` }}
                                                    className={`glass p-10 rounded-3xl md:rounded-[2.5rem] cursor-pointer hover:border-${stream.color}-500/30 hover:bg-white/5 group relative overflow-hidden transition-all duration-500 hover:-translate-y-3 hover:shadow-[0_30px_60px_rgba(0,0,0,0.6)] animate__animated animate__fadeInUp`}
                                                >
                                                    <div className={`absolute -right-8 -bottom-8 opacity-5 group-hover:opacity-20 transition-all duration-500 transform group-hover:scale-125 group-hover:rotate-12`}>
                                                         <i className={`fas fa-${stream.icon} text-9xl`}></i>
                                                    </div>
                                                    <div className={`w-20 h-20 bg-gradient-to-br from-${stream.color}-500/10 to-transparent rounded-3xl flex items-center justify-center mb-10 text-${stream.color}-400 group-hover:bg-${stream.color}-500 group-hover:text-white transition-all duration-500 shadow-xl border border-${stream.color}-500/20`}>
                                                        <i className={`fas fa-${stream.icon} text-3xl`}></i>
                                                    </div>
                                                    <h4 className="text-2xl font-bold text-white mb-2">{stream.label}</h4>
                                                    <div className="flex items-center gap-2 text-sm text-gray-500 group-hover:text-${stream.color}-400 transition-colors">
                                                        <span>View Subjects</span> <Icons.ArrowLeft size={12} className="rotate-180" />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : !selectedSubject ? (
                                    <div className="max-w-7xl mx-auto animate__animated animate__fadeIn">
                                        <button onClick={resetStream} className="flex items-center gap-3 text-gray-400 hover:text-white mb-10 transition-colors group px-5 py-2 rounded-full hover:bg-white/5 w-fit border border-transparent hover:border-white/10 glass-hover">
                                            <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-emerald-500 group-hover:text-white transition-all"><Icons.ArrowLeft size={14} /></div>
                                            <span className="text-sm font-bold uppercase tracking-wide">Back to Streams</span>
                                        </button>
                                        
                                        <h2 className="text-4xl font-bold text-white mb-10 flex items-center gap-4">
                                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400 capitalize">{selectedStream}</span>
                                            <span className="text-gray-700 text-2xl">/</span>
                                            <span className="text-gray-200">Subjects</span>
                                        </h2>

                                        {loading ? (
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                                                {[1,2,3,4].map(i => <div key={i} className="h-32 bg-white/5 rounded-3xl animate-pulse border border-white/5"></div>)}
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                                {subjects.map((sub, idx) => (
                                                    <div 
                                                        key={idx}
                                                        onClick={() => loadPapers(sub)}
                                                        style={{ animationDelay: `${idx * 50}ms` }}
                                                        className="group relative p-8 glass rounded-[2rem] cursor-pointer hover:bg-white/10 transition-all duration-300 hover:-translate-y-2 hover:shadow-[0_20px_50px_rgba(0,0,0,0.5)] overflow-hidden animate__animated animate__fadeInUp"
                                                    >
                                                        {/* Hover Gradient Background */}
                                                        <div className="absolute inset-0 bg-gradient-to-br from-emerald-500/0 via-transparent to-blue-500/0 group-hover:from-emerald-500/10 group-hover:to-blue-500/10 transition-all duration-500"></div>
                                                        
                                                        <div className="relative z-10 flex flex-col h-full">
                                                            <div className="flex justify-between items-start mb-6">
                                                                <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-white/5 to-white/0 border border-white/10 flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-inner group-hover:border-emerald-500/30">
                                                                    <Icons.BookOpen className="text-emerald-400" size={24} />
                                                                </div>
                                                                {sub.code && (
                                                                    <span className="px-3 py-1 rounded-full bg-black/40 border border-white/10 text-[10px] font-mono text-gray-400 group-hover:text-emerald-300 transition-colors tracking-wider shadow-sm">
                                                                        {sub.code}
                                                                    </span>
                                                                )}
                                                            </div>
                                                            
                                                            <h3 className="text-xl font-bold text-gray-100 group-hover:text-white mb-2 line-clamp-2 leading-tight">
                                                                {sub.name}
                                                            </h3>
                                                            
                                                            <div className="mt-auto pt-4 flex items-center justify-between border-t border-white/5">
                                                                <span className="text-xs text-gray-500 group-hover:text-gray-400 font-medium">View Resources</span>
                                                                <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-400 group-hover:bg-emerald-500 group-hover:text-white transition-all transform group-hover:translate-x-1">
                                                                    <Icons.ChevronRight size={14} />
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                                {subjects.length === 0 && <p className="text-gray-500 col-span-full text-center py-20 glass rounded-3xl">No subjects found for this stream.</p>}
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="max-w-7xl mx-auto animate__animated animate__fadeIn pb-20">
                                        <div className="glass sticky top-24 z-30 p-5 mb-10 rounded-2xl shadow-2xl flex flex-col md:flex-row gap-4 justify-between md:items-center bg-black/60 border border-white/10">
                                            <div className="flex items-center gap-5">
                                                <button onClick={resetSelection} className="w-12 h-12 flex items-center justify-center bg-white/5 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition-colors border border-white/5"><Icons.ArrowLeft size={20}/></button>
                                                <div>
                                                    <h3 className="text-2xl font-bold text-white">{selectedSubject.name}</h3>
                                                    <p className="text-[10px] text-emerald-400 font-bold uppercase tracking-widest mt-1">Past Papers Archive</p>
                                                </div>
                                            </div>
                                            
                                            <div className="flex items-center gap-4">
                                                <div className="flex bg-black/40 p-1.5 rounded-xl border border-white/10">
                                                    <button onClick={() => setViewMode('grid')} className={`p-2.5 rounded-lg transition-all ${viewMode === 'grid' ? 'bg-emerald-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}><Icons.Grid size={18}/></button>
                                                    <button onClick={() => setViewMode('list')} className={`p-2.5 rounded-lg transition-all ${viewMode === 'list' ? 'bg-emerald-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}><Icons.List size={18}/></button>
                                                </div>

                                                <div className="relative">
                                                    <select 
                                                        value={yearFilter}
                                                        onChange={(e) => setYearFilter(e.target.value)}
                                                        className="pl-5 pr-12 py-3 bg-black/40 border border-white/10 rounded-xl text-sm text-white focus:border-emerald-500 outline-none appearance-none cursor-pointer hover:bg-black/60 transition-colors"
                                                    >
                                                        <option value="all">All Years</option>
                                                        {years.map(y => <option key={y} value={y}>{y}</option>)}
                                                    </select>
                                                    <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400"><Icons.ChevronLeft size={12} className="-rotate-90"/></div>
                                                </div>
                                            </div>
                                        </div>

                                        {loading ? (
                                             <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                 {[1,2,3,4,5,6].map(i => <div key={i} className="h-48 bg-white/5 rounded-[2rem] animate-pulse border border-white/5"></div>)}
                                             </div>
                                        ) : (
                                            <div className={viewMode === 'grid' ? "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" : "flex flex-col gap-4"}>
                                                {filteredPapers.map((p, idx) => (
                                                    <div 
                                                        key={p.id} 
                                                        style={{ animationDelay: `${idx * 50}ms` }} 
                                                        className={`
                                                            glass border border-white/5 rounded-[2rem] hover:border-emerald-500/30 transition-all group animate__animated animate__fadeInUp overflow-hidden relative
                                                            ${viewMode === 'grid' ? 'p-8 hover:-translate-y-2 hover:shadow-[0_20px_50px_rgba(0,0,0,0.6)]' : 'p-6 flex items-center justify-between hover:bg-white/5'}
                                                        `}
                                                    >
                                                        <div className={`absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-emerald-500/5 to-transparent rounded-bl-full transition-all group-hover:scale-150 group-hover:from-emerald-500/10`}></div>
                                                        
                                                        <div className={viewMode === 'grid' ? 'mb-8 relative z-10' : 'flex items-center gap-6 relative z-10'}>
                                                            <div className={`flex flex-col items-center justify-center w-16 h-16 rounded-2xl bg-black/40 border border-white/10 shadow-inner ${viewMode === 'grid' ? 'mb-4' : ''}`}>
                                                                <span className="text-xl font-bold text-white">{p.year}</span>
                                                                <span className="text-[10px] text-gray-500 uppercase font-bold">A/L</span>
                                                            </div>
                                                            <div>
                                                                <h4 className="font-bold text-white text-lg">General Examination</h4>
                                                                {viewMode === 'grid' && <p className="text-xs text-gray-500 mt-1">Resources for {p.subject_name}</p>}
                                                            </div>
                                                        </div>
                                                        
                                                        <div className={`flex gap-3 relative z-10 ${viewMode === 'grid' ? 'mt-auto' : ''}`}>
                                                            {p.paper_link && (
                                                                <a 
                                                                    href={p.paper_link} 
                                                                    target="_blank" 
                                                                    rel="noreferrer"
                                                                    onClick={() => handleDownload(p.id, 'paper', p.subject_name)}
                                                                    className={`
                                                                        flex items-center justify-center gap-2 rounded-xl font-bold transition-all border
                                                                        ${viewMode === 'grid' ? 'flex-1 py-3 text-sm bg-blue-600/10 text-blue-400 border-blue-500/20 hover:bg-blue-600 hover:text-white hover:border-blue-500 hover:scale-105 shadow-lg shadow-blue-900/10' : 'px-5 py-2.5 text-xs bg-white/5 text-gray-300 border-white/10 hover:border-blue-500 hover:text-blue-400'}
                                                                    `}
                                                                >
                                                                    <Icons.FileText size={16} /> {viewMode === 'grid' && "Paper"}
                                                                </a>
                                                            )}
                                                            {p.marking_scheme_link && (
                                                                <a 
                                                                    href={p.marking_scheme_link} 
                                                                    target="_blank" 
                                                                    rel="noreferrer"
                                                                    onClick={() => handleDownload(p.id, 'marking', p.subject_name)}
                                                                    className={`
                                                                        flex items-center justify-center gap-2 rounded-xl font-bold transition-all border
                                                                        ${viewMode === 'grid' ? 'flex-1 py-3 text-sm bg-emerald-600/10 text-emerald-400 border-emerald-500/20 hover:bg-emerald-600 hover:text-white hover:border-emerald-500 hover:scale-105 shadow-lg shadow-emerald-900/10' : 'px-5 py-2.5 text-xs bg-white/5 text-gray-300 border-white/10 hover:border-emerald-500 hover:text-emerald-400'}
                                                                    `}
                                                                >
                                                                    <Icons.Shield size={16} /> {viewMode === 'grid' && "Marking"}
                                                                </a>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                                {filteredPapers.length === 0 && (
                                                    <div className="col-span-full py-24 text-center animate__animated animate__fadeIn glass rounded-3xl">
                                                        <div className="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-6 text-gray-600 border border-white/5">
                                                            <Icons.FileText size={40} />
                                                        </div>
                                                        <p className="text-gray-400 font-bold text-xl">No resources found</p>
                                                        <p className="text-sm text-gray-600 mt-2">Try adjusting your filters.</p>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        
                                        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 w-full max-w-md px-4 z-40 animate__animated animate__fadeInUp">
                                            <div className="glass backdrop-blur-2xl border border-emerald-500/30 rounded-full shadow-[0_10px_40px_rgba(0,0,0,0.8)] p-2 flex items-center ring-1 ring-white/10 transform hover:scale-105 transition-transform duration-300 bg-black/60">
                                                <div className="pl-4 text-emerald-500"><Icons.Search size={20} /></div>
                                                <input 
                                                    type="text" 
                                                    placeholder="Quick Search Papers..." 
                                                    value={searchQuery}
                                                    onChange={(e) => setSearchQuery(e.target.value)}
                                                    className="bg-transparent border-none text-white text-sm w-full px-4 py-2 focus:outline-none placeholder-gray-500"
                                                />
                                                {searchQuery && (
                                                    <button onClick={() => setSearchQuery('')} className="p-2 rounded-full bg-white/10 text-gray-400 hover:text-white mr-1 transition-colors"><Icons.X size={16}/></button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {/* RESULTS TAB */}
                        {activeTab === 'results' && (
                            <div className="max-w-3xl mx-auto text-center py-16 animate__animated animate__fadeIn">
                                <div className="w-32 h-32 bg-gradient-to-br from-emerald-500/10 to-cyan-500/10 rounded-[2.5rem] flex items-center justify-center mx-auto mb-10 text-white shadow-[0_0_60px_rgba(16,185,129,0.2)] animate-float border border-white/10 glass">
                                    <Icons.Award size={64} className="text-emerald-400" />
                                </div>
                                <h2 className="text-4xl md:text-5xl font-extrabold text-white mb-6 text-glow">Examination Results</h2>
                                <p className="text-gray-400 mb-12 text-lg">Access the official Department of Examinations portal directly.</p>
                                
                                <a href="https://www.doenets.lk/examresults" target="_blank" rel="noreferrer" className="block glass p-10 rounded-[2.5rem] hover:border-emerald-500/50 transition-all group hover:scale-[1.02] hover:shadow-[0_20px_60px_rgba(16,185,129,0.2)] relative overflow-hidden bg-black/40">
                                    <div className="absolute inset-0 bg-gradient-to-r from-emerald-600/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                    <div className="flex items-center justify-between relative z-10">
                                        <div className="text-left flex items-center gap-6">
                                            <div className="w-16 h-16 rounded-2xl bg-emerald-500/10 flex items-center justify-center text-emerald-400 border border-emerald-500/20">
                                                <Icons.Shield size={32} />
                                            </div>
                                            <div>
                                                <h4 className="text-2xl font-bold text-white group-hover:text-emerald-400 transition-colors">G.C.E. A/L Results</h4>
                                                <p className="text-sm text-gray-500 mt-1">Official Government Source</p>
                                            </div>
                                        </div>
                                        <div className="w-12 h-12 rounded-full bg-white/5 group-hover:bg-emerald-500 group-hover:text-white transition-all flex items-center justify-center border border-white/5">
                                            <Icons.ExternalLink size={20} />
                                        </div>
                                    </div>
                                </a>
                            </div>
                        )}

                        {/* TIMETABLES TAB */}
                        {activeTab === 'timetables' && (
                            <div className="max-w-6xl mx-auto animate__animated animate__fadeIn">
                                <div className="text-center mb-16">
                                    <h2 className="text-4xl font-bold text-white mb-4 text-glow">Exam Schedules & Calendar</h2>
                                    <p className="text-gray-400 mb-10">Stay organized with key dates and deadlines.</p>
                                    
                                    {timetablePdf && (
                                        <a href={timetablePdf.link} target="_blank" rel="noreferrer" className="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-emerald-600 to-teal-500 text-white rounded-2xl font-bold transition-all shadow-[0_0_30px_rgba(16,185,129,0.3)] hover:-translate-y-1 hover:scale-105 border border-emerald-500/20">
                                            <Icons.Download size={20} /> <span>Download Official Time Table ({timetablePdf.year})</span>
                                        </a>
                                    )}
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
                                    <div className="glass rounded-[2.5rem] p-10 border border-white/10 bg-black/40">
                                        <h3 className="text-2xl font-bold text-white mb-8 flex items-center gap-3">
                                            <div className="p-2 rounded-lg bg-purple-500/10 text-purple-400 border border-purple-500/20"><Icons.Calendar size={20}/></div>
                                            Upcoming Events
                                        </h3>
                                        <div className="space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                                            {examDates.length > 0 ? examDates.map((date, idx) => (
                                                <div key={date.id} style={{ animationDelay: `${idx * 100}ms` }} className="flex items-center gap-5 p-5 bg-white/5 rounded-2xl border border-white/5 hover:border-white/10 transition-all animate__animated animate__fadeInUp hover:bg-white/10 group">
                                                    <div className={`flex flex-col items-center justify-center w-16 h-16 rounded-2xl text-white shadow-inner border border-white/5 ${date.type === 'Exam' ? 'bg-emerald-900/20 text-emerald-400' : 'bg-red-900/20 text-red-400'}`}>
                                                        <span className="text-[10px] font-bold uppercase tracking-widest opacity-70">{new Date(date.date).toLocaleString('default', {month: 'short'})}</span>
                                                        <span className="text-2xl font-bold leading-none mt-1">{new Date(date.date).getDate()}</span>
                                                    </div>
                                                    <div>
                                                        <h4 className="font-bold text-gray-100 text-lg group-hover:text-emerald-400 transition-colors">{date.details}</h4>
                                                        <div className="flex items-center gap-3 mt-2">
                                                             <span className={`text-[10px] px-2.5 py-1 rounded-full font-bold uppercase tracking-wide border ${date.type === 'Exam' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20'}`}>{date.type}</span>
                                                             <span className="text-xs text-gray-500 font-mono">{new Date(date.date).getFullYear()}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )) : <div className="text-center text-gray-500 py-20 bg-white/5 rounded-2xl border border-white/5 border-dashed">No scheduled events found.</div>}
                                        </div>
                                    </div>
                                    <div><CalendarWidget /></div>
                                </div>
                            </div>
                        )}
                        
                        {/* AI TUTOR TAB */}
                        {activeTab === 'ai-tutor' && (
                            <div className="max-w-5xl mx-auto h-[calc(100vh-180px)] flex flex-col animate__animated animate__fadeIn">
                                <div className="text-center mb-6">
                                     <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-gradient-to-r from-pink-500/10 to-purple-500/10 border border-pink-500/20 text-pink-400 text-xs font-bold uppercase tracking-widest mb-3 backdrop-blur-md shadow-[0_0_15px_rgba(236,72,153,0.2)] glass">
                                        <Icons.Sparkles size={12} className="animate-pulse" /> DE education.lk AI
                                    </div>
                                    <h2 className="text-3xl font-bold text-white text-glow">Your Personal Study Companion</h2>
                                    <p className="text-gray-500 text-sm mt-1">Powered by Google Gemini | Ask about papers, concepts, or advice.</p>
                                </div>

                                <div className="flex-1 glass rounded-[2.5rem] p-6 md:p-8 mb-6 overflow-y-auto custom-scrollbar flex flex-col gap-6 relative border border-white/10 bg-black/40 shadow-2xl">
                                    {chatMessages.length === 0 && (
                                        <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-500 p-8 text-center opacity-60">
                                            <div className="w-24 h-24 bg-emerald-500/5 rounded-full flex items-center justify-center mb-6 animate-pulse-slow border border-emerald-500/10">
                                                <Icons.Bot size={48} className="text-emerald-500/50" />
                                            </div>
                                            <p className="text-lg text-gray-400 font-medium">Hello! I'm <span className="text-emerald-400">DE education.lk</span>.</p>
                                            <p className="text-sm mt-2 max-w-sm">I can help you find past papers, explain difficult A/L concepts, or give study tips. Just ask!</p>
                                        </div>
                                    )}
                                    
                                    {chatMessages.map((msg, i) => (
                                        <div key={i} className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'} gap-2 animate__animated animate__fadeInUp`}>
                                            <div className={`max-w-[85%] md:max-w-[75%] p-5 rounded-3xl text-sm md:text-base leading-relaxed shadow-lg backdrop-blur-md border ${
                                                msg.role === 'user' 
                                                ? 'bg-gradient-to-br from-emerald-600 to-teal-700 text-white rounded-tr-sm border-white/10' 
                                                : 'glass bg-white/5 border-white/10 text-gray-200 rounded-tl-sm'
                                            }`}>
                                                {msg.role === 'model' && (
                                                    <div className="text-[10px] text-emerald-400 font-bold uppercase mb-3 flex items-center gap-2 border-b border-white/5 pb-2 tracking-wider">
                                                        <Icons.Bot size={12}/> DE education.lk
                                                    </div>
                                                )}
                                                <div className="whitespace-pre-wrap">{msg.text}</div>
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {isThinking && (
                                        <div className="flex justify-start animate__animated animate__fadeIn">
                                            <div className="glass bg-white/5 border border-white/10 p-4 rounded-3xl rounded-tl-sm flex items-center gap-3 text-sm text-pink-400 backdrop-blur-md shadow-lg">
                                                <div className="flex gap-1">
                                                    <div className="w-2 h-2 bg-pink-500 rounded-full animate-bounce"></div>
                                                    <div className="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                                    <div className="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                                </div>
                                                <span className="text-xs font-bold uppercase tracking-wide text-gray-400">Processing...</span>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div ref={chatEndRef} />
                                </div>

                                <form onSubmit={handleChatSubmit} className="relative group">
                                    <div className="absolute inset-0 bg-gradient-to-r from-emerald-500 to-blue-500 rounded-3xl blur opacity-20 group-hover:opacity-30 transition-opacity"></div>
                                    <input 
                                        type="text" 
                                        value={chatInput}
                                        onChange={(e) => setChatInput(e.target.value)}
                                        placeholder="Type your question here..." 
                                        className="relative w-full bg-black/80 border border-white/10 rounded-3xl py-5 pl-6 pr-16 text-white focus:border-emerald-500 focus:outline-none transition-all placeholder-gray-600 shadow-2xl glass"
                                        disabled={isChatLoading || isThinking}
                                    />
                                    <button 
                                        type="submit" 
                                        disabled={!chatInput.trim() || isChatLoading || isThinking}
                                        className="absolute right-3 top-3 z-10 p-2.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-2xl transition-all disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 active:scale-95 shadow-lg shadow-emerald-900/30"
                                    >
                                        <Icons.Send size={20} />
                                    </button>
                                </form>
                            </div>
                        )}

                        {/* NOTICES TAB */}
                        {activeTab === 'notices' && (
                            <div className="max-w-4xl mx-auto animate__animated animate__fadeIn">
                                 <h2 className="text-4xl font-bold text-white mb-12 text-center text-glow">Announcements</h2>
                                 <div className="grid gap-8">
                                    {notices.length > 0 ? notices.map((n, idx) => (
                                        <div key={n.id} style={{ animationDelay: `${idx * 150}ms` }} className={`glass p-8 rounded-[2rem] border border-white/5 relative overflow-hidden group hover:-translate-y-2 transition-all duration-300 animate__animated animate__fadeInUp bg-black/40 hover:bg-black/60`}>
                                            <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${n.type === 'important' ? 'bg-red-500 shadow-[0_0_15px_red]' : n.type === 'opportunity' ? 'bg-emerald-500 shadow-[0_0_15px_#10b981]' : 'bg-blue-500 shadow-[0_0_15px_#3b82f6]'}`}></div>
                                            <div className="flex justify-between items-start mb-6 pl-4">
                                                <h3 className="font-bold text-white text-2xl group-hover:text-emerald-400 transition-colors">{n.title}</h3>
                                                <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest bg-black/40 px-3 py-1.5 rounded-lg border border-white/5 shadow-inner">{new Date(n.created_at).toLocaleDateString()}</span>
                                            </div>
                                            <p className="text-gray-400 text-base leading-relaxed pl-4 whitespace-pre-wrap font-light">{n.body}</p>
                                        </div>
                                    )) : <div className="text-center text-gray-500 py-24 glass rounded-3xl border-dashed border border-white/10">No notices posted yet.</div>}
                                 </div>
                            </div>
                        )}
                        {/* NEW: APPS TAB */}
{activeTab === 'apps' && (
    <div className="max-w-6xl mx-auto animate__animated animate__fadeIn">
        <div className="text-center mb-16">
            <h2 className="text-3xl md:text-5xl font-bold text-white mb-6 text-glow">Download Our Apps</h2>
            <p className="text-gray-400 text-base md:text-lg max-w-2xl mx-auto">
                Get the best experience with our dedicated applications for Android and Windows.
                <br className="hidden md:block"/>Faster access, offline capabilities, and better performance.
            </p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-10 px-4 mb-16">
            {/* ANDROID CARD */}
            <div className="glass p-6 md:p-10 rounded-3xl md:rounded-[3rem] border border-white/10 hover:border-emerald-500/50 transition-all duration-500 group relative overflow-hidden bg-black/40 hover:-translate-y-2 hover:shadow-[0_20px_60px_rgba(16,185,129,0.15)]">
                <div className="absolute top-0 right-0 w-64 h-64 bg-emerald-500/10 rounded-bl-full -mr-16 -mt-16 transition-transform group-hover:scale-110 blur-3xl"></div>
                
                <div className="relative z-10 flex flex-col items-center text-center h-full">
                    <div className="w-20 h-20 md:w-24 md:h-24 bg-gradient-to-br from-emerald-500/20 to-teal-500/20 rounded-3xl flex items-center justify-center text-emerald-400 mb-8 border border-emerald-500/30 shadow-lg group-hover:scale-110 transition-transform">
                        <i className="fab fa-android text-4xl md:text-5xl"></i>
                    </div>
                    
                    <h3 className="text-2xl md:text-3xl font-bold text-white mb-2">Android App</h3>
                    <p className="text-gray-500 mb-8 font-medium">For Mobile & Tablets</p>

                    {appLinks.find(a => a.platform === 'android') ? (
                        <div className="mt-auto w-full space-y-4">
                            <div className="inline-block px-4 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-xs font-mono mb-2">
                                Version: {appLinks.find(a => a.platform === 'android').version}
                            </div>
                            <a href={appLinks.find(a => a.platform === 'android').download_link} target="_blank" className="w-full py-4 bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white rounded-2xl font-bold text-lg flex items-center justify-center gap-3 transition-all shadow-lg shadow-emerald-900/40 hover:scale-[1.02]">
                                <Icons.Download size={24} /> Download APK
                            </a>
                        </div>
                    ) : (
                        <div className="mt-auto w-full py-4 bg-white/5 text-gray-500 rounded-2xl font-bold border border-dashed border-white/10 cursor-not-allowed">
                            Coming Soon
                        </div>
                    )}
                </div>
            </div>

            {/* PC CARD */}
            <div className="glass p-6 md:p-10 rounded-3xl md:rounded-[3rem] border border-white/10 hover:border-blue-500/50 transition-all duration-500 group relative overflow-hidden bg-black/40 hover:-translate-y-2 hover:shadow-[0_20px_60px_rgba(59,130,246,0.15)]">
                <div className="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-bl-full -mr-16 -mt-16 transition-transform group-hover:scale-110 blur-3xl"></div>
                
                <div className="relative z-10 flex flex-col items-center text-center h-full">
                    <div className="w-20 h-20 md:w-24 md:h-24 bg-gradient-to-br from-blue-500/20 to-indigo-500/20 rounded-3xl flex items-center justify-center text-blue-400 mb-8 border border-blue-500/30 shadow-lg group-hover:scale-110 transition-transform">
                        <i className="fab fa-windows text-4xl md:text-5xl"></i>
                    </div>
                    
                    <h3 className="text-2xl md:text-3xl font-bold text-white mb-2">Desktop App</h3>
                    <p className="text-gray-500 mb-8 font-medium">For Windows PC / Laptop</p>

                    {appLinks.find(a => a.platform === 'pc') ? (
                        <div className="mt-auto w-full space-y-4">
                            <div className="inline-block px-4 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-xs font-mono mb-2">
                                Version: {appLinks.find(a => a.platform === 'pc').version}
                            </div>
                            <a href={appLinks.find(a => a.platform === 'pc').download_link} target="_blank" className="w-full py-4 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white rounded-2xl font-bold text-lg flex items-center justify-center gap-3 transition-all shadow-lg shadow-blue-900/40 hover:scale-[1.02]">
                                <Icons.Download size={24} /> Download EXE
                            </a>
                        </div>
                    ) : (
                        <div className="mt-auto w-full py-4 bg-white/5 text-gray-500 rounded-2xl font-bold border border-dashed border-white/10 cursor-not-allowed">
                            Coming Soon
                        </div>
                    )}
                </div>
            </div>
        </div>
        
        <div className="glass p-6 md:p-8 rounded-[2rem] border border-white/5 flex flex-col md:flex-row items-center justify-between gap-6 max-w-4xl mx-auto">
            <div className="flex items-center gap-6">
                <div className="w-16 h-16 rounded-2xl bg-purple-500/10 flex items-center justify-center text-purple-400 border border-purple-500/20">
                    <Icons.Shield size={30} />
                </div>
                <div>
                    <h4 className="text-xl font-bold text-white">100% Secure & Verified</h4>
                    <p className="text-gray-400 text-sm mt-1">Our apps are scanned for viruses and optimized for student devices.</p>
                </div>
            </div>
        </div>
    </div>
)}
                    </main>
                    
                     {/* FOOTER */}
                    <footer className="border-t border-white/5 bg-black py-12 mt-auto relative z-10 glass">
                        <div className="container mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-8 text-sm text-gray-600">
                            <div className="flex flex-col items-center md:items-start gap-2">
                                <div className="flex items-center gap-3 text-white font-bold text-lg">
                                    <div className="w-8 h-8 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg flex items-center justify-center text-xs shadow-[0_0_15px_rgba(16,185,129,0.4)]">DE</div>
                                    DE Education.lk
                                </div>
                                <span className="font-mono text-xs opacity-60">© 2025 All Rights Reserved.</span>
                            </div>
                            
                            <div className="flex flex-col items-center gap-1">
                                <span className="uppercase tracking-widest text-[10px] font-bold">Created By</span>
                                <a href="https://dilnuka13.github.io/my/about.html" target="_blank" rel="noreferrer" className="text-emerald-500 hover:text-emerald-400 font-bold text-base transition-colors hover:underline decoration-emerald-500/30 underline-offset-4 flex items-center gap-2">
                                    Isara Dilnuka <Icons.ExternalLink size={12} />
                                </a>
                            </div>

                            <div className="flex gap-8">
                                <button onClick={() => setActiveModal('terms')} className="hover:text-white transition-colors uppercase text-xs font-bold tracking-wider">Terms</button>
                                <button onClick={() => setActiveModal('privacy')} className="hover:text-white transition-colors uppercase text-xs font-bold tracking-wider">Privacy</button>
                            </div>
                        </div>
                    </footer>

                    {/* Terms/Privacy Modal */}
                    {activeModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-xl animate__animated animate__fadeIn">
                            <div className="glass border border-white/10 rounded-[2.5rem] max-w-2xl w-full max-h-[80vh] overflow-y-auto p-10 relative shadow-[0_0_100px_rgba(0,0,0,1)] animate__animated animate__zoomIn bg-black/60">
                                <button 
                                    onClick={() => setActiveModal(null)}
                                    className="absolute top-8 right-8 p-3 bg-white/5 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition-colors"
                                >
                                    <Icons.X size={20} />
                                </button>
                                
                                <div className="flex items-center gap-5 mb-10 pb-8 border-b border-white/5">
                                    <div className="w-14 h-14 rounded-2xl bg-emerald-500/10 flex items-center justify-center text-emerald-500 border border-emerald-500/20 shadow-[0_0_20px_rgba(16,185,129,0.1)]">
                                        {activeModal === 'terms' ? <Icons.FileText size={28} /> : <Icons.Shield size={28} />}
                                    </div>
                                    <h2 className="text-3xl font-bold text-white text-glow">
                                        {activeModal === 'terms' ? 'Terms of Service' : 'Privacy Policy'}
                                    </h2>
                                </div>

                                <div className="prose prose-invert text-gray-400 text-sm leading-relaxed space-y-8">
                                    {activeModal === 'terms' ? (
                                        <>
                                            <div>
                                                <h4 className="text-white font-bold text-lg mb-3">1. Educational Purpose</h4>
                                                <p>DE Education is a platform designed exclusively for educational assistance. All past papers and marking schemes are property of their respective departments and are shared here for reference only.</p>
                                            </div>
                                            <div>
                                                <h4 className="text-white font-bold text-lg mb-3">2. User Responsibility</h4>
                                                <p>Users are expected to use the AI Tutor and resources responsibly. Any attempt to abuse the system or scrape data is strictly prohibited.</p>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div>
                                                <h4 className="text-white font-bold text-lg mb-3">1. Data Privacy</h4>
                                                <p>We prioritize your privacy. We do not collect personal usage data from students. The AI interactions are processed via Google Gemini and are not permanently stored by us linked to your identity.</p>
                                            </div>
                                            <div>
                                                <h4 className="text-white font-bold text-lg mb-3">2. Admin Security</h4>
                                                <p>Administrative functions are secured using advanced biometric facial recognition (Face API) to ensure unauthorized access is prevented.</p>
                                            </div>
                                        </>
                                    )}
                                </div>
                                
                                <div className="mt-12 pt-8 border-t border-white/5 flex justify-end">
                                    <button onClick={() => setActiveModal(null)} className="px-10 py-3 bg-white text-black hover:bg-gray-200 rounded-xl font-bold transition-colors shadow-lg hover:scale-105">Close</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const MaintenanceGuard = ({ children }) => {
            const [isMaintenance, setIsMaintenance] = useState(false);
            const [loading, setLoading] = useState(true);
            const location = useLocation();

            useEffect(() => {
                const checkStatus = async () => {
                    try {
                        const { data } = await supabaseClient.from('system_settings').select('value').eq('key', 'maintenance').single();
                        setIsMaintenance(data?.value?.isActive || false);
                    } catch (e) { console.error(e); } 
                    finally { setLoading(false); }
                };
                checkStatus();
            }, [location.pathname]);

            if (loading) return null;
            if (isMaintenance && !location.pathname.startsWith('/admin')) {
                return <Navigate to="/maintenance" replace />;
            }
            return <>{children}</>;
        };

        const App = () => {
            return (
                <HashRouter>
                    <Routes>
                        <Route path="/maintenance" element={<MaintenancePage />} />
                        <Route path="/admin" element={<AdminPage />} />
                        <Route path="/" element={<MaintenanceGuard><MainPage /></MaintenanceGuard>} />
                        <Route path="*" element={<Navigate to="/" />} />
                    </Routes>
                </HashRouter>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
