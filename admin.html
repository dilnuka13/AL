<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - DE Education</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sinhala:wght@400;500;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        sinhala: ['Noto Sinhala', 'sans-serif'],
                    },
                    colors: {
                        emerald: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            200: '#a7f3d0',
                            300: '#6ee7b7',
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                            950: '#022c22',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Shared Styles from Index.html --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .dark .glass {
            background: rgba(17, 24, 39, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .hero-pattern {
            background-color: #f0fdf4;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23059669' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .dark .hero-pattern {
            background-color: #0f172a;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2334d399' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* --- Admin Specific Styles --- */
        .loading { opacity: 0.6; pointer-events: none; }
        
        .tab-active {
            background-color: #059669;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .dark .tab-active {
            background-color: #059669;
            color: white;
        }

        .section-transition { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .section-hidden { opacity: 0; transform: translateY(10px); pointer-events: none; position: absolute; width: 100%; visibility: hidden; }
        .section-visible { opacity: 1; transform: translateY(0); pointer-events: auto; position: relative; visibility: visible; }

        #face-loader {
            border: 4px solid rgba(16, 185, 129, 0.1);
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .view-active { display: block !important; animation: fadeIn 0.4s ease-out; }
        .view-hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Camera Feed */
        #video-container { position: relative; width: 100%; aspect-ratio: 4/3; border-radius: 12px; overflow: hidden; background: black; }
        #video-feed, #face-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-slate-900 text-gray-800 dark:text-gray-200 transition-colors duration-300 selection:bg-emerald-500 selection:text-white hero-pattern font-sans">
    
    <!-- Loading Overlay -->
    <div id="loader-view" class="fixed inset-0 bg-white/80 dark:bg-slate-900/90 backdrop-blur-md flex flex-col items-center justify-center z-[100] transition-opacity duration-500">
        <div id="face-loader" class="mx-auto mb-4"></div>
        <h3 class="text-lg font-bold text-emerald-800 dark:text-emerald-400">Initializing Security</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400">Loading AI recognition models...</p>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 flex items-center justify-center z-50 transition-all duration-500 opacity-0 pointer-events-none scale-95">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div> 
        
        <div id="login-modal-content" class="glass-card rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 relative z-10 border border-gray-200 dark:border-gray-700">
            
            <!-- Login View -->
            <div id="login-view" class="view-active">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 mb-4">
                        <i class="fas fa-shield-alt text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Admin Portal</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Secure Access Only</p>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 dark:text-gray-300 uppercase mb-2">Email Address</label>
                        <input type="email" id="login-email" class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 dark:text-white transition-all" placeholder="admin@example.com">
                    </div>
                    
                    <button id="login-with-face-btn" class="group w-full flex items-center justify-center py-3 px-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-semibold transition-all duration-300 shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/40 transform hover:scale-[1.01]">
                        <i class="fas fa-camera mr-2 group-hover:rotate-12 transition-transform"></i> 
                        Login with Face ID
                    </button>
                    
                    <div class="text-center pt-2">
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            New Administrator? 
                            <a href="#" id="show-register-link" class="text-emerald-600 dark:text-emerald-400 font-bold hover:underline">Register</a>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Secret Key View -->
            <div id="admin-secret-view" class="view-hidden">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 mb-4">
                        <i class="fas fa-key text-xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Verification</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Enter the master secret key</p>
                </div>
                
                <div class="space-y-5">
                    <input type="password" id="admin-secret-input" class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 text-gray-900 dark:text-white text-center tracking-widest text-lg" placeholder="••••••••">
                    
                    <button id="submit-secret-btn" class="w-full py-3 px-4 bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl font-semibold transition-colors shadow-lg shadow-yellow-500/30">
                        Verify Secret
                    </button>
                    
                    <button id="show-login-link-secret" class="w-full text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
                        Back to Login
                    </button>
                </div>
            </div>

            <!-- Register View -->
            <div id="register-view" class="view-hidden">
                <h2 class="text-xl font-bold text-center text-gray-900 dark:text-white mb-6">Create Admin Account</h2>
                <div class="space-y-3">
                    <input type="text" id="register-name" placeholder="Full Name" class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 dark:text-white text-sm">
                    <input type="email" id="register-email" placeholder="Email Address" class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 dark:text-white text-sm">
                    <input type="tel" id="register-phone" placeholder="Phone Number" class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 dark:text-white text-sm">
                    <input type="password" id="register-password" placeholder="Password" class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 dark:text-white text-sm">
                    
                    <button id="scan-face-btn" class="w-full border-2 border-dashed border-emerald-300 dark:border-emerald-700 text-emerald-600 dark:text-emerald-400 py-3 rounded-xl font-medium hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-id-card"></i> <span>Scan Face (Required)</span>
                    </button>
                    
                    <p id="scan-feedback" class="text-center text-xs text-emerald-600 font-medium h-4"></p>
                    
                    <button id="register-btn" disabled class="w-full py-3 bg-emerald-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-xl font-bold shadow-lg shadow-emerald-500/30 transition-all">
                        Create Account
                    </button>
                    
                    <button id="show-login-link-register" class="w-full text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 mt-2">
                        Cancel
                    </button>
                </div>
            </div>

            <!-- Feedback Toast inside Modal -->
            <div id="message-box" class="hidden mt-4 p-3 rounded-lg text-center text-white text-sm font-medium animate__animated animate__fadeIn"></div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-sm">
        <div class="relative w-full max-w-lg p-4">
            <div class="bg-gray-900 rounded-2xl overflow-hidden shadow-2xl border border-gray-700">
                <div class="p-4 text-center">
                    <h3 id="camera-instruction" class="text-white font-medium">Initializing camera...</h3>
                </div>
                <div id="video-container">
                    <video id="video-feed" autoplay muted playsinline></video>
                    <canvas id="face-canvas"></canvas>
                </div>
                <div class="p-4">
                    <button id="stop-camera-btn" class="w-full py-3 bg-red-500/20 text-red-400 border border-red-500/50 rounded-xl hover:bg-red-500 hover:text-white transition-all font-medium">
                        Cancel Scan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div id="mainContent" class="flex flex-col min-h-screen hidden">
        <!-- Header -->
        <header class="sticky top-0 z-40 glass shadow-sm border-b border-gray-200 dark:border-gray-800">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-700 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-emerald-500/20">
                        A
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900 dark:text-white leading-tight">Admin Dashboard</h1>
                        <p class="text-[10px] font-medium text-emerald-600 dark:text-emerald-400 uppercase tracking-wide">Paper Management</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <a href="index.html" class="hidden md:flex items-center text-sm text-gray-500 hover:text-emerald-600 transition-colors mr-2">
                        <i class="fas fa-external-link-alt mr-2"></i> View Site
                    </a>
                    <button id="darkModeToggle" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-yellow-400 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-sun text-sm" id="toggleIcon"></i>
                    </button>
                    <button id="logout-btn" class="w-10 h-10 rounded-full bg-red-50 dark:bg-red-900/20 text-red-500 flex items-center justify-center hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                        <i class="fas fa-sign-out-alt text-sm"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-5xl mx-auto w-full px-4 py-8">
            <!-- Tabs -->
            <div class="bg-white dark:bg-gray-800 p-1.5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-8 flex max-w-md mx-auto">
                <button id="dataEntryTab" class="flex-1 py-2.5 px-4 rounded-lg text-sm font-semibold transition-all duration-300 tab-active">
                    <i class="fas fa-plus-circle mr-2"></i> Add New
                </button>
                <button id="dataEditTab" class="flex-1 py-2.5 px-4 rounded-lg text-sm font-semibold transition-all duration-300 text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">
                    <i class="fas fa-tasks mr-2"></i> Manage
                </button>
            </div>

            <!-- Data Entry Section -->
            <div id="dataEntrySection" class="glass-card rounded-2xl p-6 md:p-8 section-transition section-visible">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6" id="formTitle">Add New Past Paper</h2>
                
                <form id="paperForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Stream</label>
                            <select id="stream" class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-800 dark:text-white appearance-none">
                                <option value="">Select Stream</option>
                                <option value="science">Science</option>
                                <option value="commerce">Commerce</option>
                                <option value="arts">Arts</option>
                                <option value="technology">Technology</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Subject</label>
                            <select id="subject" class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-800 dark:text-white appearance-none disabled:opacity-50" disabled>
                                <option value="">Select Stream First</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Year</label>
                        <input type="number" id="year" min="2000" max="2030" class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-800 dark:text-white" placeholder="e.g. 2024">
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Paper Link</label>
                            <div class="relative">
                                <i class="fas fa-link absolute left-4 top-4 text-gray-400"></i>
                                <input type="url" id="paperLink" class="w-full pl-10 pr-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-800 dark:text-white" placeholder="https://...">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Marking Scheme (Optional)</label>
                            <div class="relative">
                                <i class="fas fa-check-double absolute left-4 top-4 text-gray-400"></i>
                                <input type="url" id="markingLink" class="w-full pl-10 pr-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-800 dark:text-white" placeholder="https://...">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-4 pt-2">
                        <button type="submit" id="submitBtn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/40 transition-all transform hover:-translate-y-0.5">
                            <span id="submitBtnText">Add Paper</span>
                            <i id="submitSpinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                        </button>
                        
                        <button type="button" id="updateBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-blue-500/30 transition-all hidden">
                            <span id="updateBtnText">Update Paper</span>
                            <i id="updateSpinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                        </button>
                        
                        <button type="button" id="cancelBtn" class="px-6 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors hidden">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- Data Management Section -->
            <div id="dataManagementSection" class="glass-card rounded-2xl p-6 md:p-8 section-transition section-hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Existing Records</h2>
                    <button onclick="loadPapers()" class="text-sm px-4 py-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded-lg hover:bg-emerald-200 dark:hover:bg-emerald-900/50 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh List
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                    <div class="md:col-span-1 relative">
                        <i class="fas fa-search absolute left-3 top-3.5 text-gray-400 text-sm"></i>
                        <input type="text" id="searchPapers" placeholder="Search..." class="w-full pl-9 pr-4 py-2.5 rounded-lg bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 text-sm focus:ring-2 focus:ring-emerald-500 focus:outline-none dark:text-white">
                    </div>
                    <select id="filterStream" class="px-3 py-2.5 rounded-lg bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 text-sm dark:text-white focus:outline-none">
                        <option value="">All Streams</option>
                        <option value="science">Science</option>
                        <option value="commerce">Commerce</option>
                        <option value="arts">Arts</option>
                        <option value="technology">Technology</option>
                    </select>
                    <select id="filterSubject" class="px-3 py-2.5 rounded-lg bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 text-sm dark:text-white focus:outline-none" disabled>
                        <option value="">Subject</option>
                    </select>
                    <select id="filterYear" class="px-3 py-2.5 rounded-lg bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 text-sm dark:text-white focus:outline-none">
                        <option value="">Year</option>
                        <!-- JS populates years -->
                    </select>
                </div>
                
                <div id="loadingMessage" class="hidden flex flex-col items-center justify-center py-12 text-emerald-600">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-3"></i>
                    <p class="text-sm">Fetching data...</p>
                </div>
                
                <div id="papersList" class="space-y-3">
                    <!-- Papers injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Notification Toast -->
    <div id="notificationContainer" class="fixed top-24 right-6 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- Scripts -->
    <script type="module">
        // Supabase config
        const supabaseUrl = 'https://hppojrbfhzttzvlvovre.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcG9qcmJmaHp0dHp2bHZvdnJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODgxNDYsImV4cCI6MjA3Njc2NDE0Nn0.aL2fegb_eRPY0E7P6Mwufhq3TCAeX8-hDCHBo9VeAsA';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // DOM Elements
        const body = document.body;
        const loginModal = document.getElementById('loginModal');
        const mainContent = document.getElementById('mainContent');
        const loaderView = document.getElementById('loader-view');
        
        // Logic Elements
        const ADMIN_SECRET = '20050616';
        let editingPaperId = null;
        let allPapers = [];
        let registrationDescriptors = [];
        let stream;
        let detectionInterval;

        // --- Theme Logic ---
        function toggleDarkMode() {
            body.classList.toggle('dark');
            const isDark = body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        function updateThemeIcon(isDark) {
            const icon = document.getElementById('toggleIcon');
            if(icon) {
                icon.className = isDark ? 'fas fa-moon text-sm' : 'fas fa-sun text-sm';
            }
        }

        function initTheme() {
            const saved = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (saved === 'dark') body.classList.add('dark');
            updateThemeIcon(saved === 'dark');
        }

        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

        // --- Load Face Models ---
        async function loadModels() {
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                loaderView.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    loginModal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                    loginModal.classList.add('opacity-100', 'scale-100');
                }, 500);
            } catch (error) {
                console.error("Model Error:", error);
                alert("Failed to load security models. Please refresh.");
            }
        }

        // --- View Switching ---
        function showView(viewName) {
            ['login', 'admin-secret', 'register'].forEach(v => {
                document.getElementById(`${v}-view`).classList.add('view-hidden');
                document.getElementById(`${v}-view`).classList.remove('view-active');
            });
            const target = document.getElementById(`${viewName}-view`);
            target.classList.remove('view-hidden');
            target.classList.add('view-active');
        }

        document.getElementById('show-register-link').onclick = () => showView('admin-secret');
        document.getElementById('show-login-link-secret').onclick = () => showView('login');
        document.getElementById('show-login-link-register').onclick = () => showView('login');

        // --- Secret Check ---
        document.getElementById('submit-secret-btn').onclick = () => {
            if (document.getElementById('admin-secret-input').value === ADMIN_SECRET) {
                showView('register');
            } else {
                showToast("Invalid Admin Secret", 'error');
            }
        };

        // --- Camera Logic ---
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('video-feed').srcObject = stream;
                document.getElementById('camera-modal').classList.remove('hidden');
                return { width: document.getElementById('video-feed').clientWidth, height: document.getElementById('video-feed').clientHeight };
            } catch (err) {
                showToast("Camera access denied", 'error');
                return null;
            }
        }

        function stopCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            if (detectionInterval) clearInterval(detectionInterval);
            document.getElementById('camera-modal').classList.add('hidden');
        }
        document.getElementById('stop-camera-btn').onclick = stopCamera;

        // --- Login Logic ---
        document.getElementById('login-with-face-btn').onclick = async () => {
            const email = document.getElementById('login-email').value;
            if (!email) return showToast("Enter email first", 'error');

            try {
                const { data, error } = await supabase.from('users').select('*').eq('email', email).single();
                if (error || !data) return showToast("User not found", 'error');
                if (!data.email_confirmed_at) return showToast("Account pending approval", 'error');

                const descriptors = data.face_descriptors.map(d => new Float32Array(d));
                const matcher = new faceapi.FaceMatcher(new faceapi.LabeledFaceDescriptors(email, descriptors), 0.5);
                
                const dims = await startCamera();
                if(!dims) return;

                const canvas = document.getElementById('face-canvas');
                faceapi.matchDimensions(canvas, dims);

                document.getElementById('camera-instruction').textContent = "Verifying identity...";

                detectionInterval = setInterval(async () => {
                    const det = await faceapi.detectSingleFace(document.getElementById('video-feed'), new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    if (det) {
                        const match = matcher.findBestMatch(det.descriptor);
                        if (match.label === email) {
                            stopCamera();
                            loginModal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                            setTimeout(() => {
                                loginModal.classList.add('hidden');
                                mainContent.classList.remove('hidden');
                                initTheme();
                            }, 300);
                            showToast("Welcome back!", 'success');
                        }
                    }
                }, 500);

            } catch (e) {
                showToast("Login failed: " + e.message, 'error');
            }
        };

        // --- Register Logic ---
        document.getElementById('scan-face-btn').onclick = async () => {
            registrationDescriptors = [];
            const dims = await startCamera();
            if(!dims) return;
            
            let scans = 0;
            const feedback = document.getElementById('scan-feedback');
            const btn = document.getElementById('register-btn');
            
            detectionInterval = setInterval(async () => {
                const det = await faceapi.detectSingleFace(document.getElementById('video-feed'), new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                if(det) {
                    registrationDescriptors.push(det.descriptor);
                    scans++;
                    document.getElementById('camera-instruction').textContent = `Scanning: ${scans}/5`;
                    if(scans >= 5) {
                        stopCamera();
                        feedback.textContent = "Face data captured!";
                        btn.disabled = false;
                        btn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                        btn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                    }
                }
            }, 800);
        };

        document.getElementById('register-btn').onclick = async () => {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const phone = document.getElementById('register-phone').value;
            const pwd = document.getElementById('register-password').value;

            if(!name || !email || !phone || !pwd) return showToast("Fill all fields", 'error');

            try {
                const serializable = registrationDescriptors.map(d => Array.from(d));
                const { error } = await supabase.from('users').insert({
                    name, email, phone, password: pwd, face_descriptors: serializable
                });
                if(error) throw error;
                showToast("Registered! Wait for approval.", 'success');
                showView('login');
            } catch(e) {
                showToast("Error: " + e.message, 'error');
            }
        };

        // --- Dashboard Logic ---
        const tabs = {
            entry: { btn: document.getElementById('dataEntryTab'), section: document.getElementById('dataEntrySection') },
            manage: { btn: document.getElementById('dataEditTab'), section: document.getElementById('dataManagementSection') }
        };

        function switchTab(target) {
            Object.values(tabs).forEach(t => {
                t.btn.classList.remove('tab-active', 'bg-emerald-600', 'text-white');
                t.btn.classList.add('text-gray-500', 'dark:text-gray-400');
                t.section.classList.add('section-hidden');
                t.section.classList.remove('section-visible');
            });
            target.btn.classList.add('tab-active', 'bg-emerald-600', 'text-white');
            target.btn.classList.remove('text-gray-500', 'dark:text-gray-400');
            target.section.classList.remove('section-hidden');
            target.section.classList.add('section-visible');
        }

        tabs.entry.btn.onclick = () => switchTab(tabs.entry);
        tabs.manage.btn.onclick = () => { switchTab(tabs.manage); loadPapers(); };

        // --- CRUD Operations ---
        async function loadSubjects(stream, selectorId) {
            const sel = document.getElementById(selectorId);
            sel.innerHTML = '<option>Loading...</option>';
            try {
                const { data } = await supabase.from('subjects').select('*').eq('stream', stream).order('name');
                sel.innerHTML = '<option value="">Select Subject</option>';
                sel.disabled = false;
                data.forEach(s => {
                    sel.innerHTML += `<option value="${s.code}">${s.name}</option>`;
                });
            } catch(e) { sel.innerHTML = '<option>Error</option>'; }
        }

        document.getElementById('stream').onchange = (e) => loadSubjects(e.target.value, 'subject');
        document.getElementById('filterStream').onchange = (e) => {
            loadSubjects(e.target.value, 'filterSubject');
            filterPapers();
        };

        document.getElementById('paperForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = editingPaperId ? document.getElementById('updateBtn') : document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            try {
                const data = {
                    stream: document.getElementById('stream').value,
                    subject_code: document.getElementById('subject').value,
                    subject_name: document.getElementById('subject').options[document.getElementById('subject').selectedIndex].text,
                    year: parseInt(document.getElementById('year').value),
                    paper_link: document.getElementById('paperLink').value,
                    marking_scheme_link: document.getElementById('markingLink').value || null
                };

                // Multi-stream logic
                if(['ict', 'agriculture', 'geography'].includes(data.subject_code) && !editingPaperId) {
                    const inserts = ['science','commerce','arts','technology'].map(s => ({...data, stream: s}));
                    await supabase.from('past_papers').insert(inserts);
                } else {
                    if(editingPaperId) await supabase.from('past_papers').update(data).eq('id', editingPaperId);
                    else await supabase.from('past_papers').insert(data);
                }

                showToast(editingPaperId ? "Updated!" : "Added!", 'success');
                resetForm();
                if(tabs.manage.btn.classList.contains('tab-active')) loadPapers();

            } catch(err) {
                showToast(err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        async function loadPapers() {
            document.getElementById('loadingMessage').classList.remove('hidden');
            document.getElementById('papersList').innerHTML = '';
            
            const { data } = await supabase.from('past_papers').select('*').order('created_at', { ascending: false });
            allPapers = data || [];
            filterPapers();
            document.getElementById('loadingMessage').classList.add('hidden');
        }

        function filterPapers() {
            const q = document.getElementById('searchPapers').value.toLowerCase();
            const st = document.getElementById('filterStream').value;
            const yr = document.getElementById('filterYear').value;
            
            const filtered = allPapers.filter(p => {
                return (!st || p.stream === st) &&
                       (!yr || p.year == yr) &&
                       (!q || p.subject_name.toLowerCase().includes(q) || p.year.toString().includes(q));
            });

            const list = document.getElementById('papersList');
            list.innerHTML = '';
            
            if(filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-8 text-gray-400">No records found</div>`;
                return;
            }

            filtered.forEach(p => {
                const item = document.createElement('div');
                item.className = 'group bg-white dark:bg-gray-800/50 border border-gray-100 dark:border-gray-700 p-4 rounded-xl hover:shadow-md transition-all flex flex-col sm:flex-row justify-between gap-4 items-start sm:items-center animate__animated animate__fadeIn';
                item.innerHTML = `
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400">${p.stream}</span>
                            <span class="text-xs text-gray-400">${p.year}</span>
                        </div>
                        <h4 class="font-bold text-gray-800 dark:text-white">${p.subject_name}</h4>
                        <div class="flex gap-3 mt-2 text-xs">
                            <a href="${p.paper_link}" target="_blank" class="flex items-center text-blue-600 hover:underline"><i class="fas fa-file-pdf mr-1"></i> Paper</a>
                            ${p.marking_scheme_link ? `<a href="${p.marking_scheme_link}" target="_blank" class="flex items-center text-green-600 hover:underline"><i class="fas fa-check-circle mr-1"></i> Scheme</a>` : ''}
                        </div>
                    </div>
                    <div class="flex gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="window.editPaper('${p.id}')" class="p-2 text-yellow-500 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 rounded-lg transition-colors"><i class="fas fa-edit"></i></button>
                        <button onclick="window.deletePaper('${p.id}')" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // --- Globals for HTML access ---
        window.editPaper = async (id) => {
            editingPaperId = id;
            const p = allPapers.find(x => x.id === id);
            document.getElementById('stream').value = p.stream;
            await loadSubjects(p.stream, 'subject');
            document.getElementById('subject').value = p.subject_code;
            document.getElementById('year').value = p.year;
            document.getElementById('paperLink').value = p.paper_link;
            document.getElementById('markingLink').value = p.marking_scheme_link || '';
            
            document.getElementById('formTitle').textContent = 'Edit Paper';
            document.getElementById('submitBtn').classList.add('hidden');
            document.getElementById('updateBtn').classList.remove('hidden');
            document.getElementById('cancelBtn').classList.remove('hidden');
            
            switchTab(tabs.entry);
        };

        window.deletePaper = async (id) => {
            if(!confirm("Delete this paper permanently?")) return;
            try {
                await supabase.from('past_papers').delete().eq('id', id);
                showToast("Deleted", 'success');
                loadPapers();
            } catch(e) { showToast("Delete failed", 'error'); }
        };

        function resetForm() {
            document.getElementById('paperForm').reset();
            editingPaperId = null;
            document.getElementById('formTitle').textContent = 'Add New Past Paper';
            document.getElementById('submitBtn').classList.remove('hidden');
            document.getElementById('updateBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
        }
        document.getElementById('cancelBtn').onclick = resetForm;

        // --- Toast System ---
        function showToast(msg, type='info') {
            const t = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-emerald-500' : 'bg-blue-500';
            t.className = `${colors} text-white px-4 py-3 rounded-xl shadow-lg text-sm font-medium animate__animated animate__fadeInRight pointer-events-auto`;
            t.innerHTML = msg;
            document.getElementById('notificationContainer').appendChild(t);
            setTimeout(() => {
                t.classList.replace('animate__fadeInRight', 'animate__fadeOutRight');
                setTimeout(() => t.remove(), 500);
            }, 3000);
        }

        // Populate Years Filter
        const ySelect = document.getElementById('filterYear');
        for(let i=2025; i>=2010; i--) ySelect.innerHTML += `<option value="${i}">${i}</option>`;

        // Listeners
        ['searchPapers', 'filterStream', 'filterYear'].forEach(id => {
            document.getElementById(id).addEventListener('input', filterPapers);
        });

        // Logout
        document.getElementById('logout-btn').onclick = () => {
            mainContent.classList.add('hidden');
            loginModal.classList.remove('hidden', 'opacity-0', 'pointer-events-none', 'scale-95');
            showView('login');
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadModels();
            initTheme();
        });
    </script>
</body>
</html>
