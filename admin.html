<!DOCTYPE html>
<html lang="en"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - DE Education</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Define custom styles for smooth transitions and dark mode default */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Default Light Mode Background */
            transition: background-color 0.3s ease-in-out;
        }
        body.dark {
            background-color: #1f2937; /* Dark Mode Background (slate-800) */
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .tab-active {
            background-color: #059669; /* emerald-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Custom section transition classes */
        .section-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .section-hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            position: absolute; /* To prevent shifting layout */
            width: 100%;
            visibility: hidden;
        }
        .section-visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            position: relative;
            visibility: visible;
        }
        /* Paper item list animation */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .paper-item {
            animation: fadeInUp 0.4s ease-out backwards;
        }

        /* --- NEW: Login Modal Background Image --- */
        #loginModal {
            /* Set the psychedelic image as the background */
            background-image: url('https://img.freepik.com/free-photo/multi-colored-psychedelic-background_23-2148805320.jpg?semt=ais_hybrid&w=740&q=80');
            background-size: cover;
            background-position: center;
        }
        /* Make sure content is layered correctly */
        #loginModal .z-10 {
            z-index: 10;
        }
        
        /* --- NEW: Face Login Styles --- */
        #video-container {
            position: relative;
            width: 400px;
            height: 300px;
            margin: auto;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        #video-feed, #face-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #video-feed { object-fit: cover; }
        
        #face-loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .view-active {
            display: block !important;
            animation: fadeIn 0.4s ease-out;
        }
        .view-hidden { display: none !important; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-enter { animation: modalFadeIn 0.3s ease-out; }
        .modal-content-enter { animation: modalScaleIn 0.3s ease-out; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalScaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen p-6 text-gray-800 dark:text-gray-200">
    
    <div id="loader-view" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center z-[100]">
        <div id="face-loader" class="mx-auto"></div>
        <p class="mt-4 text-lg font-medium text-gray-700 dark:text-gray-300">Please wait...</p>
        <p class="text-gray-500 dark:text-gray-400">Loading face recognition AI models.</p>
    </div>

    <div id="loginModal" class="fixed inset-0 flex items-center justify-center z-50 transition-opacity duration-300 opacity-100">
        <div class="absolute inset-0 bg-black opacity-70 dark:opacity-80"></div> 
        
        <div id="login-modal-content" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-md w-full transition-all duration-300 relative z-10">
            
            <div id="login-view" class="view-active">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-emerald-800 dark:text-emerald-400">Admin Login</h2>
                    <p class="text-gray-600 dark:text-gray-400">Access the DE Education System</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-gray-700 dark:text-gray-300 mb-2">Email Address</label>
                        <input type="email" id="login-email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    </div>
                    <button id="login-with-face-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-[1.01]">
                        <i class="fas fa-camera mr-2"></i> Login with Face Scan
                    </button>
                    <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-4">
                        Don't have an account? 
                        <a href="#" id="show-register-link" class="font-medium text-emerald-600 hover:text-emerald-500 transition-colors">
                            Register here
                        </a>
                    </p>
                </div>
            </div>

            <div id="admin-secret-view" class="view-hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">Admin Secret</h2>
                    <p class="text-gray-600 dark:text-gray-400">Please enter the admin secret to register.</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="admin-secret-input" class="block text-gray-700 dark:text-gray-300 mb-2">Admin Secret</label>
                        <input type="password" id="admin-secret-input" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    </div>
                    <button id="submit-secret-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 shadow-md hover:shadow-lg">
                        Confirm
                    </button>
                    <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-4">
                        <a href="#" id="show-login-link-secret" class="font-medium text-emerald-600 hover:text-emerald-500 transition-colors">
                            <i class="fas fa-arrow-left mr-1"></i> Back to Login
                        </a>
                    </p>
                </div>
            </div>

            <div id="register-view" class="view-hidden">
                <h2 class="text-2xl font-bold text-center text-emerald-800 dark:text-emerald-400 mb-6">Create a new account</h2>
                <div class="space-y-3">
                    <input type="text" id="register-name" placeholder="Full Name" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <input type="email" id="register-email" placeholder="Email Address" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <input type="tel" id="register-phone" placeholder="Phone Number (Required)" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <input type="password" id="register-password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    
                    <button id="scan-face-btn" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-300 shadow-sm active:scale-95">
                        <i class="fas fa-id-card mr-2"></i> Start Face Scan
                    </button>
                    
                    <p id="scan-feedback" class="text-center text-sm text-green-700 dark:text-green-400 font-medium"></p>
                    
                    <button id="register-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-sm disabled:bg-gray-400 active:scale-95">
                        Register
                    </button>
                    
                    <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-4">
                        <a href="#" id="show-login-link-register" class="font-medium text-emerald-600 hover:text-emerald-500 transition-colors">
                            <i class="fas fa-arrow-left mr-1"></i> Back to Login
                        </a>
                    </p>
                </div>
            </div>

            <div id="message-box" class="hidden mt-4 p-3 rounded-lg text-center text-white font-medium transition-all duration-300"></div>

        </div>
    </div>

    <div id="camera-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[150]">
        <div id="camera-modal-overlay" class="absolute inset-0 modal-enter"></div>
        <div id="camera-modal-content" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl z-10 modal-content-enter">
            <h3 id="camera-instruction" class="text-xl font-semibold text-center mb-4 text-gray-800 dark:text-gray-200">Look at the camera</h3>
            <div id="video-container" class="rounded-lg overflow-hidden bg-black">
                <video id="video-feed" autoplay muted playsinline></video>
                <canvas id="face-canvas"></canvas>
            </div>
            <button id="stop-camera-btn" class="mt-4 w-full bg-red-500 text-white py-2 rounded-md hover:bg-red-600 transition-colors active:scale-95">
                Stop
            </button>
        </div>
    </div>

    <div id="mainContent" class="hidden">
        <div class="max-w-6xl mx-auto">
            <header class="text-center mb-8 flex justify-between items-center">
                <a href="https://dilnuka13.github.io/AL/" target="_blank" class="flex items-center group cursor-pointer transition-transform duration-200 hover:scale-[1.02]">
                    <div class="w-12 h-12 bg-emerald-600 rounded-lg flex items-center justify-center text-white font-bold text-xl mr-3 shadow-lg group-hover:shadow-xl transition-shadow">
                        DE
                    </div>
                    <h1 class="text-3xl font-bold text-emerald-800 dark:text-emerald-400 text-left transition-colors">Education.lk Papers Management System</h1>
                </a>
                
                <div class="flex items-center gap-4">
                    <button id="darkModeToggle" class="p-3 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 transition-colors shadow-md hover:shadow-lg transform hover:scale-105">
                        <i class="fas fa-sun" id="toggleIcon"></i>
                    </button>
                    <button id="logout-btn" class="p-3 rounded-full bg-red-600 dark:bg-red-700 text-white transition-colors shadow-md hover:shadow-lg transform hover:scale-105">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-1 mb-6 transition-colors duration-300">
                <div class="flex">
                    <button id="dataEntryTab" class="flex-1 py-3 px-4 rounded-lg font-medium transition-all duration-300 tab-active">
                        Data Entry
                    </button>
                    <button id="dataEditTab" class="flex-1 py-3 px-4 rounded-lg font-medium transition-all duration-300 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                        Data Management
                    </button>
                </div>
            </div>

            <div class="relative min-h-[400px]">
                <div id="dataEntrySection" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6 section-transition section-visible">
                    <h2 class="text-xl font-semibold text-emerald-800 dark:text-emerald-400 mb-4" id="formTitle">Add New Past Paper</h2>
                    
                    <form id="paperForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="stream" class="block text-gray-700 dark:text-gray-300 mb-2">Stream</label>
                                <select id="stream" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                                    <option value="">Select</option>
                                    <option value="science">Science</option>
                                    <option value="commerce">Commerce</option>
                                    <option value="arts">Arts</option>
                                    <option value="technology">Technology</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="subject" class="block text-gray-700 dark:text-gray-300 mb-2">Subject</label>
                                <select id="subject" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required disabled>
                                    <option value="">First select a stream</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label for="year" class="block text-gray-700 dark:text-gray-300 mb-2">Year</label>
                            <input type="number" id="year" min="2000" max="2030" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                        </div>
                        
                        <div>
                            <label for="paperLink" class="block text-gray-700 dark:text-gray-300 mb-2">Paper Link</label>
                            <input type="url" id="paperLink" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required placeholder="https://drive.google.com/file/d/...">
                        </div>
                        
                        <div>
                            <label for="markingLink" class="block text-gray-700 dark:text-gray-300 mb-2">Marking Scheme Link (Optional)</label>
                            <input type="url" id="markingLink" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="https://drive.google.com/file/d/...">
                        </div>
                        
                        <div class="flex gap-4">
                            <button type="submit" id="submitBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 flex-1 shadow-md hover:shadow-lg transform hover:scale-[1.01] flex items-center justify-center">
                                <span id="submitBtnText">Add Past Paper</span>
                                <i id="submitSpinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                            </button>
                            <button type="button" id="updateBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 flex-1 shadow-md hover:shadow-lg transform hover:scale-[1.01] hidden flex items-center justify-center">
                                <span id="updateBtnText">Update Paper</span>
                                <i id="updateSpinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                            </button>
                            <button type="button" id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors flex-1 hidden shadow-md hover:shadow-lg transform hover:scale-[1.01]">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>

                <div id="dataManagementSection" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 section-transition section-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-emerald-800 dark:text-emerald-400">Existing Past Papers</h2>
                        <button onclick="loadPapers()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition-colors shadow-md transform hover:scale-105">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                    
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="searchPapers" placeholder="Search papers..." class="md:col-span-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        
                        <select id="filterStream" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">All Streams</option>
                            <option value="science">Science</option>
                            <option value="commerce">Commerce</option>
                            <option value="arts">Arts</option>
                            <option value="technology">Technology</option>
                        </select>
                        
                        <select id="filterSubject" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" disabled>
                            <option value="">Select Stream First</option>
                        </select>

                        <select id="filterYear" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">All Years</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                            <option value="2018">2018</option>
                            <option value="2017">2017</option>
                            <option value="2016">2016</option>
                            <option value="2015">2015</option>
                            <option value="2014">2014</option>
                            <option value="2013">2013</option>
                            <option value="2012">2012</option>
                            <option value="2011">2011</option>
                            <option value="2010">2010</option>
                        </select>
                    </div>
                    
                    <div id="loadingMessage" class="text-center text-gray-500 dark:text-gray-400 py-8 hidden">
                        <i class="fas fa-circle-notch fa-spin text-3xl text-emerald-500 mb-2"></i>
                        <p>Loading papers...</p>
                    </div>
                    
                    <div id="papersList" class="space-y-4">
                        </div>
                </div>
            </div> </div>
    </div>
    
    <footer class="max-w-6xl mx-auto px-6">
        <div class="mt-8 border-t border-gray-300 dark:border-gray-700 pt-4 pb-12 text-center text-gray-500 dark:text-gray-400 text-sm transition-colors duration-300">
             <p>&copy; 2025 DE Education.lk. All rights reserved.</p>
             <p class="mt-2">
                 <small>Designed by 
                     <a href="https://dilnuka13.github.io/my/" target="_blank" class="text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 transition-colors">
                         Isara Dilnuka Amarathunga
                     </a>
                 </small>
             </p>
         </div>
    </footer>
    <script type="module">
        // Supabase configuration (This is your Admin Panel project)
        const supabaseUrl = 'https://hppojrbfhzttzvlvovre.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcG9qcmJmaHp0dHp2bHZvdnJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODgxNDYsImV4cCI6MjA3Njc2NDE0Nn0.aL2fegb_eRPY0E7P6Mwufhq3TCAeX8-hDCHBo9VeAsA';
        // **FIX:** Using 'supabase' instead of 'supabaseClient' (to match original admin.html)
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- Original Admin DOM elements ---
        const body = document.body;
        const loginModal = document.getElementById('loginModal');
        const mainContent = document.getElementById('mainContent');
        const dataEntryTab = document.getElementById('dataEntryTab');
        const dataEditTab = document.getElementById('dataEditTab');
        const dataEntrySection = document.getElementById('dataEntrySection');
        const dataManagementSection = document.getElementById('dataManagementSection');
        const streamSelect = document.getElementById('stream');
        const subjectSelect = document.getElementById('subject');
        const paperForm = document.getElementById('paperForm');
        const submitBtn = document.getElementById('submitBtn');
        const updateBtn = document.getElementById('updateBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const formTitle = document.getElementById('formTitle');
        const searchInput = document.getElementById('searchPapers');
        const filterStream = document.getElementById('filterStream');
        const filterSubject = document.getElementById('filterSubject');
        const filterYear = document.getElementById('filterYear');
        const papersList = document.getElementById('papersList');
        const loadingMessage = document.getElementById('loadingMessage');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const toggleIcon = document.getElementById('toggleIcon');
        const submitSpinner = document.getElementById('submitSpinner');
        const updateSpinner = document.getElementById('updateSpinner');
        const submitBtnText = document.getElementById('submitBtnText');
        const updateBtnText = document.getElementById('updateBtnText');

        let editingPaperId = null;
        let allPapers = [];

        // Admin credentials
        // **FIX:** Secret changed to '20050616' (your birthday)
        const ADMIN_SECRET = '20050616'; 
        
        // --- NEW: Face Login DOM Elements ---
        const loaderView = document.getElementById('loader-view');
        
        const loginView = document.getElementById('login-view');
        const adminSecretView = document.getElementById('admin-secret-view');
        const registerView = document.getElementById('register-view');
        
        const showRegisterLink = document.getElementById('show-register-link');
        const showLoginLinkSecret = document.getElementById('show-login-link-secret');
        const showLoginLinkRegister = document.getElementById('show-login-link-register');

        const adminSecretInput = document.getElementById('admin-secret-input');
        const submitSecretBtn = document.getElementById('submit-secret-btn');
        
        const loginEmailInput = document.getElementById('login-email');
        const loginWithFaceBtn = document.getElementById('login-with-face-btn');
        
        const registerNameInput = document.getElementById('register-name');
        const registerEmailInput = document.getElementById('register-email');
        const registerPhoneInput = document.getElementById('register-phone'); // New
        const registerPasswordInput = document.getElementById('register-password');
        const scanFaceBtn = document.getElementById('scan-face-btn');
        const registerBtn = document.getElementById('register-btn');
        const scanFeedback = document.getElementById('scan-feedback');
        
        const logoutBtn = document.getElementById('logout-btn'); // New
        const messageBox = document.getElementById('message-box');

        const cameraModal = document.getElementById('camera-modal');
        const cameraModalOverlay = document.getElementById('camera-modal-overlay');
        const cameraModalContent = document.getElementById('camera-modal-content');
        const video = document.getElementById('video-feed');
        const canvas = document.getElementById('face-canvas');
        const cameraInstruction = document.getElementById('camera-instruction');
        const stopCameraBtn = document.getElementById('stop-camera-btn');

        // --- NEW: App State ---
        let registrationDescriptors = []; // Face data during registration
        let stream; // Camera stream
        let detectionInterval; // Face detection interval


        // --- DARK MODE LOGIC (Original) ---
        function toggleDarkMode() {
            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                toggleIcon.classList.remove('fa-sun');
                toggleIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark');
                toggleIcon.classList.remove('fa-moon');
                toggleIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (savedTheme === 'dark') {
                body.classList.add('dark');
                toggleIcon.classList.remove('fa-moon');
                toggleIcon.classList.add('fa-sun');
            } else {
                body.classList.remove('dark');
                toggleIcon.classList.remove('fa-sun');
                toggleIcon.classList.add('fa-moon');
            }
        }

        darkModeToggle.addEventListener('click', toggleDarkMode);
        

        /* --- NEW: Face API Model Loading --- */
        async function loadModels() {
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                console.log("AI Models Loaded Successfully!");
                // Hide loader and show app
                loaderView.classList.add('opacity-0');
                setTimeout(() => {
                    loaderView.classList.add('hidden');
                    // Show login modal (like in original admin.html)
                    loginModal.classList.remove('hidden');
                    showView('login'); // Show login view first
                }, 300);
            } catch (error) {
                console.error("Error loading models:", error);
                loaderView.innerHTML = '<p class="text-red-500">Error loading AI models. Please refresh the page.</p>';
            }
        }

        /* --- NEW: Login/Register View Switching --- */
        function showView(viewName) {
            [loginView, adminSecretView, registerView].forEach(view => {
                view.classList.add('view-hidden');
                view.classList.remove('view-active');
            });
            
            const viewToShow = document.getElementById(`${viewName}-view`);
            if (viewToShow) {
                viewToShow.classList.remove('view-hidden');
                viewToShow.classList.add('view-active');
            }
        }

        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            showView('admin-secret'); // Ask for secret before registration
        });
        
        showLoginLinkSecret.addEventListener('click', (e) => { e.preventDefault(); showView('login'); });
        showLoginLinkRegister.addEventListener('click', (e) => { e.preventDefault(); showView('login'); });

        // --- NEW: Admin Secret Check ---
        submitSecretBtn.addEventListener('click', () => {
            if (adminSecretInput.value === ADMIN_SECRET) {
                showView('register'); // If secret is correct, show register view
            } else {
                showMessage("Incorrect secret!", 'error');
            }
        });

        /* --- NEW: Show Message Box --- */
        function showMessage(message, type = 'info') {
            messageBox.classList.remove('hidden', 'opacity-0', 'bg-red-500', 'bg-green-500', 'bg-blue-500');
            messageBox.textContent = message;
            
            if (type === 'error') messageBox.classList.add('bg-red-500');
            else if (type === 'success') messageBox.classList.add('bg-green-500');
            else messageBox.classList.add('bg-blue-500');

            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 4000);
        }

        /* --- NEW: Camera Functions --- */
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                await video.play();
                
                cameraModal.classList.remove('hidden');
                cameraModalOverlay.classList.add('modal-enter');
                cameraModalContent.classList.add('modal-content-enter');
                
                const displaySize = { width: video.clientWidth, height: video.clientHeight };
                faceapi.matchDimensions(canvas, displaySize);
                return displaySize;
            } catch (err) {
                console.error("Camera error:", err);
                showMessage("Cannot access camera. Please grant permission.", 'error');
                return null;
            }
        }

        function stopCamera() {
            if (stream) stream.getTracks().forEach(track => track.stop());
            if (detectionInterval) clearInterval(detectionInterval);
            
            cameraModalOverlay.classList.remove('modal-enter');
            cameraModalContent.classList.remove('modal-content-enter');
            cameraModal.classList.add('hidden');
            video.srcObject = null;
        }

        stopCameraBtn.addEventListener('click', stopCamera);

        /* --- NEW: Registration Logic (Updated) --- */
        scanFaceBtn.addEventListener('click', async () => {
            registrationDescriptors = [];
            scanFeedback.textContent = "";
            registerBtn.disabled = true;

            const displaySize = await startCamera();
            if (!displaySize) return;

            let scans = 0;
            cameraInstruction.textContent = "Look straight at the camera...";
            
            detectionInterval = setInterval(async () => {
                const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                                                .withFaceLandmarks()
                                                .withFaceDescriptor();

                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                if (detections) {
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    faceapi.draw.drawDetections(canvas, resizedDetections);

                    registrationDescriptors.push(detections.descriptor);
                    scans++;
                    scanFeedback.textContent = `${scans} / 5 scans complete`;
                    cameraInstruction.textContent = `Great! ${scans} / 5`;

                    if (scans >= 5) {
                        stopCamera();
                        scanFeedback.textContent = "Face scan successful! You can now register.";
                        registerBtn.disabled = false;
                        showMessage("Scan successful", 'success');
                    }
                }
            }, 1000);
        });

        registerBtn.addEventListener('click', async () => {
            const name = registerNameInput.value;
            const email = registerEmailInput.value;
            const phone = registerPhoneInput.value; // New
            const password = registerPasswordInput.value;

            if (!name || !email || !password || !phone) { // phone is also required
                return showMessage("Please fill in all fields", 'error');
            }
            if (registrationDescriptors.length < 5) {
                return showMessage("Please scan your face first", 'error');
            }

            try {
                const { data: existingUser, error: checkError } = await supabase
                    .from('users')
                    .select('email')
                    .eq('email', email)
                    .single();

                if (existingUser) {
                    return showMessage("This email is already registered", 'error');
                }
                
                if (checkError && checkError.code !== 'PGRST116') throw checkError;

                const serializableDescriptors = registrationDescriptors.map(d => Array.from(d));

                // **FIX:** Using 'supabase'
                // **UPDATE:** 'phone' field was added
                const { error: insertError } = await supabase
                    .from('users')
                    .insert({ 
                        name: name,
                        email: email,
                        password: password, 
                        phone: phone, // new field
                        face_descriptors: serializableDescriptors 
                    });

                if (insertError) throw insertError;
                
                // **** MODIFIED MESSAGE FOR EMAIL CONFIRMATION ****
                showMessage("Registration successful! An administrator must approve your account before you can log in.", 'success');
                showView('login');
                
                registerNameInput.value = "";
                registerEmailInput.value = "";
                registerPhoneInput.value = "";
                registerPasswordInput.value = "";
                registrationDescriptors = [];
                scanFeedback.textContent = "";

            } catch (error) {
                console.error("Registration error:", error);
                showMessage(`Registration error: ${error.message}`, 'error');
            }
        });

        /* --- NEW: Login Logic (Updated) --- */
        loginWithFaceBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            if (!email) {
                return showMessage("Please enter your email address", 'error');
            }

            try {
                // **FIX:** Using 'supabase'
                // **** MODIFICATION: Added 'email_confirmed_at' to the select query ****
                const { data: userData, error: fetchError } = await supabase
                    .from('users')
                    .select('name, face_descriptors, password, email_confirmed_at') // Get password (optional) and confirmation status
                    .eq('email', email)
                    .single();

                if (fetchError) {
                    if (fetchError.code === 'PGRST116') {
                        return showMessage("No account found for this email", 'error');
                    }
                    throw fetchError;
                }

                if (!userData || !userData.face_descriptors) {
                    return showMessage("Account not found or no face data exists", 'error');
                }

                // **** NEW: EMAIL CONFIRMATION CHECK ****
                // This requires an 'email_confirmed_at' (timestamp) column in your 'users' table.
                if (!userData.email_confirmed_at) {
                    return showMessage("Your email has not been confirmed. Please check your inbox or contact an administrator.", 'error');
                }
                // *****************************************

                const descriptors = userData.face_descriptors.map(d => new Float32Array(d));
                const labeledFaceDescriptors = new faceapi.LabeledFaceDescriptors(email, descriptors);
                const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5); 

                const displaySize = await startCamera();
                if (!displaySize) return;

                cameraInstruction.textContent = "Logging in... Look at the camera";

                detectionInterval = setInterval(async () => {
                    const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                                                    .withFaceLandmarks()
                                                    .withFaceDescriptor();
                    
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    
                    if (detections) {
                        const resizedDetections = faceapi.resizeResults(detections, displaySize);
                        faceapi.draw.drawDetections(canvas, resizedDetections);
                        
                        const bestMatch = faceMatcher.findBestMatch(detections.descriptor);
                        
                        if (bestMatch.label === email) {
                            // *** Successful Login ***
                            stopCamera();
                            
                            // Bring the original admin.html login logic here
                            loginModal.classList.add('hidden', 'opacity-0');
                            mainContent.classList.remove('hidden');
                            initTheme(); // setting dark mode
                            
                            showMessage("Login successful!", 'success');
                            loginEmailInput.value = ""; 
                        
                        } else {
                            cameraInstruction.textContent = "Face does not match...";
                        }
                    } else {
                        cameraInstruction.textContent = "No face detected...";
                    }
                }, 700);

            } catch (error) {
                console.error("Login error:", error);
                showMessage(`Login error: ${error.message}`, 'error');
            }
        });

        /* --- NEW: Logout Logic --- */
        logoutBtn.addEventListener('click', () => {
            // Hide admin panel and show login modal again
            mainContent.classList.add('hidden');
            loginModal.classList.remove('hidden', 'opacity-0');
            showView('login'); // reset to login view
            showMessage("You have been logged out successfully", 'info');
        });


        /* =========================================================
         ORIGINAL ADMIN.HTML JAVASCRIPT (Paper Management, etc.)
         (This code is not related to face recognition)
        =========================================================
        */

        /* --- TAB SWITCHING WITH ANIMATION --- */
        function switchTab(activeTab, activeSection, inactiveTab, inactiveSection) {
            activeTab.classList.add('tab-active');
            inactiveTab.classList.remove('tab-active');
            inactiveSection.classList.add('section-hidden');
            inactiveSection.classList.remove('section-visible');
            activeSection.classList.remove('section-hidden');
            activeSection.classList.add('section-visible');
        }

        dataEntryTab.addEventListener('click', function() {
            switchTab(dataEntryTab, dataEntrySection, dataEditTab, dataManagementSection);
        });

        dataEditTab.addEventListener('click', function() {
            switchTab(dataEditTab, dataManagementSection, dataEntryTab, dataEntrySection);
            loadPapers();
        });
        /* ------------------------------------- */

        // Helper function to load subjects
        async function loadSubjectsForStream(stream, targetSelect) {
            targetSelect.innerHTML = '<option value="">Loading...</option>';
            targetSelect.disabled = true;

            if (!stream) {
                targetSelect.innerHTML = targetSelect.id === 'subject' ? 
                    '<option value="">First select a stream</option>' : 
                    '<option value="">All Subjects (Select Stream First)</option>';
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('subjects')
                    .select('*')
                    .eq('stream', stream)
                    .order('name');
                
                if (error) throw error;
                
                targetSelect.innerHTML = targetSelect.id === 'subject' ? 
                    '<option value="">Select subject</option>' :
                    '<option value="">All Subjects</option>';
                    
                data.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.code;
                    option.textContent = subject.name;
                    targetSelect.appendChild(option);
                });
                
                targetSelect.disabled = false;
            } catch (error) {
                console.error('Error fetching subjects:', error);
                targetSelect.innerHTML = '<option value="">Error loading subjects</option>';
            }
        }

        // Data Entry Stream change event
        streamSelect.addEventListener('change', function() {
            loadSubjectsForStream(this.value, subjectSelect);
        });

        /* --- DATA MANAGEMENT FILTERS (NEW) --- */
        filterStream.addEventListener('change', function() {
            loadPapers();
            loadSubjectsForStream(this.value, filterSubject);
        });

        filterSubject.addEventListener('change', function() {
            loadPapers();
        });
        /* -------------------------------------- */


        // Load papers (Refactored to handle new filterSubject)
        async function loadPapers() {
            loadingMessage.classList.remove('hidden');
            papersList.innerHTML = '';
            
            try {
                let query = supabase
                    .from('past_papers')
                    .select('*')
                    .order('year', { ascending: false });
                
                if (filterStream.value) query = query.eq('stream', filterStream.value);
                if (filterYear.value) query = query.eq('year', parseInt(filterYear.value));
                if (filterSubject.value) query = query.eq('subject_code', filterSubject.value);
                
                const { data, error } = await query;
                if (error) throw error;
                
                allPapers = data || [];
                filterPapers(); // Client-side search and display
            } catch (error) {
                console.error('Error fetching papers:', error);
                papersList.innerHTML = '<div class="text-center text-red-500 dark:text-red-400 py-4">Unable to fetch papers</div>';
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        // Display papers (with animation class)
        function displayPapers(papers) {
            papersList.innerHTML = '';
            
            if (papers.length === 0) {
                papersList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">No papers found matching criteria.</p>';
                return;
            }
            
            papers.forEach((paper, index) => {
                const paperElement = document.createElement('div');
                paperElement.className = 'paper-item border border-gray-200 dark:border-gray-700 rounded-xl p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 shadow-md';
                paperElement.style.animationDelay = `${index * 0.05}s`;
                
                const deleteAction = `showDeleteModal('${paper.id}')`;

                paperElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-emerald-700 dark:text-emerald-300">${paper.subject_name} - ${paper.year}</h3>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">${paper.stream} â€¢ ${paper.subject_code}</p>
                            <div class="mt-3 space-y-1">
                                <a href="${paper.paper_link}" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline block text-sm font-medium">
                                    <i class="fas fa-file-pdf w-4 text-center mr-2"></i>Paper Link
                                </a>
                                ${paper.marking_scheme_link ? 
                                    `<a href="${paper.marking_scheme_link}" target="_blank" class="text-green-600 dark:text-green-400 hover:underline block text-sm font-medium">
                                        <i class="fas fa-check-circle w-4 text-center mr-2"></i>Marking Scheme
                                    </a>` : 
                                    '<span class="text-gray-500 dark:text-gray-500 text-sm"><i class="fas fa-times-circle w-4 text-center mr-2"></i>No Marking Scheme</span>'
                                }
                            </div>
                            <p class="text-xs text-gray-400 mt-2">ID: ${paper.id.substring(0, 8)}...</p>
                        </div>
                        <div class="flex flex-col gap-2 ml-4">
                            <button onclick="editPaper('${paper.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm transition-colors shadow-sm">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="${deleteAction}" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors shadow-sm">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                papersList.appendChild(paperElement);
            });
        }

        // Form submission - UPDATED FOR MULTI-STREAM SUBJECTS
        paperForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const subjectCode = subjectSelect.value;
            const isMultiStreamSubject = ['ict', 'agriculture', 'geography'].includes(subjectCode);
            
            let formDataArray = [];
            
            if (isMultiStreamSubject) {
                const streams = ['science', 'commerce', 'arts', 'technology'];
                streams.forEach(stream => {
                    formDataArray.push({
                        stream: stream,
                        subject_code: subjectCode,
                        subject_name: subjectSelect.options[subjectSelect.selectedIndex].text,
                        year: parseInt(document.getElementById('year').value),
                        paper_link: document.getElementById('paperLink').value,
                        marking_scheme_link: document.getElementById('markingLink').value || null
                    });
                });
            } else {
                formDataArray.push({
                    stream: streamSelect.value,
                    subject_code: subjectCode,
                    subject_name: subjectSelect.options[subjectSelect.selectedIndex].text,
                    year: parseInt(document.getElementById('year').value),
                    paper_link: document.getElementById('paperLink').value,
                    marking_scheme_link: document.getElementById('markingLink').value || null
                });
            }
            
            setFormLoading(true);
            
            try {
                if (editingPaperId) {
                    const { error } = await supabase
                        .from('past_papers')
                        .update(formDataArray[0])
                        .eq('id', editingPaperId);
                    
                    if (error) throw error;
                    showNotification('Paper updated successfully', 'success');
                    resetForm();
                } else {
                    const { error } = await supabase
                        .from('past_papers')
                        .insert(formDataArray);
                    
                    if (error) throw error;
                    const message = isMultiStreamSubject ? 
                        `Paper added to all streams successfully (${formDataArray.length} entries)` : 
                        'Paper added successfully';
                    showNotification(message, 'success');
                    resetForm();
                }
                
                if (dataEditTab.classList.contains('tab-active')) {
                    loadPapers();
                }
            } catch (error) {
                console.error('Error saving paper:', error);
                showNotification('Error: ' + error.message, 'error');
            } finally {
                setFormLoading(false);
            }
        });

        // Edit paper
        window.editPaper = async function(paperId) {
            try {
                const { data, error } = await supabase
                    .from('past_papers')
                    .select('*')
                    .eq('id', paperId)
                    .single();
                
                if (error) throw error;
                
                streamSelect.value = data.stream;
                await loadSubjectsForStream(data.stream, subjectSelect);
                subjectSelect.value = data.subject_code;
                
                document.getElementById('year').value = data.year;
                document.getElementById('paperLink').value = data.paper_link;
                document.getElementById('markingLink').value = data.marking_scheme_link || '';
                
                editingPaperId = paperId;
                updateBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
                formTitle.textContent = 'Edit Past Paper (ID: ' + paperId.substring(0, 8) + '...)';
                
                dataEntryTab.click();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Error editing paper:', error);
                showNotification('Unable to fetch paper details for editing.', 'error');
            }
        };

        // Delete paper
        window.deletePaper = async function(paperId) {
            try {
                const { error } = await supabase
                    .from('past_papers')
                    .delete()
                    .eq('id', paperId);
                
                if (error) throw error;
                showNotification('Paper deleted successfully', 'success');
                loadPapers();
            } catch (error) {
                console.error('Error deleting paper:', error);
                showNotification('Unable to delete paper.', 'error');
            }
        };

        // Reset form
        function resetForm() {
            paperForm.reset();
            subjectSelect.innerHTML = '<option value="">First select a stream</option>';
            subjectSelect.disabled = true;
            editingPaperId = null;
            updateBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            submitBtn.classList.remove('hidden');
            formTitle.textContent = 'Add New Past Paper';
        }

        // Set form loading state
        function setFormLoading(loading) {
            const button = editingPaperId ? updateBtn : submitBtn;
            const spinner = editingPaperId ? updateSpinner : submitSpinner;
            const textSpan = editingPaperId ? updateBtnText : submitBtnText;

            if (loading) {
                paperForm.classList.add('loading');
                button.disabled = true;
                spinner.classList.remove('hidden');
                textSpan.textContent = editingPaperId ? 'Updating...' : 'Adding...';
            } else {
                paperForm.classList.remove('loading');
                button.disabled = false;
                spinner.classList.add('hidden');
                textSpan.textContent = editingPaperId ? 'Update Paper' : 'Add Past Paper';
            }
        }

        cancelBtn.addEventListener('click', function() { resetForm(); });
        searchInput.addEventListener('input', function() { filterPapers(); });
        filterStream.addEventListener('change', function() { loadSubjectsForStream(this.value, filterSubject); loadPapers(); });
        filterSubject.addEventListener('change', function() { filterPapers(); });
        filterYear.addEventListener('change', function() { filterPapers(); });
        
        // Filter papers (Client-side)
        function filterPapers() {
            const searchTerm = searchInput.value.toLowerCase();
            const streamFilter = filterStream.value;
            const subjectFilter = filterSubject.value;
            const yearFilter = filterYear.value;
            
            let filteredPapers = allPapers;
            
            if (streamFilter) filteredPapers = filteredPapers.filter(paper => paper.stream === streamFilter);
            if (subjectFilter) filteredPapers = filteredPapers.filter(paper => paper.subject_code === subjectFilter);
            if (yearFilter) filteredPapers = filteredPapers.filter(paper => paper.year.toString() === yearFilter);
            if (searchTerm) {
                filteredPapers = filteredPapers.filter(paper => 
                    paper.subject_name.toLowerCase().includes(searchTerm) ||
                    paper.subject_code.toLowerCase().includes(searchTerm) ||
                    paper.stream.toLowerCase().includes(searchTerm) ||
                    paper.year.toString().includes(searchTerm)
                );
            }
            displayPapers(filteredPapers);
        }

        /* --- Custom Notification and Confirmation Modal (Original) --- */
        const notificationContainer = document.createElement('div');
        notificationContainer.id = 'notificationContainer';
        notificationContainer.className = 'fixed top-4 right-4 z-[100] space-y-2';
        document.body.appendChild(notificationContainer);

        function showNotification(message, type = 'info') {
            const div = document.createElement('div');
            let bgColor, icon;
            
            switch (type) {
                case 'success': bgColor = 'bg-green-500'; icon = 'fas fa-check-circle'; break;
                case 'error': bgColor = 'bg-red-500'; icon = 'fas fa-exclamation-triangle'; break;
                default: bgColor = 'bg-blue-500'; icon = 'fas fa-info-circle'; break;
            }

            div.className = `${bgColor} text-white p-4 rounded-lg shadow-xl transition-all duration-500 transform translate-x-full opacity-0`;
            div.innerHTML = `<div class="flex items-center"><i class="${icon} mr-2"></i><span>${message}</span></div>`;
            notificationContainer.appendChild(div);

            setTimeout(() => { div.classList.remove('translate-x-full', 'opacity-0'); div.classList.add('translate-x-0', 'opacity-100'); }, 10);
            setTimeout(() => {
                div.classList.remove('translate-x-0', 'opacity-100');
                div.classList.add('translate-x-full', 'opacity-0');
                div.addEventListener('transitionend', () => div.remove());
            }, 4000);
        }
        
        const modalHtml = `
            <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-70 z-[90] flex items-center justify-center hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-sm w-full transition-all duration-300 transform scale-95 opacity-0">
                    <h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-3">Confirm Deletion</h3>
                    <p id="modalMessage" class="text-gray-700 dark:text-gray-300 mb-6">Are you sure you want to delete this paper?</p>
                    <div class="flex justify-end gap-3">
                        <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition-colors">Cancel</button>
                        <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">Delete</button>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const deleteModal = document.getElementById('deleteModal');
        const modalDialog = deleteModal.querySelector('div');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        let currentPaperIdToDelete = null;

        window.showDeleteModal = function(paperId) {
            currentPaperIdToDelete = paperId;
            deleteModal.classList.remove('hidden');
            setTimeout(() => {
                deleteModal.style.opacity = '1';
                modalDialog.classList.remove('scale-95', 'opacity-0');
                modalDialog.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        function hideDeleteModal() {
            modalDialog.classList.remove('scale-100', 'opacity-100');
            modalDialog.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                deleteModal.classList.add('hidden');
                deleteModal.style.opacity = '0';
                currentPaperIdToDelete = null;
            }, 300);
        }

        cancelDeleteBtn.addEventListener('click', hideDeleteModal);
        
        confirmDeleteBtn.addEventListener('click', function() {
            if (currentPaperIdToDelete) {
                window.deletePaper(currentPaperIdToDelete);
            }
            hideDeleteModal();
        });


        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // First, start loading AI models
            loadModels();
            // loginModal.classList.remove('hidden'); // loadModels() does this
            // initTheme(); // This is done after login
        });
    </script>
</body>
</html>
