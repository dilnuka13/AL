<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - DE Education</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .tab-active {
            background-color: #059669;
            color: white;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen p-6">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-emerald-800">Admin Login</h2>
                <p class="text-gray-600">Enter your credentials to access the system</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="email" class="block text-gray-700 mb-2">Email</label>
                    <input type="email" id="email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" required>
                </div>
                <div>
                    <label for="password" class="block text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" required>
                </div>
                <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    Login
                </button>
            </form>
            <p id="loginError" class="text-red-500 text-center mt-4 hidden">Invalid email or password</p>
        </div>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div id="mainContent" class="hidden">
        <div class="max-w-6xl mx-auto">
            <header class="text-center mb-8">
                <div class="flex items-center justify-center mb-4">
                    <div class="w-12 h-12 bg-emerald-600 rounded-lg flex items-center justify-center text-white font-bold text-xl mr-3">
                        DE
                    </div>
                    <h1 class="text-3xl font-bold text-emerald-800">Education.lk</h1>
                </div>
                <p class="text-gray-600">Past Papers Management</p>
            </header>

            <!-- Tabs -->
            <div class="bg-white rounded-xl shadow-md p-1 mb-6">
                <div class="flex">
                    <button id="dataEntryTab" class="flex-1 py-3 px-4 rounded-lg font-medium transition-colors tab-active">
                        Data Entry
                    </button>
                    <button id="dataEditTab" class="flex-1 py-3 px-4 rounded-lg font-medium transition-colors">
                        Data Management
                    </button>
                </div>
            </div>

            <!-- Data Entry Section -->
            <div id="dataEntrySection" class="bg-white rounded-xl shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-emerald-800 mb-4" id="formTitle">Add New Past Paper</h2>
                
                <form id="paperForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="stream" class="block text-gray-700 mb-2">Stream</label>
                            <select id="stream" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" required>
                                <option value="">Select</option>
                                <option value="science">Science</option>
                                <option value="commerce">Commerce</option>
                                <option value="arts">Arts</option>
                                <option value="technology">Technology</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="subject" class="block text-gray-700 mb-2">Subject</label>
                            <select id="subject" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" required disabled>
                                <option value="">First select a stream</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="year" class="block text-gray-700 mb-2">Year</label>
                        <input type="number" id="year" min="2000" max="2030" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" required>
                    </div>
                    
                    <div>
                        <label for="paperLink" class="block text-gray-700 mb-2">Paper Link</label>
                        <input type="url" id="paperLink" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" required placeholder="https://drive.google.com/file/d/...">
                    </div>
                    
                    <div>
                        <label for="markingLink" class="block text-gray-700 mb-2">Marking Scheme Link (Optional)</label>
                        <input type="url" id="markingLink" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" placeholder="https://drive.google.com/file/d/...">
                    </div>
                    
                    <div class="flex gap-4">
                        <button type="submit" id="submitBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex-1">
                            Add Past Paper
                        </button>
                        <button type="button" id="updateBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex-1 hidden">
                            Update
                        </button>
                        <button type="button" id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors flex-1 hidden">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- Data Management Section -->
            <div id="dataManagementSection" class="bg-white rounded-xl shadow-md p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-emerald-800">Existing Past Papers</h2>
                    <button onclick="loadPapers()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-refresh mr-2"></i>Refresh
                    </button>
                </div>
                
                <div class="mb-4 flex flex-col md:flex-row gap-4">
                    <input type="text" id="searchPapers" placeholder="Search papers..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300">
                    <select id="filterStream" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300">
                        <option value="">All Streams</option>
                        <option value="science">Science</option>
                        <option value="commerce">Commerce</option>
                        <option value="arts">Arts</option>
                        <option value="technology">Technology</option>
                    </select>
                    <select id="filterYear" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300">
                        <option value="">All Years</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                        <option value="2017">2017</option>
                        <option value="2016">2016</option>  
                        <option value="2015">2015</option>
                        <option value="2014">2014</option>
                        <option value="2013">2013</option>
                        <option value="2012">2012</option>
                        <option value="2011">2011</option>
                        <option value="2010">2010</option>
                        
                    </select>
                </div>
                
                <div id="loadingMessage" class="text-center text-gray-500 py-4 hidden">
                    <p>Loading papers...</p>
                </div>
                
                <div id="papersList" class="space-y-4">
                    <!-- Papers list will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://hppojrbfhzttzvlvovre.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcG9qcmJmaHp0dHp2bHZvdnJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODgxNDYsImV4cCI6MjA3Njc2NDE0Nn0.aL2fegb_eRPY0E7P6Mwufhq3TCAeX8-hDCHBo9VeAsA';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // DOM elements
        const loginModal = document.getElementById('loginModal');
        const mainContent = document.getElementById('mainContent');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const dataEntryTab = document.getElementById('dataEntryTab');
        const dataEditTab = document.getElementById('dataEditTab');
        const dataEntrySection = document.getElementById('dataEntrySection');
        const dataManagementSection = document.getElementById('dataManagementSection');
        const streamSelect = document.getElementById('stream');
        const subjectSelect = document.getElementById('subject');
        const paperForm = document.getElementById('paperForm');
        const submitBtn = document.getElementById('submitBtn');
        const updateBtn = document.getElementById('updateBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const formTitle = document.getElementById('formTitle');
        const searchInput = document.getElementById('searchPapers');
        const filterStream = document.getElementById('filterStream');
        const filterYear = document.getElementById('filterYear');
        const papersList = document.getElementById('papersList');
        const loadingMessage = document.getElementById('loadingMessage');

        let editingPaperId = null;
        let allPapers = [];

        // Admin credentials
        const adminEmail = 'isaradilnuka2005@gmail.com';
        const adminPassword = 'AAID2005$$';

        // Login form submission
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (email === adminEmail && password === adminPassword) {
                // Successful login
                loginModal.classList.add('hidden');
                mainContent.classList.remove('hidden');
            } else {
                // Failed login
                loginError.classList.remove('hidden');
            }
        });

        // Tab switching
        dataEntryTab.addEventListener('click', function() {
            dataEntryTab.classList.add('tab-active');
            dataEditTab.classList.remove('tab-active');
            dataEntrySection.classList.remove('hidden');
            dataManagementSection.classList.add('hidden');
        });

        dataEditTab.addEventListener('click', function() {
            dataEditTab.classList.add('tab-active');
            dataEntryTab.classList.remove('tab-active');
            dataManagementSection.classList.remove('hidden');
            dataEntrySection.classList.add('hidden');
            loadPapers();
        });

        // Stream change event
        streamSelect.addEventListener('change', async function() {
            const stream = this.value;
            
            if (!stream) {
                subjectSelect.innerHTML = '<option value="">First select a stream</option>';
                subjectSelect.disabled = true;
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('subjects')
                    .select('*')
                    .eq('stream', stream)
                    .order('name');
                
                if (error) throw error;
                
                subjectSelect.innerHTML = '<option value="">Select subject</option>';
                data.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.code;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
                
                subjectSelect.disabled = false;
            } catch (error) {
                console.error('Error fetching subjects:', error);
                alert('Unable to fetch subjects');
            }
        });

        // Load papers
        async function loadPapers() {
            loadingMessage.classList.remove('hidden');
            papersList.innerHTML = '';
            
            try {
                let query = supabase
                    .from('past_papers')
                    .select('*')
                    .order('year', { ascending: false });
                
                // Filter by stream
                if (filterStream.value) {
                    query = query.eq('stream', filterStream.value);
                }
                
                // Filter by year
                if (filterYear.value) {
                    query = query.eq('year', parseInt(filterYear.value));
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                allPapers = data || [];
                displayPapers(allPapers);
            } catch (error) {
                console.error('Error fetching papers:', error);
                papersList.innerHTML = '<div class="text-center text-red-500 py-4">Unable to fetch papers</div>';
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        // Display papers
        function displayPapers(papers) {
            papersList.innerHTML = '';
            
            if (papers.length === 0) {
                papersList.innerHTML = '<p class="text-center text-gray-500 py-4">No papers found</p>';
                return;
            }
            
            papers.forEach(paper => {
                const paperElement = document.createElement('div');
                paperElement.className = 'border border-gray-200 rounded-lg p-4 hover:bg-gray-50';
                paperElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-800">${paper.subject_name} - ${paper.year}</h3>
                            <p class="text-gray-600 text-sm">${paper.stream} â€¢ ${paper.subject_code}</p>
                            <div class="mt-2 space-y-1">
                                <a href="${paper.paper_link}" target="_blank" class="text-blue-600 hover:underline block">
                                    <i class="fas fa-file-pdf mr-1"></i>Paper Link
                                </a>
                                ${paper.marking_scheme_link ? 
                                    `<a href="${paper.marking_scheme_link}" target="_blank" class="text-green-600 hover:underline block">
                                        <i class="fas fa-check-circle mr-1"></i>Marking Scheme Link
                                    </a>` : 
                                    '<span class="text-gray-500 text-sm"><i class="fas fa-times-circle mr-1"></i>No Marking Scheme</span>'
                                }
                            </div>
                            <p class="text-xs text-gray-400 mt-2">ID: ${paper.id.substring(0, 8)}...</p>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="editPaper('${paper.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button onclick="deletePaper('${paper.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </div>
                    </div>
                `;
                papersList.appendChild(paperElement);
            });
        }

        // Form submission
        paperForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                stream: streamSelect.value,
                subject_code: subjectSelect.value,
                subject_name: subjectSelect.options[subjectSelect.selectedIndex].text,
                year: parseInt(document.getElementById('year').value),
                paper_link: document.getElementById('paperLink').value,
                marking_scheme_link: document.getElementById('markingLink').value || null
            };
            
            // Disable form
            setFormLoading(true);
            
            try {
                if (editingPaperId) {
                    // Update
                    const { error } = await supabase
                        .from('past_papers')
                        .update(formData)
                        .eq('id', editingPaperId);
                    
                    if (error) throw error;
                    
                    alert('Paper updated successfully');
                    resetForm();
                } else {
                    // Add new
                    const { error } = await supabase
                        .from('past_papers')
                        .insert([formData]);
                    
                    if (error) throw error;
                    
                    alert('Paper added successfully');
                    resetForm();
                }
                
                // Refresh list
                loadPapers();
            } catch (error) {
                console.error('Error saving paper:', error);
                alert('Unable to save paper: ' + error.message);
            } finally {
                setFormLoading(false);
            }
        });

        // Edit paper
        window.editPaper = async function(paperId) {
            try {
                const { data, error } = await supabase
                    .from('past_papers')
                    .select('*')
                    .eq('id', paperId)
                    .single();
                
                if (error) throw error;
                
                // Fill form
                streamSelect.value = data.stream;
                
                // Load and select subjects
                await loadSubjectsForStream(data.stream);
                subjectSelect.value = data.subject_code;
                
                document.getElementById('year').value = data.year;
                document.getElementById('paperLink').value = data.paper_link;
                document.getElementById('markingLink').value = data.marking_scheme_link || '';
                
                // Set edit mode
                editingPaperId = paperId;
                updateBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
                formTitle.textContent = 'Edit Past Paper';
                
                // Switch to data entry tab
                dataEntryTab.click();
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Error editing paper:', error);
                alert('Unable to edit paper');
            }
        };

        // Load subjects for stream
        async function loadSubjectsForStream(stream) {
            try {
                const { data, error } = await supabase
                    .from('subjects')
                    .select('*')
                    .eq('stream', stream)
                    .order('name');
                
                if (error) throw error;
                
                subjectSelect.innerHTML = '<option value="">Select subject</option>';
                data.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.code;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
                
                subjectSelect.disabled = false;
            } catch (error) {
                console.error('Error fetching subjects:', error);
            }
        }

        // Delete paper
        window.deletePaper = async function(paperId) {
            if (!confirm('Are you sure you want to delete this paper?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('past_papers')
                    .delete()
                    .eq('id', paperId);
                
                if (error) throw error;
                
                alert('Paper deleted successfully');
                loadPapers();
            } catch (error) {
                console.error('Error deleting paper:', error);
                alert('Unable to delete paper');
            }
        };

        // Reset form
        function resetForm() {
            paperForm.reset();
            subjectSelect.disabled = true;
            editingPaperId = null;
            updateBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            submitBtn.classList.remove('hidden');
            formTitle.textContent = 'Add New Past Paper';
        }

        // Set form loading state
        function setFormLoading(loading) {
            if (loading) {
                paperForm.classList.add('loading');
                submitBtn.disabled = true;
                updateBtn.disabled = true;
            } else {
                paperForm.classList.remove('loading');
                submitBtn.disabled = false;
                updateBtn.disabled = false;
            }
        }

        // Cancel button
        cancelBtn.addEventListener('click', function() {
            resetForm();
        });

        // Search and filter
        searchInput.addEventListener('input', function() {
            filterPapers();
        });

        filterStream.addEventListener('change', function() {
            loadPapers();
        });

        filterYear.addEventListener('change', function() {
            loadPapers();
        });

        // Filter papers
        function filterPapers() {
            const searchTerm = searchInput.value.toLowerCase();
            const streamFilter = filterStream.value;
            const yearFilter = filterYear.value;
            
            let filteredPapers = allPapers;
            
            // Filter by stream
            if (streamFilter) {
                filteredPapers = filteredPapers.filter(paper => paper.stream === streamFilter);
            }
            
            // Filter by year
            if (yearFilter) {
                filteredPapers = filteredPapers.filter(paper => paper.year.toString() === yearFilter);
            }
            
            // Filter by search term
            if (searchTerm) {
                filteredPapers = filteredPapers.filter(paper => 
                    paper.subject_name.toLowerCase().includes(searchTerm) ||
                    paper.subject_code.toLowerCase().includes(searchTerm) ||
                    paper.stream.toLowerCase().includes(searchTerm) ||
                    paper.year.toString().includes(searchTerm)
                );
            }
            
            displayPapers(filteredPapers);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Show login modal by default
            loginModal.classList.remove('hidden');
        });
    </script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>
