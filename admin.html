<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - DE Education</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <!-- Markdown & Syntax Highlighting for AI Chat -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Noto+Sinhala:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        sinhala: ['Noto Sinhala', 'sans-serif'],
                    },
                    colors: {
                        emerald: {
                            50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399',
                            500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b', 950: '#022c22',
                        },
                        dark: {
                            bg: '#0B1120',
                            card: 'rgba(21, 31, 50, 0.7)',
                            border: 'rgba(255, 255, 255, 0.08)'
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'blob': 'blob 10s infinite',
                        'scan': 'scan 1.5s linear infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        scan: {
                            '0%': { top: '0%', opacity: '0' },
                            '50%': { opacity: '1' },
                            '100%': { top: '100%', opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(16, 185, 129, 0.5); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        
        /* Glassmorphism */
        .glass {
            background: rgba(21, 31, 50, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }

        .scan-line {
            width: 100%; height: 2px; background: #10b981; position: absolute;
            animation: scan 1.5s linear infinite; box-shadow: 0 0 10px #10b981;
        }

        /* Markdown Styles for AI Chat */
        .prose pre { background: #1e1e1e; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; border: 1px solid rgba(255,255,255,0.1); }
        .prose code { color: #e0e0e0; font-family: monospace; }
        .prose p { margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
    </style>
</head>
<body class="min-h-screen bg-[#0B1120] text-gray-200 font-sans selection:bg-emerald-500/30 overflow-hidden flex flex-col">
    
    <!-- BACKGROUND EFFECTS -->
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none bg-[#0B1120]">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-purple-900/20 rounded-full blur-[120px] animate-blob mix-blend-screen"></div>
        <div class="absolute top-[20%] right-[-10%] w-[40%] h-[60%] bg-emerald-900/20 rounded-full blur-[120px] animate-blob animation-delay-2000 mix-blend-screen"></div>
        <div class="absolute bottom-[-20%] left-[20%] w-[50%] h-[50%] bg-blue-900/20 rounded-full blur-[120px] animate-blob animation-delay-4000 mix-blend-screen"></div>
        <div class="absolute inset-0 opacity-20 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')]"></div>
    </div>

    <!-- LOADING SCREEN -->
    <div id="loader-view" class="fixed inset-0 z-[100] bg-[#0B1120] flex flex-col items-center justify-center">
        <div class="relative w-24 h-24 mb-4">
            <div class="absolute inset-0 border-4 border-white/10 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-emerald-500 rounded-full border-t-transparent animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fas fa-shield-alt text-3xl text-emerald-500 animate-pulse"></i>
            </div>
        </div>
        <h2 class="text-xl font-bold tracking-widest text-white uppercase">Initializing</h2>
        <p class="text-xs text-gray-500 mt-2 font-mono">Loading Security Protocols...</p>
    </div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center transition-all duration-500 opacity-0 pointer-events-none p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="glass w-full max-w-md p-8 rounded-3xl relative z-10 shadow-2xl border border-white/10 transform transition-all hover:scale-[1.01]">
            
            <div id="view-login" class="animate__animated animate__fadeIn">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-emerald-500/10 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-emerald-500/10 mb-4 animate-float border border-emerald-500/20">
                        <i class="fas fa-fingerprint text-3xl text-emerald-500"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-white">Admin Portal</h1>
                    <p class="text-sm text-gray-400 mt-2">Biometric Access Required</p>
                </div>

                <div class="space-y-5">
                    <div class="group">
                        <label class="text-xs font-bold text-gray-500 uppercase ml-1 mb-1 block">Email Address</label>
                        <div class="relative">
                            <i class="fas fa-envelope absolute left-4 top-4 text-gray-500"></i>
                            <input type="email" id="login-email" class="w-full pl-11 pr-4 py-3.5 rounded-xl bg-black/20 border border-white/10 focus:border-emerald-500 focus:bg-black/40 outline-none transition-all text-white placeholder-gray-600" placeholder="admin@deeducation.lk">
                        </div>
                    </div>
                    
                    <button id="login-btn" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold shadow-lg shadow-emerald-900/20 transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2 group">
                        <i class="fas fa-camera group-hover:animate-pulse"></i> 
                        <span>Verify Identity</span>
                    </button>
                    
                    <div class="text-center pt-4 border-t border-white/5">
                        <p class="text-xs text-gray-500">Super Admin? <a href="#" onclick="switchView('secret')" class="text-emerald-500 hover:underline font-bold">Use Secret Key</a></p>
                    </div>
                    <div id="login-msg" class="h-6 text-center text-xs font-mono text-red-400 font-bold mt-2"></div>
                </div>
            </div>

            <!-- Secret Key View -->
            <div id="view-secret" class="hidden animate__animated animate__fadeIn">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-yellow-500/10 rounded-2xl mx-auto flex items-center justify-center mb-4 border border-yellow-500/20">
                        <i class="fas fa-key text-3xl text-yellow-500"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white">Master Access</h2>
                </div>
                <div class="space-y-4">
                    <input type="password" id="admin-secret-input" class="w-full px-4 py-3 text-center tracking-[0.5em] text-xl font-bold rounded-xl bg-black/30 border border-white/10 focus:border-yellow-500 outline-none text-white placeholder-gray-700" placeholder="••••••••">
                    <button onclick="verifySecret()" class="w-full py-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded-xl font-bold shadow-lg transition-all">Verify</button>
                    <button onclick="switchView('login')" class="w-full py-2 text-sm text-gray-400 hover:text-white">Back</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CAMERA OVERLAY -->
    <div id="camera-modal" class="hidden fixed inset-0 z-[60] bg-black/95 flex flex-col items-center justify-center">
        <div class="relative w-full max-w-lg aspect-[4/3] bg-black rounded-3xl overflow-hidden border-2 border-emerald-500/50 shadow-[0_0_50px_rgba(16,185,129,0.2)]">
            <video id="video-feed" autoplay muted playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video>
            <canvas id="face-canvas" class="absolute inset-0 w-full h-full transform scale-x-[-1]"></canvas>
            <div class="scan-line"></div>
            <div class="absolute top-4 left-0 w-full text-center">
                <span class="bg-black/50 text-white px-3 py-1 rounded-full text-xs font-mono border border-white/20 backdrop-blur-md" id="camera-status-text">
                    <i class="fas fa-record-vinyl text-red-500 animate-pulse mr-2"></i>Scanning...
                </span>
            </div>
        </div>
        <button onclick="stopCamera()" class="mt-6 px-8 py-3 bg-gray-800 text-white rounded-full font-bold hover:bg-gray-700 border border-white/10 transition-all">Cancel Scan</button>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="mainContent" class="flex h-screen hidden overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <aside id="admin-sidebar" class="glass w-72 border-r border-white/5 flex flex-col z-30 transition-all duration-300 absolute lg:static h-full -translate-x-full lg:translate-x-0">
            <div class="p-6 border-b border-white/5 flex items-center gap-3">
                <div class="w-8 h-8 bg-emerald-500 rounded flex items-center justify-center text-white font-bold animate-pulse">DE</div>
                <div>
                    <h2 class="font-bold text-lg text-white leading-tight">Admin Portal</h2>
                    <span id="role-badge" class="text-[10px] bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded font-bold uppercase tracking-wider">Loading...</span>
                </div>
            </div>

            <div class="p-4 space-y-1 flex-1 overflow-y-auto custom-scrollbar">
                
                <!-- SUPER ADMIN ONLY LINKS -->
                <div id="super-admin-links" class="hidden">
                    <p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 mt-2">Overview</p>
                    <button onclick="showSection('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium">
                        <i class="fas fa-chart-line w-4"></i> Dashboard
                    </button>
                    
                    <p class="px-4 text-[10px] font-bold text-emerald-500 uppercase tracking-widest mb-2 mt-6">AI Command</p>
                    <button onclick="showSection('ai-chat')" id="nav-ai-chat" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-emerald-500/10 transition-all text-sm font-medium">
                        <i class="fas fa-sparkles w-4 text-emerald-400"></i> AI Assistant <span class="text-[9px] bg-emerald-500 text-white px-1.5 rounded ml-auto">NEW</span>
                    </button>

                    <p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 mt-6">Management</p>
                    <button onclick="showSection('timetables')" id="nav-timetables" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium">
                        <i class="fas fa-calendar-alt w-4"></i> Timetables & Events
                    </button>
                    <button onclick="showSection('notices')" id="nav-notices" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium">
                        <i class="fas fa-bullhorn w-4"></i> Alerts & Notices
                    </button>
                    <button onclick="showSection('settings')" id="nav-settings" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium">
                        <i class="fas fa-cogs w-4"></i> System Config
                    </button>
                    <button onclick="showSection('users')" id="nav-users" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium">
                        <i class="fas fa-users-cog w-4"></i> User Access
                    </button>
                </div>

                <!-- COMMON LINKS (Available to all) -->
                <p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 mt-6">Resources</p>
                <button onclick="showSection('papers')" id="nav-papers" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all text-sm font-medium">
                    <i class="fas fa-file-alt w-4"></i> Past Papers
                </button>
            </div>

            <div class="p-4 border-t border-white/5 bg-black/20">
                <div class="flex items-center gap-3">
                    <img id="user-avatar" src="" class="w-9 h-9 rounded-full border border-emerald-500/50">
                    <div class="overflow-hidden">
                        <p id="user-name-display" class="text-xs font-bold text-white truncate">User</p>
                        <button onclick="location.reload()" class="text-[10px] text-red-400 hover:underline">Sign Out</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto p-4 lg:p-8 relative w-full scroll-smooth">
            <!-- Mobile Header -->
            <div class="lg:hidden flex justify-between items-center mb-6 glass p-4 rounded-xl">
                <span class="font-bold text-white">DE Admin</span>
                <button onclick="document.getElementById('admin-sidebar').classList.toggle('-translate-x-full')" class="text-white"><i class="fas fa-bars"></i></button>
            </div>

            <!-- 1. DASHBOARD (Super Admin Only) -->
            <section id="dashboard-section" class="admin-section hidden animate__animated animate__fadeIn">
                <h1 class="text-2xl font-bold text-white mb-8">Dashboard Overview</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="glass p-6 rounded-2xl border-l-4 border-emerald-500">
                        <p class="text-xs text-gray-400 uppercase font-bold">Total Papers</p>
                        <p id="count-papers" class="text-3xl font-bold text-white mt-1">0</p>
                    </div>
                    <div class="glass p-6 rounded-2xl border-l-4 border-blue-500">
                        <p class="text-xs text-gray-400 uppercase font-bold">Paper Downloads</p>
                        <p id="count-paper-dl" class="text-3xl font-bold text-blue-400 mt-1">0</p>
                    </div>
                    <div class="glass p-6 rounded-2xl border-l-4 border-purple-500">
                        <p class="text-xs text-gray-400 uppercase font-bold">Marking Downloads</p>
                        <p id="count-marking-dl" class="text-3xl font-bold text-purple-400 mt-1">0</p>
                    </div>
                    <div class="glass p-6 rounded-2xl border-l-4 border-yellow-500">
                        <p class="text-xs text-gray-400 uppercase font-bold">Active Notices</p>
                        <p id="count-notices" class="text-3xl font-bold text-yellow-400 mt-1">0</p>
                    </div>
                </div>
                
                <div class="glass p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4">Download Statistics</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-400">
                            <thead class="text-xs text-gray-500 uppercase bg-white/5">
                                <tr>
                                    <th class="p-3">Subject</th>
                                    <th class="p-3 text-right">Paper DLs</th>
                                    <th class="p-3 text-right">Marking DLs</th>
                                </tr>
                            </thead>
                            <tbody id="stats-body" class="divide-y divide-white/5">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 2. AI CHAT (Super Admin Only) -->
            <section id="ai-chat-section" class="admin-section hidden animate__animated animate__fadeIn h-[calc(100vh-100px)] flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                            <i class="fas fa-sparkles text-emerald-400"></i> AI Command Center
                        </h1>
                        <p class="text-xs text-gray-400">Gemini 2.5 Flash + Imagen 3.0 • Super Admin Access</p>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="clearChat()" class="px-3 py-1.5 text-xs bg-white/5 hover:bg-red-500/20 text-gray-400 hover:text-red-400 rounded-lg transition-colors border border-white/5">Clear Chat</button>
                    </div>
                </div>

                <!-- Chat Container -->
                <div id="chat-messages" class="flex-1 glass rounded-2xl p-6 overflow-y-auto custom-scrollbar space-y-4 mb-4 bg-black/20">
                    <div class="text-center text-gray-500 mt-20">
                        <i class="fas fa-robot text-4xl mb-4 opacity-50"></i>
                        <p>How can I assist you today, Sir?</p>
                        <p class="text-xs mt-2">Try: "Generate an image of a physics lab", "Write HTML for a login form", "Analyze this file"</p>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="relative group">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-emerald-500 to-blue-500 rounded-2xl opacity-20 group-hover:opacity-40 transition duration-500 blur"></div>
                    <div class="relative flex gap-2 bg-[#0B1120] rounded-2xl p-2 border border-white/10">
                        <label for="file-upload" class="p-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl cursor-pointer transition-colors">
                            <i class="fas fa-paperclip"></i>
                            <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(this)">
                        </label>
                        <textarea id="chat-input" rows="1" placeholder="Type a command..." class="flex-1 bg-transparent text-white placeholder-gray-500 outline-none resize-none py-3 text-sm"></textarea>
                        <button onclick="sendChat()" id="send-btn" class="p-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold transition-all shadow-lg shadow-emerald-900/20">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- 3. PAPERS (All Admins) -->
            <section id="papers-section" class="admin-section hidden animate__animated animate__fadeIn">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-2xl font-bold text-white">Past Paper Library</h1>
                    <button onclick="document.getElementById('paper-form').classList.toggle('hidden')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg transition-all">
                        <i class="fas fa-plus"></i> Upload New
                    </button>
                </div>

                <div id="paper-form" class="hidden glass p-6 rounded-2xl mb-8 border border-emerald-500/30 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
                    <h3 class="text-lg font-bold text-white mb-4">Upload Resource</h3>
                    <form onsubmit="handlePaperUpload(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="p-subject" placeholder="Subject Name" class="bg-black/20 border border-white/10 rounded-xl p-3 text-white focus:border-emerald-500 outline-none" required>
                            <input type="text" id="p-code" placeholder="Subject Code" class="bg-black/20 border border-white/10 rounded-xl p-3 text-white focus:border-emerald-500 outline-none">
                            <input type="number" id="p-year" placeholder="Year" class="bg-black/20 border border-white/10 rounded-xl p-3 text-white focus:border-emerald-500 outline-none" required>
                            <select id="p-stream" class="bg-black/20 border border-white/10 rounded-xl p-3 text-white focus:border-emerald-500 outline-none">
                                <option value="science">Science</option>
                                <option value="commerce">Commerce</option>
                                <option value="arts">Arts</option>
                                <option value="technology">Technology</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="url" id="p-link" placeholder="Paper PDF Link" class="bg-black/20 border border-white/10 rounded-xl p-3 text-white focus:border-emerald-500 outline-none">
                            <input type="url" id="m-link" placeholder="Marking Scheme Link" class="bg-black/20 border border-white/10 rounded-xl p-3 text-white focus:border-emerald-500 outline-none">
                        </div>
                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold transition-all">Submit Resource</button>
                    </form>
                </div>

                <div class="mb-6 flex gap-4">
                    <input type="text" id="paper-search" placeholder="Search papers..." class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white focus:border-emerald-500 outline-none" oninput="renderPapers()">
                    <select id="stream-filter" class="bg-black/20 border border-white/10 rounded-xl p-3 text-white outline-none" onchange="renderPapers()">
                        <option value="all">All Streams</option>
                        <option value="science">Science</option>
                        <option value="commerce">Commerce</option>
                        <option value="arts">Arts</option>
                        <option value="technology">Technology</option>
                    </select>
                </div>

                <div id="papers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </section>

            <!-- 4. TIMETABLES (Super Admin Only) -->
            <section id="timetables-section" class="admin-section hidden animate__animated animate__fadeIn">
                <h1 class="text-2xl font-bold text-white mb-8">Schedules & Events</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass p-6 rounded-2xl">
                        <h3 class="font-bold text-white mb-4">Main Timetable PDF</h3>
                        <div class="space-y-4">
                            <input type="text" id="tt-year" placeholder="Year Title (e.g. 2025 A/L)" class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white outline-none">
                            <input type="url" id="tt-link" placeholder="PDF URL" class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white outline-none">
                            <button onclick="saveTimetable()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold">Update Timetable</button>
                        </div>
                    </div>
                    <div class="glass p-6 rounded-2xl">
                         <h3 class="font-bold text-white mb-4">Add Important Date</h3>
                         <form onsubmit="addEvent(event)" class="space-y-4">
                            <input type="date" id="ev-date" class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white outline-none" required>
                            <input type="text" id="ev-detail" placeholder="Event Name" class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white outline-none" required>
                            <select id="ev-type" class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white outline-none">
                                <option value="Exam">Exam</option>
                                <option value="Holiday">Holiday</option>
                            </select>
                            <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold">Add Event</button>
                         </form>
                         <div id="events-list" class="mt-4 max-h-40 overflow-y-auto space-y-2 custom-scrollbar"></div>
                    </div>
                </div>
            </section>

            <!-- 5. NOTICES (Super Admin Only) -->
            <section id="notices-section" class="admin-section hidden animate__animated animate__fadeIn">
                <h1 class="text-2xl font-bold text-white mb-8">System Alerts & Notices</h1>
                <div class="glass p-6 rounded-2xl mb-8">
                    <h3 class="font-bold text-white mb-4">Post New Notice</h3>
                    <form onsubmit="postNotice(event)" class="space-y-4">
                        <div class="flex gap-4">
                            <input type="text" id="n-title" placeholder="Title" class="flex-1 bg-black/20 border border-white/10 rounded-xl p-3 text-white outline-none" required>
                            <select id="n-type" class="bg-black/20 border border-white/10 rounded-xl p-3 text-white outline-none">
                                <option value="normal">Normal</option>
                                <option value="important">Important</option>
                                <option value="opportunity">Opportunity</option>
                            </select>
                        </div>
                        <textarea id="n-body" rows="3" placeholder="Message content..." class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white outline-none" required></textarea>
                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold">Publish Notice</button>
                    </form>
                </div>
                <div id="notices-list" class="grid gap-4"></div>
            </section>

            <!-- 6. SETTINGS (Super Admin Only) -->
            <section id="settings-section" class="admin-section hidden animate__animated animate__fadeIn">
                <h1 class="text-2xl font-bold text-white mb-8">System Configuration</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Maintenance -->
                    <div class="glass p-6 rounded-2xl border-l-4 border-red-500">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-white">Maintenance Mode</h3>
                            <button onclick="toggleMaintenance()" id="maint-btn" class="px-4 py-2 rounded-lg text-xs font-bold bg-gray-700 text-white">Checking...</button>
                        </div>
                        <p class="text-xs text-gray-400 mb-4">Redirects all traffic to the maintenance page.</p>
                        <input type="datetime-local" id="maint-end" class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white text-sm mb-2">
                        <button onclick="saveMaintenance()" class="w-full bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg font-bold text-sm">Update Settings</button>
                    </div>

                    <!-- Homepage Alert -->
                    <div class="glass p-6 rounded-2xl border-l-4 border-yellow-500">
                        <h3 class="font-bold text-white mb-4">Homepage Alert Bar</h3>
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="alert-active" class="accent-yellow-500 w-4 h-4">
                                <label for="alert-active" class="text-sm text-white">Show Alert</label>
                            </div>
                            <input type="text" id="alert-msg" placeholder="Alert Message" class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white text-sm outline-none">
                            <button onclick="saveAlert()" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white py-2 rounded-lg font-bold text-sm">Save Alert</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- 7. USERS (Super Admin Only) -->
            <section id="users-section" class="admin-section hidden animate__animated animate__fadeIn">
                 <h1 class="text-2xl font-bold text-white mb-8">User Approvals</h1>
                 <div class="glass rounded-2xl overflow-hidden">
                     <table class="w-full text-left text-sm text-gray-400">
                         <thead class="bg-white/5 text-xs text-gray-500 uppercase">
                             <tr><th class="p-4">Name</th><th class="p-4">Email</th><th class="p-4 text-right">Action</th></tr>
                         </thead>
                         <tbody id="users-list" class="divide-y divide-white/5"></tbody>
                     </table>
                 </div>
            </section>

        </main>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-[200] space-y-2 pointer-events-none"></div>

    <script type="module">
        // --- CONFIG ---
        const SUPER_ADMIN_EMAIL = 'isaradilnuka2005@gmail.com';
        const ADMIN_SECRET = '20050616';
        const GEMINI_API_KEY = 'AIzaSyC_qXa2pFqvF7Lt56d8q4_OtH5K5WivaJI'; // INSERT YOUR KEY HERE

        const supabaseUrl = 'https://hppojrbfhzttzvlvovre.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcG9qcmJmaHp0dHp2bHZvdnJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODgxNDYsImV4cCI6MjA3Njc2NDE0Nn0.aL2fegb_eRPY0E7P6Mwufhq3TCAeX8-hDCHBo9VeAsA';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let stream = null;
        let detectionInterval = null;
        let allPapers = [];
        let chatHistory = [];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadModels();
        });

        async function loadModels() {
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                document.getElementById('loader-view').style.display = 'none';
                document.getElementById('loginModal').classList.remove('opacity-0', 'pointer-events-none');
            } catch (error) { console.error(error); alert("Face API Failed"); }
        }

        // --- VIEW SWITCHING ---
        window.switchView = (view) => {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-secret').classList.add('hidden');
            document.getElementById(`view-${view}`).classList.remove('hidden');
        };

        // --- AUTHENTICATION ---
        window.verifySecret = () => {
             const input = document.getElementById('admin-secret-input').value;
             if(input === ADMIN_SECRET) {
                 // Mock Super Admin Object
                 const superUser = { email: SUPER_ADMIN_EMAIL, name: 'Isara Dilnuka', approved: true };
                 completeLogin(superUser);
             } else {
                 showToast('Invalid Secret Key', 'error');
             }
        };

        document.getElementById('login-btn').onclick = async () => {
            const email = document.getElementById('login-email').value;
            if(!email) return showToast("Enter Email", 'error');
            
            const { data: user } = await supabase.from('users').select('*').eq('email', email).single();
            if(!user) return showToast("User Not Found", 'error');
            if(!user.approved && user.email !== SUPER_ADMIN_EMAIL) return showToast("Account Pending Approval", 'error');
            
            startCamera(user);
        };

        async function startCamera(user) {
            document.getElementById('camera-modal').classList.remove('hidden');
            stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            const video = document.getElementById('video-feed');
            video.srcObject = stream;
            
            const descriptors = user.face_descriptors.map(d => new Float32Array(d));
            const matcher = new faceapi.FaceMatcher(new faceapi.LabeledFaceDescriptors(user.email, descriptors), 0.5);

            video.onloadedmetadata = () => {
                const canvas = document.getElementById('face-canvas');
                faceapi.matchDimensions(canvas, {width: video.videoWidth, height: video.videoHeight});
                detectionInterval = setInterval(async () => {
                    const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    if(det) {
                        const match = matcher.findBestMatch(det.descriptor);
                        if(match.label === user.email) {
                            stopCamera();
                            completeLogin(user);
                        }
                    }
                }, 500);
            };
        }

        window.stopCamera = () => {
            if(stream) stream.getTracks().forEach(t => t.stop());
            clearInterval(detectionInterval);
            document.getElementById('camera-modal').classList.add('hidden');
        };

        function completeLogin(user) {
            currentUser = user;
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            document.getElementById('user-name-display').textContent = user.name;
            const isSuper = user.email === SUPER_ADMIN_EMAIL;
            
            document.getElementById('role-badge').textContent = isSuper ? "Super Admin" : "Editor";
            document.getElementById('role-badge').className = isSuper ? "text-[10px] bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded font-bold uppercase tracking-wider" : "text-[10px] bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded font-bold uppercase tracking-wider";
            document.getElementById('user-avatar').src = isSuper ? "https://dilnuka13.github.io/my/isara-profile.jpg" : `https://ui-avatars.com/api/?name=${user.name}&background=random`;

            // Access Control
            if(isSuper) {
                document.getElementById('super-admin-links').classList.remove('hidden');
                loadDashboardStats();
                showSection('dashboard');
            } else {
                showSection('papers');
            }
        }

        // --- NAVIGATION ---
        window.showSection = (id) => {
            document.querySelectorAll('.admin-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id+'-section').classList.remove('hidden');
            
            // Highlight Nav
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-white', 'bg-white/10');
                btn.classList.add('text-gray-400');
            });
            const navBtn = document.getElementById('nav-'+id);
            if(navBtn) {
                navBtn.classList.add('text-white', 'bg-white/10');
                navBtn.classList.remove('text-gray-400');
            }

            // Load Data based on section
            if(id === 'papers') loadPapers();
            if(id === 'users' && currentUser.email === SUPER_ADMIN_EMAIL) loadUsers();
            if(id === 'settings' && currentUser.email === SUPER_ADMIN_EMAIL) loadSettings();
            if(id === 'timetables' && currentUser.email === SUPER_ADMIN_EMAIL) loadTimetables();
            if(id === 'notices' && currentUser.email === SUPER_ADMIN_EMAIL) loadNotices();
            
            // Mobile Sidebar Close
            if(window.innerWidth < 1024) document.getElementById('admin-sidebar').classList.add('-translate-x-full');
        };

        // --- AI CHAT LOGIC ---
        window.sendChat = async () => {
            if(currentUser.email !== SUPER_ADMIN_EMAIL) return;
            
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;

            addMessage('user', msg);
            input.value = '';
            
            const thinkingId = addThinking();

            try {
                // Check for Image Generation
                if(msg.toLowerCase().includes('generate image') || msg.toLowerCase().includes('create photo')) {
                    const imgPrompt = msg.replace(/generate image|create photo/i, '').trim();
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ instances: [{ prompt: imgPrompt }], parameters: { sampleCount: 1 } })
                    });
                    const data = await response.json();
                    removeThinking(thinkingId);
                    if(data.predictions) {
                        const imgUrl = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                        addMessage('ai', `<img src="${imgUrl}" class="rounded-xl border border-white/10 w-full max-w-sm" alt="AI Generated"><br>Here is your generated image.`);
                    } else {
                        addMessage('ai', "Sorry, I couldn't generate that image.");
                    }
                } else {
                    // Text/Code Generation
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: msg }] }]
                        })
                    });
                    const data = await response.json();
                    removeThinking(thinkingId);
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error processing request.";
                    addMessage('ai', aiText);
                }
            } catch(e) {
                removeThinking(thinkingId);
                addMessage('ai', "Connection Error: " + e.message);
            }
        };

        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex gap-3 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            const avatar = role === 'user' 
                ? `<img src="${document.getElementById('user-avatar').src}" class="w-8 h-8 rounded-full border border-white/10">`
                : `<div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 border border-emerald-500/30"><i class="fas fa-sparkles text-xs"></i></div>`;
            
            // Markdown parsing with Marked
            let content = text;
            if(role === 'ai') {
                content = marked.parse(text);
            }

            div.innerHTML = `
                ${avatar}
                <div class="${role === 'user' ? 'bg-emerald-600 text-white' : 'glass text-gray-200'} p-4 rounded-2xl max-w-[80%] text-sm prose prose-invert">
                    ${content}
                </div>
            `;
            
            document.getElementById('chat-messages').appendChild(div);
            
            // Highlight Code Blocks & Add Buttons
            if(role === 'ai') {
                 div.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                    // Add Copy/Run Header
                    const pre = block.parentElement;
                    const header = document.createElement('div');
                    header.className = "flex justify-between items-center bg-black/40 px-3 py-1 text-xs text-gray-400 rounded-t-md border-b border-white/5";
                    
                    const copyBtn = document.createElement('button');
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                    copyBtn.className = "hover:text-white";
                    copyBtn.onclick = () => { navigator.clipboard.writeText(block.innerText); showToast('Code Copied', 'success'); };

                    const lang = block.className.replace('language-', '');
                    header.innerHTML = `<span>${lang}</span>`;
                    header.appendChild(copyBtn);

                    if(lang === 'html') {
                        const runBtn = document.createElement('button');
                        runBtn.innerHTML = '<i class="fas fa-play"></i> Run';
                        runBtn.className = "ml-3 hover:text-emerald-400";
                        runBtn.onclick = () => { 
                            const win = window.open("", "_blank");
                            win.document.write(block.innerText);
                        };
                        header.appendChild(runBtn);
                    }

                    pre.insertBefore(header, block);
                    pre.classList.add('p-0', 'overflow-hidden');
                    block.classList.add('p-4', 'block', 'overflow-x-auto');
                 });
            }

            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        }

        function addThinking() {
            const id = 'thinking-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-3";
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400"><i class="fas fa-sparkles text-xs animate-spin"></i></div>
                <div class="glass p-3 rounded-2xl text-xs text-gray-400 flex items-center gap-2">
                    Thinking<span class="animate-pulse">...</span>
                </div>
            `;
            document.getElementById('chat-messages').appendChild(div);
            return id;
        }

        function removeThinking(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        window.clearChat = () => document.getElementById('chat-messages').innerHTML = '';
        
        window.handleFileUpload = async (input) => {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                const text = await file.text();
                addMessage('user', `[Uploaded File: ${file.name}]\n\`\`\`\n${text.substring(0, 500)}...\n\`\`\``);
                // In a real scenario, you'd send this content to context
                document.getElementById('chat-input').value = `Analyze the uploaded file content: \n ${text.substring(0, 1000)}`;
            }
        }


        // --- DASHBOARD STATS ---
        async function loadDashboardStats() {
            // Fetch Counts
            const { count: pCount } = await supabase.from('past_papers').select('*', { count: 'exact', head: true });
            const { count: nCount } = await supabase.from('notices').select('*', { count: 'exact', head: true });
            const { data: stats } = await supabase.from('subject_download_stats').select('*');

            document.getElementById('count-papers').textContent = pCount || 0;
            document.getElementById('count-notices').textContent = nCount || 0;
            
            const pDl = stats?.reduce((acc, curr) => acc + (curr.paper_downloads || 0), 0) || 0;
            const mDl = stats?.reduce((acc, curr) => acc + (curr.marking_downloads || 0), 0) || 0;
            
            document.getElementById('count-paper-dl').textContent = pDl;
            document.getElementById('count-marking-dl').textContent = mDl;

            // Table
            const tbody = document.getElementById('stats-body');
            tbody.innerHTML = '';
            if(stats) {
                stats.sort((a,b) => (b.paper_downloads + b.marking_downloads) - (a.paper_downloads + a.marking_downloads));
                stats.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 transition-colors";
                    tr.innerHTML = `<td class="p-3 text-white">${s.subject_name}</td><td class="p-3 text-right text-blue-400">${s.paper_downloads}</td><td class="p-3 text-right text-purple-400">${s.marking_downloads}</td>`;
                    tbody.appendChild(tr);
                });
            }
        }

        // --- PAPERS (Common) ---
        window.handlePaperUpload = async (e) => {
            e.preventDefault();
            const { error } = await supabase.from('past_papers').insert({
                subject_name: document.getElementById('p-subject').value,
                subject_code: document.getElementById('p-code').value,
                year: document.getElementById('p-year').value,
                stream: document.getElementById('p-stream').value,
                paper_link: document.getElementById('p-link').value,
                marking_scheme_link: document.getElementById('m-link').value
            });
            if(error) showToast("Error Uploading", 'error');
            else { showToast("Paper Uploaded", 'success'); loadPapers(); document.getElementById('paper-form').classList.add('hidden'); }
        };

        async function loadPapers() {
            const { data } = await supabase.from('past_papers').select('*').order('created_at', {ascending:false});
            allPapers = data || [];
            renderPapers();
        }

        window.renderPapers = () => {
            const search = document.getElementById('paper-search').value.toLowerCase();
            const stream = document.getElementById('stream-filter').value;
            const list = document.getElementById('papers-list');
            list.innerHTML = '';

            const filtered = allPapers.filter(p => 
                (stream === 'all' || p.stream === stream) &&
                (p.subject_name.toLowerCase().includes(search))
            );

            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = "glass p-4 rounded-xl border border-white/5 hover:border-emerald-500/30 transition-all group";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] uppercase font-bold bg-white/10 px-2 py-1 rounded text-gray-400">${p.stream}</span>
                        <button onclick="deletePaper('${p.id}')" class="text-gray-500 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                    <h4 class="font-bold text-white">${p.subject_name}</h4>
                    <p class="text-xs text-gray-400 mb-3">${p.year} • ${p.subject_code || 'No Code'}</p>
                    <div class="flex gap-2 text-xs">
                        ${p.paper_link ? `<a href="${p.paper_link}" target="_blank" class="text-blue-400 hover:underline">Paper</a>` : ''}
                        ${p.marking_scheme_link ? `<a href="${p.marking_scheme_link}" target="_blank" class="text-emerald-400 hover:underline">Marking</a>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
        };
        
        window.deletePaper = async (id) => {
            if(confirm('Delete this paper?')) {
                await supabase.from('past_papers').delete().eq('id', id);
                loadPapers();
            }
        };

        // --- SUPER ADMIN FUNCTIONS ---
        // Settings
        async function loadSettings() {
             const { data: maint } = await supabase.from('system_settings').select('value').eq('key', 'maintenance').single();
             if(maint) {
                 const btn = document.getElementById('maint-btn');
                 btn.textContent = maint.value.isActive ? 'Active' : 'Inactive';
                 btn.className = `px-4 py-2 rounded-lg text-xs font-bold ${maint.value.isActive ? 'bg-red-500 text-white' : 'bg-gray-700 text-gray-300'}`;
                 document.getElementById('maint-end').value = maint.value.endTime || '';
             }
        }
        
        window.toggleMaintenance = async () => {
             const btn = document.getElementById('maint-btn');
             const isActive = btn.textContent === 'Inactive';
             btn.textContent = isActive ? 'Active' : 'Inactive';
             btn.className = `px-4 py-2 rounded-lg text-xs font-bold ${isActive ? 'bg-red-500 text-white' : 'bg-gray-700 text-gray-300'}`;
        };

        window.saveMaintenance = async () => {
            const isActive = document.getElementById('maint-btn').textContent === 'Active';
            await supabase.from('system_settings').upsert({
                key: 'maintenance',
                value: { isActive, endTime: document.getElementById('maint-end').value }
            });
            showToast('Maintenance Updated', 'success');
        };

        window.saveAlert = async () => {
             await supabase.from('system_settings').upsert({
                key: 'system_update',
                value: { 
                    active: document.getElementById('alert-active').checked,
                    message: document.getElementById('alert-msg').value,
                    date: new Date().toISOString()
                }
            });
            showToast('Alert Saved', 'success');
        };

        // Users
        async function loadUsers() {
            const { data } = await supabase.from('users').select('*').eq('approved', false);
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = '';
            if(!data || data.length === 0) tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">No pending approvals</td></tr>';
            data.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="p-4 text-white">${u.name}</td><td class="p-4 text-gray-400">${u.email}</td><td class="p-4 text-right"><button onclick="approveUser('${u.id}')" class="text-emerald-400 hover:text-white font-bold">Approve</button></td>`;
                tbody.appendChild(tr);
            });
        }
        window.approveUser = async(id) => { await supabase.from('users').update({approved:true}).eq('id', id); loadUsers(); showToast('User Approved', 'success'); };

        // Timetables
        window.saveTimetable = async () => {
             await supabase.from('system_settings').upsert({
                key: 'timetable_pdf',
                value: { year: document.getElementById('tt-year').value, link: document.getElementById('tt-link').value }
            });
            showToast('Timetable Saved', 'success');
        };

        async function loadTimetables() {
            const { data } = await supabase.from('exam_dates').select('*');
            const list = document.getElementById('events-list');
            list.innerHTML = '';
            data?.forEach(d => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-black/20 p-2 rounded-lg";
                div.innerHTML = `<span class="text-xs text-white">${d.date}: ${d.details}</span> <button onclick="delEvent('${d.id}')" class="text-red-500"><i class="fas fa-times"></i></button>`;
                list.appendChild(div);
            });
        }
        window.addEvent = async (e) => {
            e.preventDefault();
            await supabase.from('exam_dates').insert({
                date: document.getElementById('ev-date').value,
                details: document.getElementById('ev-detail').value,
                type: document.getElementById('ev-type').value
            });
            loadTimetables();
        };
        window.delEvent = async (id) => { await supabase.from('exam_dates').delete().eq('id', id); loadTimetables(); };

        // Notices
        async function loadNotices() {
            const { data } = await supabase.from('notices').select('*').order('created_at', {ascending:false});
            const list = document.getElementById('notices-list');
            list.innerHTML = '';
            data?.forEach(n => {
                const div = document.createElement('div');
                div.className = "glass p-4 rounded-xl border-l-2 border-white/20 relative";
                div.innerHTML = `<h4 class="font-bold text-white">${n.title}</h4><p class="text-sm text-gray-400">${n.body}</p><button onclick="delNotice('${n.id}')" class="absolute top-2 right-2 text-red-500 text-xs hover:text-white">Delete</button>`;
                list.appendChild(div);
            });
        }
        window.postNotice = async (e) => {
            e.preventDefault();
            await supabase.from('notices').insert({
                title: document.getElementById('n-title').value,
                type: document.getElementById('n-type').value,
                body: document.getElementById('n-body').value
            });
            loadNotices();
            showToast('Notice Published', 'success');
        };
        window.delNotice = async (id) => { await supabase.from('notices').delete().eq('id', id); loadNotices(); };

        // Utils
        function showToast(msg, type='info') {
            const t = document.createElement('div');
            const color = type === 'error' ? 'bg-red-500' : 'bg-emerald-600';
            t.className = `${color} text-white px-6 py-3 rounded-xl shadow-2xl text-sm font-bold animate__animated animate__slideInRight`;
            t.innerHTML = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>