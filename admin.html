<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Past Papers Management - DE Education</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Define custom styles for smooth transitions and dark mode default */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Default Light Mode Background */
            transition: background-color 0.3s ease-in-out;
        }
        body.dark {
            background-color: #1f2937; /* Dark Mode Background (slate-800) */
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .tab-active {
            background-color: #059669; /* emerald-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Custom section transition classes */
        .section-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .section-hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            position: absolute; /* To prevent shifting layout */
            width: 100%;
            visibility: hidden;
        }
        .section-visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            position: relative;
            visibility: visible;
        }
        /* Paper item list animation */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .paper-item {
            animation: fadeInUp 0.4s ease-out backwards;
        }
    </style>
</head>
<body class="min-h-screen p-6 text-gray-800 dark:text-gray-200">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-70 dark:bg-opacity-80 flex items-center justify-center z-50 transition-opacity duration-300 opacity-100">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-md w-full transition-colors duration-300">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-emerald-800 dark:text-emerald-400">Admin Login</h2>
                <p class="text-gray-600 dark:text-gray-400">Enter your credentials to access the system</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="email" class="block text-gray-700 dark:text-gray-300 mb-2">Email</label>
                    <input type="email" id="email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <div>
                    <label for="password" class="block text-gray-700 dark:text-gray-300 mb-2">Password</label>
                    <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-[1.01]">
                    Login
                </button>
            </form>
            <p id="loginError" class="text-red-500 text-center mt-4 hidden">Invalid email or password</p>
        </div>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div id="mainContent" class="hidden">
        <div class="max-w-6xl mx-auto">
            <header class="text-center mb-8 flex justify-between items-center">
                <!-- Title Block -->
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-emerald-600 rounded-lg flex items-center justify-center text-white font-bold text-xl mr-3 shadow-lg">
                        DE
                    </div>
                    <h1 class="text-3xl font-bold text-emerald-800 dark:text-emerald-400 text-left">Education.lk Papers Management System</h1>
                </div>
                <!-- Dark Mode Toggle Button -->
                <button id="darkModeToggle" class="p-3 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 transition-colors shadow-md hover:shadow-lg transform hover:scale-105">
                    <i class="fas fa-sun" id="toggleIcon"></i>
                </button>
            </header>

            <!-- Tabs -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-1 mb-6 transition-colors duration-300">
                <div class="flex">
                    <button id="dataEntryTab" class="flex-1 py-3 px-4 rounded-lg font-medium transition-all duration-300 tab-active">
                        Data Entry
                    </button>
                    <button id="dataEditTab" class="flex-1 py-3 px-4 rounded-lg font-medium transition-all duration-300 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                        Data Management
                    </button>
                </div>
            </div>

            <div class="relative min-h-[400px]">
                <!-- Data Entry Section -->
                <div id="dataEntrySection" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6 section-transition section-visible">
                    <h2 class="text-xl font-semibold text-emerald-800 dark:text-emerald-400 mb-4" id="formTitle">Add New Past Paper</h2>
                    
                    <form id="paperForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="stream" class="block text-gray-700 dark:text-gray-300 mb-2">Stream</label>
                                <select id="stream" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                                    <option value="">Select</option>
                                    <option value="science">Science</option>
                                    <option value="commerce">Commerce</option>
                                    <option value="arts">Arts</option>
                                    <option value="technology">Technology</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="subject" class="block text-gray-700 dark:text-gray-300 mb-2">Subject</label>
                                <select id="subject" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required disabled>
                                    <option value="">First select a stream</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label for="year" class="block text-gray-700 dark:text-gray-300 mb-2">Year</label>
                            <input type="number" id="year" min="2000" max="2030" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                        </div>
                        
                        <div>
                            <label for="paperLink" class="block text-gray-700 dark:text-gray-300 mb-2">Paper Link</label>
                            <input type="url" id="paperLink" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required placeholder="https://drive.google.com/file/d/...">
                        </div>
                        
                        <div>
                            <label for="markingLink" class="block text-gray-700 dark:text-gray-300 mb-2">Marking Scheme Link (Optional)</label>
                            <input type="url" id="markingLink" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="https://drive.google.com/file/d/...">
                        </div>
                        
                        <div class="flex gap-4">
                            <button type="submit" id="submitBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 flex-1 shadow-md hover:shadow-lg transform hover:scale-[1.01] flex items-center justify-center">
                                <span id="submitBtnText">Add Past Paper</span>
                                <i id="submitSpinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                            </button>
                            <button type="button" id="updateBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 flex-1 shadow-md hover:shadow-lg transform hover:scale-[1.01] hidden flex items-center justify-center">
                                <span id="updateBtnText">Update Paper</span>
                                <i id="updateSpinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                            </button>
                            <button type="button" id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors flex-1 hidden shadow-md hover:shadow-lg transform hover:scale-[1.01]">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Data Management Section -->
                <div id="dataManagementSection" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 section-transition section-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-emerald-800 dark:text-emerald-400">Existing Past Papers</h2>
                        <button onclick="loadPapers()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition-colors shadow-md transform hover:scale-105">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                    
                    <!-- NEW FILTER BLOCK -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="searchPapers" placeholder="Search papers..." class="md:col-span-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        
                        <select id="filterStream" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">All Streams</option>
                            <option value="science">Science</option>
                            <option value="commerce">Commerce</option>
                            <option value="arts">Arts</option>
                            <option value="technology">Technology</option>
                        </select>
                        
                        <!-- Dynamic Subject Filter -->
                        <select id="filterSubject" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" disabled>
                            <option value="">Select Stream First</option>
                        </select>

                        <select id="filterYear" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">All Years</option>
                        
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>  
                        <option value="2017">2017</option>
                        <option value="2016">2016</option>
                        <option value="2015">2015</option>
                        <option value="2014">2014</option>
                        <option value="2013">2013</option>
                        <option value="2012">2012</option>
                        <option value="2011">2011</option>
                        <option value="2010">2010</option>
                        </select>
                    </div>
                    
                    <div id="loadingMessage" class="text-center text-gray-500 dark:text-gray-400 py-8 hidden">
                        <i class="fas fa-circle-notch fa-spin text-3xl text-emerald-500 mb-2"></i>
                        <p>Loading papers...</p>
                    </div>
                    
                    <div id="papersList" class="space-y-4">
                        <!-- Papers list will be displayed here -->
                    </div>
                </div>
            </div> <!-- End of relative container -->

        </div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://hppojrbfhzttzvlvovre.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwcG9qcmJmaHp0dHp2bHZvdnJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODgxNDYsImV4cCI6MjA3Njc2NDE0Nn0.aL2fegb_eRPY0E7P6Mwufhq3TCAeX8-hDCHBo9VeAsA';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // DOM elements
        const body = document.body;
        const loginModal = document.getElementById('loginModal');
        const mainContent = document.getElementById('mainContent');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const dataEntryTab = document.getElementById('dataEntryTab');
        const dataEditTab = document.getElementById('dataEditTab');
        const dataEntrySection = document.getElementById('dataEntrySection');
        const dataManagementSection = document.getElementById('dataManagementSection');
        const streamSelect = document.getElementById('stream');
        const subjectSelect = document.getElementById('subject');
        const paperForm = document.getElementById('paperForm');
        const submitBtn = document.getElementById('submitBtn');
        const updateBtn = document.getElementById('updateBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const formTitle = document.getElementById('formTitle');
        const searchInput = document.getElementById('searchPapers');
        const filterStream = document.getElementById('filterStream');
        const filterSubject = document.getElementById('filterSubject'); // New Subject Filter
        const filterYear = document.getElementById('filterYear');
        const papersList = document.getElementById('papersList');
        const loadingMessage = document.getElementById('loadingMessage');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const toggleIcon = document.getElementById('toggleIcon');
        const submitSpinner = document.getElementById('submitSpinner');
        const updateSpinner = document.getElementById('updateSpinner');
        const submitBtnText = document.getElementById('submitBtnText');
        const updateBtnText = document.getElementById('updateBtnText');


        let editingPaperId = null;
        let allPapers = [];

        // Admin credentials
        const adminEmail = 'isaradilnuka2005@gmail.com';
        const adminPassword = 'AAID2005$$';


        /* --- DARK MODE LOGIC --- */
        function toggleDarkMode() {
            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                toggleIcon.classList.remove('fa-sun');
                toggleIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark');
                toggleIcon.classList.remove('fa-moon');
                toggleIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (savedTheme === 'dark') {
                body.classList.add('dark');
                toggleIcon.classList.remove('fa-moon');
                toggleIcon.classList.add('fa-sun');
            } else {
                body.classList.remove('dark');
                toggleIcon.classList.remove('fa-sun');
                toggleIcon.classList.add('fa-moon');
            }
        }

        darkModeToggle.addEventListener('click', toggleDarkMode);
        /* ----------------------- */


        // Login form submission
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (email === adminEmail && password === adminPassword) {
                // Successful login
                loginModal.classList.add('hidden', 'opacity-0');
                mainContent.classList.remove('hidden');
                // Initialize theme after login
                initTheme();
            } else {
                // Failed login
                loginError.classList.remove('hidden');
                setTimeout(() => loginError.classList.add('hidden'), 3000);
            }
        });

        /* --- TAB SWITCHING WITH ANIMATION --- */
        function switchTab(activeTab, activeSection, inactiveTab, inactiveSection) {
            // Update tabs
            activeTab.classList.add('tab-active');
            inactiveTab.classList.remove('tab-active');

            // Set up transition classes for inactive section
            inactiveSection.classList.add('section-hidden');
            inactiveSection.classList.remove('section-visible');

            // Set up transition classes for active section
            activeSection.classList.remove('section-hidden');
            activeSection.classList.add('section-visible');
        }

        dataEntryTab.addEventListener('click', function() {
            switchTab(dataEntryTab, dataEntrySection, dataEditTab, dataManagementSection);
        });

        dataEditTab.addEventListener('click', function() {
            switchTab(dataEditTab, dataManagementSection, dataEntryTab, dataEntrySection);
            loadPapers();
        });
        /* ------------------------------------- */

        // Helper function to load subjects
        async function loadSubjectsForStream(stream, targetSelect) {
            targetSelect.innerHTML = '<option value="">Loading...</option>';
            targetSelect.disabled = true;

            if (!stream) {
                targetSelect.innerHTML = targetSelect.id === 'subject' ? 
                    '<option value="">First select a stream</option>' : 
                    '<option value="">All Subjects (Select Stream First)</option>';
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('subjects')
                    .select('*')
                    .eq('stream', stream)
                    .order('name');
                
                if (error) throw error;
                
                targetSelect.innerHTML = targetSelect.id === 'subject' ? 
                    '<option value="">Select subject</option>' :
                    '<option value="">All Subjects</option>';
                    
                data.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.code;
                    option.textContent = subject.name;
                    targetSelect.appendChild(option);
                });
                
                targetSelect.disabled = false;
            } catch (error) {
                console.error('Error fetching subjects:', error);
                targetSelect.innerHTML = '<option value="">Error loading subjects</option>';
            }
        }

        // Data Entry Stream change event
        streamSelect.addEventListener('change', function() {
            loadSubjectsForStream(this.value, subjectSelect);
        });

        /* --- DATA MANAGEMENT FILTERS (NEW) --- */
        filterStream.addEventListener('change', function() {
            // 1. Load papers based on new stream filter
            loadPapers();
            // 2. Load subjects into the subject filter dropdown
            loadSubjectsForStream(this.value, filterSubject);
        });

        filterSubject.addEventListener('change', function() {
            // Reload papers based on the new subject filter
            loadPapers();
        });
        /* -------------------------------------- */


        // Load papers (Refactored to handle new filterSubject)
        async function loadPapers() {
            loadingMessage.classList.remove('hidden');
            papersList.innerHTML = '';
            
            try {
                let query = supabase
                    .from('past_papers')
                    .select('*')
                    .order('year', { ascending: false });
                
                // Filter by stream
                if (filterStream.value) {
                    query = query.eq('stream', filterStream.value);
                }
                
                // Filter by year
                if (filterYear.value) {
                    query = query.eq('year', parseInt(filterYear.value));
                }

                // Filter by subject
                if (filterSubject.value) {
                    query = query.eq('subject_code', filterSubject.value);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                allPapers = data || [];
                // Client-side search and display
                filterPapers();
            } catch (error) {
                console.error('Error fetching papers:', error);
                papersList.innerHTML = '<div class="text-center text-red-500 dark:text-red-400 py-4">Unable to fetch papers</div>';
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        // Display papers (with animation class)
        function displayPapers(papers) {
            papersList.innerHTML = '';
            
            if (papers.length === 0) {
                papersList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">No papers found matching criteria.</p>';
                return;
            }
            
            papers.forEach((paper, index) => {
                const paperElement = document.createElement('div');
                paperElement.className = 'paper-item border border-gray-200 dark:border-gray-700 rounded-xl p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 shadow-md';
                paperElement.style.animationDelay = `${index * 0.05}s`;
                
                // Determine appropriate delete function (using custom modal instead of confirm)
                const deleteAction = `showDeleteModal('${paper.id}')`;

                paperElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-emerald-700 dark:text-emerald-300">${paper.subject_name} - ${paper.year}</h3>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">${paper.stream} â€¢ ${paper.subject_code}</p>
                            <div class="mt-3 space-y-1">
                                <a href="${paper.paper_link}" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline block text-sm font-medium">
                                    <i class="fas fa-file-pdf w-4 text-center mr-2"></i>Paper Link
                                </a>
                                ${paper.marking_scheme_link ? 
                                    `<a href="${paper.marking_scheme_link}" target="_blank" class="text-green-600 dark:text-green-400 hover:underline block text-sm font-medium">
                                        <i class="fas fa-check-circle w-4 text-center mr-2"></i>Marking Scheme
                                    </a>` : 
                                    '<span class="text-gray-500 dark:text-gray-500 text-sm"><i class="fas fa-times-circle w-4 text-center mr-2"></i>No Marking Scheme</span>'
                                }
                            </div>
                            <p class="text-xs text-gray-400 mt-2">ID: ${paper.id.substring(0, 8)}...</p>
                        </div>
                        <div class="flex flex-col gap-2 ml-4">
                            <button onclick="editPaper('${paper.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm transition-colors shadow-sm">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="${deleteAction}" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors shadow-sm">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                papersList.appendChild(paperElement);
            });
        }

        // Form submission
        paperForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                stream: streamSelect.value,
                subject_code: subjectSelect.value,
                subject_name: subjectSelect.options[subjectSelect.selectedIndex].text,
                year: parseInt(document.getElementById('year').value),
                paper_link: document.getElementById('paperLink').value,
                marking_scheme_link: document.getElementById('markingLink').value || null
            };
            
            // Disable form and show spinner
            setFormLoading(true);
            
            try {
                if (editingPaperId) {
                    // Update
                    const { error } = await supabase
                        .from('past_papers')
                        .update(formData)
                        .eq('id', editingPaperId);
                    
                    if (error) throw error;
                    
                    showNotification('Paper updated successfully', 'success');
                    resetForm();
                } else {
                    // Add new
                    const { error } = await supabase
                        .from('past_papers')
                        .insert([formData]);
                    
                    if (error) throw error;
                    
                    showNotification('Paper added successfully', 'success');
                    resetForm();
                }
                
                // Refresh list if we are in the management view
                if (dataEditTab.classList.contains('tab-active')) {
                    loadPapers();
                }
            } catch (error) {
                console.error('Error saving paper:', error);
                showNotification('Error: ' + error.message, 'error');
            } finally {
                setFormLoading(false);
            }
        });

        // Edit paper
        window.editPaper = async function(paperId) {
            try {
                const { data, error } = await supabase
                    .from('past_papers')
                    .select('*')
                    .eq('id', paperId)
                    .single();
                
                if (error) throw error;
                
                // Fill form
                streamSelect.value = data.stream;
                
                // Load and select subjects (re-using function)
                await loadSubjectsForStream(data.stream, subjectSelect);
                subjectSelect.value = data.subject_code;
                
                document.getElementById('year').value = data.year;
                document.getElementById('paperLink').value = data.paper_link;
                document.getElementById('markingLink').value = data.marking_scheme_link || '';
                
                // Set edit mode
                editingPaperId = paperId;
                updateBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
                formTitle.textContent = 'Edit Past Paper (ID: ' + paperId.substring(0, 8) + '...)';
                
                // Switch to data entry tab
                dataEntryTab.click();
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Error editing paper:', error);
                showNotification('Unable to fetch paper details for editing.', 'error');
            }
        };

        // Delete paper
        window.deletePaper = async function(paperId) {
            try {
                const { error } = await supabase
                    .from('past_papers')
                    .delete()
                    .eq('id', paperId);
                
                if (error) throw error;
                
                showNotification('Paper deleted successfully', 'success');
                loadPapers();
            } catch (error) {
                console.error('Error deleting paper:', error);
                showNotification('Unable to delete paper.', 'error');
            }
        };

        // Reset form
        function resetForm() {
            paperForm.reset();
            subjectSelect.innerHTML = '<option value="">First select a stream</option>';
            subjectSelect.disabled = true;
            editingPaperId = null;
            updateBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            submitBtn.classList.remove('hidden');
            formTitle.textContent = 'Add New Past Paper';
        }

        // Set form loading state (with spinner)
        function setFormLoading(loading) {
            const button = editingPaperId ? updateBtn : submitBtn;
            const spinner = editingPaperId ? updateSpinner : submitSpinner;
            const textSpan = editingPaperId ? updateBtnText : submitBtnText;

            if (loading) {
                paperForm.classList.add('loading');
                button.disabled = true;
                spinner.classList.remove('hidden');
                textSpan.textContent = editingPaperId ? 'Updating...' : 'Adding...';
            } else {
                paperForm.classList.remove('loading');
                button.disabled = false;
                spinner.classList.add('hidden');
                textSpan.textContent = editingPaperId ? 'Update Paper' : 'Add Past Paper';
            }
        }

        // Cancel button
        cancelBtn.addEventListener('click', function() {
            resetForm();
        });

        // Search and filter inputs
        searchInput.addEventListener('input', function() { filterPapers(); });
        // Stream and Subject filters trigger full loadPapers() for initial fetch, but the subsequent search is handled by filterPapers
        filterStream.addEventListener('change', function() { loadSubjectsForStream(this.value, filterSubject); loadPapers(); });
        filterSubject.addEventListener('change', function() { filterPapers(); });
        filterYear.addEventListener('change', function() { filterPapers(); });
        
        // Filter papers (Client-side search and filtering)
        function filterPapers() {
            const searchTerm = searchInput.value.toLowerCase();
            const streamFilter = filterStream.value;
            const subjectFilter = filterSubject.value; // NEW
            const yearFilter = filterYear.value;
            
            let filteredPapers = allPapers;
            
            // Filter by stream (Already handled by loadPapers, but included for robustness if data is already client-side)
            if (streamFilter) {
                filteredPapers = filteredPapers.filter(paper => paper.stream === streamFilter);
            }

            // Filter by subject (NEW)
            if (subjectFilter) {
                filteredPapers = filteredPapers.filter(paper => paper.subject_code === subjectFilter);
            }
            
            // Filter by year
            if (yearFilter) {
                filteredPapers = filteredPapers.filter(paper => paper.year.toString() === yearFilter);
            }
            
            // Filter by search term
            if (searchTerm) {
                filteredPapers = filteredPapers.filter(paper => 
                    paper.subject_name.toLowerCase().includes(searchTerm) ||
                    paper.subject_code.toLowerCase().includes(searchTerm) ||
                    paper.stream.toLowerCase().includes(searchTerm) ||
                    paper.year.toString().includes(searchTerm)
                );
            }
            
            displayPapers(filteredPapers);
        }

        /* --- Custom Notification and Confirmation Modal (Replaces alert/confirm) --- */

        // Add Notification Container to Body
        const notificationContainer = document.createElement('div');
        notificationContainer.id = 'notificationContainer';
        notificationContainer.className = 'fixed top-4 right-4 z-[100] space-y-2';
        document.body.appendChild(notificationContainer);

        function showNotification(message, type = 'info') {
            const div = document.createElement('div');
            let bgColor, icon;
            
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    icon = 'fas fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    icon = 'fas fa-exclamation-triangle';
                    break;
                default:
                    bgColor = 'bg-blue-500';
                    icon = 'fas fa-info-circle';
            }

            div.className = `${bgColor} text-white p-4 rounded-lg shadow-xl transition-all duration-500 transform translate-x-full opacity-0`;
            div.innerHTML = `<div class="flex items-center"><i class="${icon} mr-2"></i><span>${message}</span></div>`;

            notificationContainer.appendChild(div);

            // Animate in
            setTimeout(() => {
                div.classList.remove('translate-x-full', 'opacity-0');
                div.classList.add('translate-x-0', 'opacity-100');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                div.classList.remove('translate-x-0', 'opacity-100');
                div.classList.add('translate-x-full', 'opacity-0');
                div.addEventListener('transitionend', () => div.remove());
            }, 4000);
        }
        
        // Add Confirmation Modal Container to Body
        const modalHtml = `
            <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-70 z-[90] flex items-center justify-center hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-sm w-full transition-all duration-300 transform scale-95 opacity-0">
                    <h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-3">Confirm Deletion</h3>
                    <p id="modalMessage" class="text-gray-700 dark:text-gray-300 mb-6">Are you sure you want to delete this paper?</p>
                    <div class="flex justify-end gap-3">
                        <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition-colors">Cancel</button>
                        <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">Delete</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const deleteModal = document.getElementById('deleteModal');
        const modalDialog = deleteModal.querySelector('div');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        let currentPaperIdToDelete = null;

        window.showDeleteModal = function(paperId) {
            currentPaperIdToDelete = paperId;
            deleteModal.classList.remove('hidden');
            // Animate in
            setTimeout(() => {
                deleteModal.style.opacity = '1';
                modalDialog.classList.remove('scale-95', 'opacity-0');
                modalDialog.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        function hideDeleteModal() {
            // Animate out
            modalDialog.classList.remove('scale-100', 'opacity-100');
            modalDialog.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                deleteModal.classList.add('hidden');
                deleteModal.style.opacity = '0';
                currentPaperIdToDelete = null;
            }, 300);
        }

        cancelDeleteBtn.addEventListener('click', hideDeleteModal);
        
        confirmDeleteBtn.addEventListener('click', function() {
            if (currentPaperIdToDelete) {
                window.deletePaper(currentPaperIdToDelete);
            }
            hideDeleteModal();
        });


        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Show login modal by default
            loginModal.classList.remove('hidden');
            initTheme();
        });
    </script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>
